{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/notifications/notification.service.spec.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/notifications/notification.service.spec.ts"],"sourcesContent":["import { NotificationService } from './notification.service';\nimport { ProfileStatus } from 'src/user/profile-status.util';\n\nconst mockGateway = () => ({\n  sendNewNotification: jest.fn(),\n  sendRead: jest.fn(),\n  sendReadAll: jest.fn(),\n});\n\nconst mockModel = () => {\n  const chain = {\n    sort: jest.fn().mockReturnThis(),\n    skip: jest.fn().mockReturnThis(),\n    limit: jest.fn().mockReturnThis(),\n    lean: jest.fn(),\n  };\n  return {\n    insertMany: jest.fn(),\n    find: jest.fn().mockReturnValue(chain),\n    countDocuments: jest.fn(),\n    findOneAndUpdate: jest.fn(),\n    updateMany: jest.fn(),\n    findOne: jest.fn(),\n  };\n};\n\nconst buildProfileStatus = (missing: string[], complete = false): ProfileStatus =>\n  ({\n    complete,\n    missing: missing as any,\n    requiredFor: {\n      general: missing as any,\n      flagshipRegistration: missing as any,\n      verification: [],\n    },\n  } as any);\n\ndescribe('NotificationService', () => {\n  it('returns empty notifications when none exist', async () => {\n    const model = mockModel();\n    model.find().lean.mockResolvedValue([]);\n    model.countDocuments.mockResolvedValue(0);\n    const gateway = mockGateway();\n    const service = new NotificationService(model as any, gateway as any);\n\n    const result = await service.listForUser('user-id', {});\n\n    expect(result.items).toEqual([]);\n    expect(result.unreadCount).toBe(0);\n    expect(model.find).toHaveBeenCalledWith({ userId: 'user-id' });\n  });\n\n  it('marks notification as read', async () => {\n    const model = mockModel();\n    const doc = {\n      _id: 'notif1',\n      title: 'Test',\n      message: 'Hello',\n      type: 'general',\n      createdAt: new Date(),\n      readAt: null,\n    };\n    model.findOneAndUpdate.mockResolvedValue({ ...doc, readAt: new Date() });\n    const gateway = mockGateway();\n    const service = new NotificationService(model as any, gateway as any);\n\n    const result = await service.markRead('user-id', 'notif1');\n\n    expect(result.id).toBe('notif1');\n    expect(gateway.sendRead).toHaveBeenCalledWith('user-id', 'notif1');\n  });\n\n  it('creates profile completion reminder with missing fields', async () => {\n    const gateway = mockGateway();\n    const createdDocs: any[] = [];\n\n    class MockNotificationModel {\n      static findOne = jest.fn().mockResolvedValue(null);\n      static updateMany = jest.fn();\n      static find = jest.fn().mockReturnValue({\n        sort: jest.fn().mockReturnThis(),\n        skip: jest.fn().mockReturnThis(),\n        limit: jest.fn().mockReturnThis(),\n        lean: jest.fn(),\n      });\n      static countDocuments = jest.fn();\n      static findOneAndUpdate = jest.fn();\n      static insertMany = jest.fn();\n      constructor(payload: any) {\n        const instance: any = {\n          ...payload,\n          _id: payload._id || 'generated-id',\n          createdAt: new Date(),\n          readAt: null,\n        };\n        instance.save = jest.fn().mockResolvedValue(instance);\n        createdDocs.push(instance);\n        return instance;\n      }\n    }\n\n    const service = new NotificationService(\n      MockNotificationModel as any,\n      gateway as any,\n    );\n\n    const status = buildProfileStatus(['phone', 'city']);\n    const result = await service.ensureProfileCompletionReminder('user-1', status);\n\n    expect(MockNotificationModel.findOne).toHaveBeenCalledWith({\n      userId: 'user-1',\n      'metadata.kind': 'profile_completion',\n    });\n    expect(createdDocs[0].message).toContain('Phone number');\n    expect(createdDocs[0].metadata.missingFields).toEqual(['phone', 'city']);\n    expect(result?.metadata?.missingFieldLabels).toContain('City');\n    expect(gateway.sendNewNotification).toHaveBeenCalledWith(\n      'user-1',\n      expect.objectContaining({ id: expect.any(String), type: 'general' }),\n    );\n  });\n\n  it('marks profile reminder as read when profile is complete', async () => {\n    const gateway = mockGateway();\n    const model = mockModel();\n    const service = new NotificationService(model as any, gateway as any);\n\n    model.updateMany.mockResolvedValue({ matchedCount: 1 });\n\n    await service.ensureProfileCompletionReminder(\n      'user-2',\n      buildProfileStatus([], true),\n    );\n\n    expect(model.updateMany).toHaveBeenCalledWith(\n      {\n        userId: 'user-2',\n        'metadata.kind': 'profile_completion',\n        readAt: null,\n      },\n      { $set: { readAt: expect.any(Date) } },\n    );\n    expect(gateway.sendNewNotification).not.toHaveBeenCalled();\n  });\n});\n"],"version":3}