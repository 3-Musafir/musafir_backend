{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/wallet/wallet.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/wallet/wallet.service.ts"],"sourcesContent":["import { BadRequestException, Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { WalletBalance, WalletTransaction } from './interfaces/wallet.interface';\nimport { User } from 'src/user/interfaces/user.interface';\nimport { WALLET_CURRENCY } from './wallet.constants';\n\nexport const WALLET_TX_IDEMPOTENT_MARKER = '__walletTxIdempotent';\n\nexport function isWalletTxIdempotent(tx: any): boolean {\n  return Boolean(tx && typeof tx === 'object' && (tx as any)[WALLET_TX_IDEMPOTENT_MARKER]);\n}\n\nfunction markWalletTxIdempotent<T>(tx: T): T {\n  if (!tx || typeof tx !== 'object') return tx;\n  if ((tx as any)[WALLET_TX_IDEMPOTENT_MARKER]) return tx;\n  try {\n    Object.defineProperty(tx as any, WALLET_TX_IDEMPOTENT_MARKER, {\n      value: true,\n      enumerable: false,\n      configurable: true,\n    });\n  } catch {\n    // Best-effort marker for downstream idempotency handling.\n  }\n  return tx;\n}\n\n@Injectable()\nexport class WalletService {\n  constructor(\n    @InjectModel('WalletBalance')\n    private readonly walletBalanceModel: Model<WalletBalance>,\n    @InjectModel('WalletTransaction')\n    private readonly walletTransactionModel: Model<WalletTransaction>,\n    @InjectModel('User')\n    private readonly userModel: Model<User>,\n  ) {}\n\n  async getBalance(userId: string): Promise<{ balance: number }> {\n    const doc = await this.walletBalanceModel\n      .findOne({ userId })\n      .select('balance')\n      .lean()\n      .exec();\n    return { balance: doc?.balance ?? 0 };\n  }\n\n  async listTransactions(\n    userId: string,\n    options?: { limit?: number; page?: number; cursor?: string; type?: string },\n  ) {\n    const limit = Math.max(1, Math.min(100, Number(options?.limit) || 20));\n    const page = options?.page ? Math.max(1, Number(options.page)) : undefined;\n    const cursor = options?.cursor;\n    const type = options?.type;\n\n    const filter: any = { userId };\n    if (type) filter.type = type;\n\n    // Prefer keyset pagination for performance.\n    if (cursor) {\n      filter._id = { $lt: cursor };\n      const transactions = await this.walletTransactionModel\n        .find(filter)\n        .sort({ _id: -1 })\n        .limit(limit + 1)\n        .lean()\n        .exec();\n\n      const hasMore = transactions.length > limit;\n      if (hasMore) transactions.pop();\n\n      return {\n        transactions,\n        nextCursor: hasMore\n          ? transactions[transactions.length - 1]?._id?.toString()\n          : null,\n      };\n    }\n\n    const skip = page ? (page - 1) * limit : 0;\n    const transactions = await this.walletTransactionModel\n      .find(filter)\n      .sort({ createdAt: -1 })\n      .skip(skip)\n      .limit(limit)\n      .lean()\n      .exec();\n\n    return { transactions, page: page || 1, limit };\n  }\n\n  async credit(params: {\n    userId: string;\n    amount: number;\n    type: string;\n    sourceId: string;\n    sourceType?: string;\n    expiresAt?: Date;\n    postedBy?: string;\n    note?: string;\n    metadata?: Record<string, any>;\n  }) {\n    return this.applyTransaction({ ...params, direction: 'credit' as const });\n  }\n\n  async debit(params: {\n    userId: string;\n    amount: number;\n    type: string;\n    sourceId: string;\n    sourceType?: string;\n    postedBy?: string;\n    note?: string;\n    metadata?: Record<string, any>;\n  }) {\n    return this.applyTransaction({ ...params, direction: 'debit' as const });\n  }\n\n  async voidBySource(params: {\n    type: string;\n    sourceId: string;\n    voidedBy?: string;\n    note?: string;\n  }) {\n    const tx: any = await this.walletTransactionModel\n      .findOne({ type: params.type, 'metadata.sourceId': params.sourceId })\n      .exec();\n    if (!tx) {\n      throw new BadRequestException({\n        message: 'Wallet transaction not found.',\n        code: 'wallet_tx_not_found',\n      });\n    }\n    if (tx.status === 'void') return tx.toObject();\n\n    const amount = Number(tx.amount) || 0;\n    const delta = tx.direction === 'credit' ? amount : -amount;\n    const reverseDelta = -delta;\n\n    if (reverseDelta < 0) {\n      const updated = await this.walletBalanceModel.findOneAndUpdate(\n        { userId: tx.userId, balance: { $gte: Math.abs(reverseDelta) } },\n        { $inc: { balance: reverseDelta }, $set: { updatedAt: new Date() } },\n        { new: true },\n      );\n      if (!updated) {\n        throw new BadRequestException({\n          message: 'Cannot void transaction due to insufficient wallet balance.',\n          code: 'wallet_void_insufficient_balance',\n        });\n      }\n    } else {\n      await this.walletBalanceModel.findOneAndUpdate(\n        { userId: tx.userId },\n        {\n          $inc: { balance: reverseDelta },\n          $set: { updatedAt: new Date() },\n          $setOnInsert: { userId: tx.userId, balance: 0 },\n        },\n        { upsert: true },\n      );\n    }\n\n    tx.status = 'void';\n    tx.note = params.note || tx.note;\n    tx.metadata = {\n      ...(tx.metadata || {}),\n      voidedAt: new Date().toISOString(),\n      voidedBy: params.voidedBy,\n    };\n    await tx.save();\n    return tx.toObject();\n  }\n\n  private async applyTransaction(params: {\n    userId: string;\n    amount: number;\n    direction: 'credit' | 'debit';\n    type: string;\n    sourceId: string;\n    sourceType?: string;\n    expiresAt?: Date;\n    postedBy?: string;\n    note?: string;\n    metadata?: Record<string, any>;\n  }) {\n    const amount = Math.floor(Number(params.amount));\n    if (!Number.isFinite(amount) || amount <= 0) {\n      throw new BadRequestException({\n        message: 'Invalid wallet amount.',\n        code: 'wallet_invalid_amount',\n      });\n    }\n\n    const existing = await this.walletTransactionModel\n      .findOne({ type: params.type, 'metadata.sourceId': params.sourceId })\n      .lean()\n      .exec();\n    if (existing) {\n      if ((existing as any)?.status === 'void') {\n        throw new BadRequestException({\n          message:\n            'This wallet operation was already processed and voided. Please retry with a new idempotency id.',\n          code: 'wallet_tx_void',\n        });\n      }\n      return markWalletTxIdempotent(existing);\n    }\n\n    const delta = params.direction === 'credit' ? amount : -amount;\n    const sourceType = params.sourceType || params.type;\n    const metadata = { ...(params.metadata || {}), sourceId: params.sourceId };\n\n    let balanceDoc: any = null;\n    if (delta > 0) {\n      balanceDoc = await this.walletBalanceModel.findOneAndUpdate(\n        { userId: params.userId },\n        {\n          $inc: { balance: delta },\n          $set: { updatedAt: new Date() },\n          $setOnInsert: { userId: params.userId, balance: 0 },\n        },\n        { upsert: true, new: true },\n      );\n    } else {\n      balanceDoc = await this.walletBalanceModel.findOneAndUpdate(\n        { userId: params.userId, balance: { $gte: amount } },\n        { $inc: { balance: delta }, $set: { updatedAt: new Date() } },\n        { new: true },\n      );\n      if (!balanceDoc) {\n        throw new BadRequestException({\n          message: 'Insufficient wallet balance.',\n          code: 'wallet_insufficient_balance',\n        });\n      }\n    }\n\n    try {\n      const tx = await this.walletTransactionModel.create({\n        userId: params.userId,\n        direction: params.direction,\n        amount,\n        type: params.type,\n        status: 'posted',\n        sourceType,\n        sourceId: params.sourceId,\n        balanceAfter: balanceDoc.balance,\n        expiresAt: params.expiresAt,\n        postedBy: params.postedBy,\n        note: params.note,\n        metadata,\n      });\n      return tx.toObject();\n    } catch (err: any) {\n      // If we raced with an identical transaction, roll back our balance delta and return existing.\n      const isDup = err?.code === 11000;\n      if (isDup) {\n        await this.walletBalanceModel.updateOne(\n          { userId: params.userId },\n          { $inc: { balance: -delta }, $set: { updatedAt: new Date() } },\n        );\n        const raced = await this.walletTransactionModel\n          .findOne({ type: params.type, 'metadata.sourceId': params.sourceId })\n          .lean()\n          .exec();\n        if (raced) return markWalletTxIdempotent(raced);\n      }\n      // Roll back on unexpected errors too.\n      await this.walletBalanceModel.updateOne(\n        { userId: params.userId },\n        { $inc: { balance: -delta }, $set: { updatedAt: new Date() } },\n      );\n      throw err;\n    }\n  }\n\n  async adminListWallets(options?: {\n    page?: number;\n    limit?: number;\n    search?: string;\n    includeEmpty?: boolean;\n  }) {\n    const limit = Math.max(1, Math.min(100, Number(options?.limit) || 20));\n    const page = Math.max(1, Number(options?.page) || 1);\n    const skip = (page - 1) * limit;\n\n    const search = options?.search?.trim();\n    const includeEmpty = Boolean(options?.includeEmpty);\n\n    // Backward-compatible default: list only existing wallet balance docs.\n    if (!includeEmpty) {\n      const filter: any = {};\n      if (search) {\n        const escaped = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n        const users = await this.userModel\n          .find({\n            roles: { $ne: 'admin' },\n            $or: [\n              { fullName: { $regex: escaped, $options: 'i' } },\n              { email: { $regex: escaped, $options: 'i' } },\n              { phone: { $regex: escaped, $options: 'i' } },\n              { referralID: { $regex: escaped, $options: 'i' } },\n            ],\n          })\n          .select('_id')\n          .limit(500)\n          .lean()\n          .exec();\n\n        const userIds = users.map((u: any) => u._id);\n        filter.userId = { $in: userIds };\n      }\n\n      const wallets = await this.walletBalanceModel\n        .find(filter)\n        .sort({ balance: -1, updatedAt: -1, _id: -1 })\n        .skip(skip)\n        .limit(limit)\n        .populate({\n          path: 'userId',\n          select: 'fullName email phone referralID verification roles gender',\n        })\n        .lean()\n        .exec();\n\n      return { wallets, page, limit };\n    }\n\n    // includeEmpty=true: page through users and attach existing balances (if any).\n    const userFilter: any = { roles: { $ne: 'admin' } };\n    if (search) {\n      const escaped = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      userFilter.$or = [\n        { fullName: { $regex: escaped, $options: 'i' } },\n        { email: { $regex: escaped, $options: 'i' } },\n        { phone: { $regex: escaped, $options: 'i' } },\n        { referralID: { $regex: escaped, $options: 'i' } },\n      ];\n    }\n\n    const [total, users] = await Promise.all([\n      this.userModel.countDocuments(userFilter).exec(),\n      this.userModel\n        .find(userFilter)\n        .sort({ _id: -1 })\n        .skip(skip)\n        .limit(limit)\n        .select('fullName email phone referralID verification roles gender')\n        .lean()\n        .exec(),\n    ]);\n\n    const userIds = users.map((u: any) => u?._id).filter(Boolean);\n    const balances = userIds.length\n      ? await this.walletBalanceModel\n          .find({ userId: { $in: userIds } })\n          .select('userId balance currency updatedAt')\n          .lean()\n          .exec()\n      : [];\n    const balanceByUserId = new Map(balances.map((b: any) => [String(b.userId), b]));\n\n    const wallets = users.map((u: any) => {\n      const balanceDoc = balanceByUserId.get(String(u._id));\n      if (balanceDoc) {\n        return { ...balanceDoc, userId: u };\n      }\n      return {\n        _id: `user:${String(u._id)}`,\n        userId: u,\n        balance: 0,\n        currency: WALLET_CURRENCY,\n        updatedAt: undefined,\n      };\n    });\n\n    const totalPages = Math.ceil(total / limit);\n    return { wallets, page, limit, total, totalPages };\n  }\n}\n"],"version":3}