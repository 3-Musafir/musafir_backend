{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/user/user.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/user/user.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  ConflictException,\n  Injectable,\n  NotFoundException,\n} from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport * as bcrypt from 'bcrypt';\nimport { ObjectId } from 'bson';\nimport { addHours } from 'date-fns';\nimport { Request } from 'express';\nimport * as jwt from 'jsonwebtoken';\nimport { Model } from 'mongoose';\nimport { generateRandomPassword, generateUniqueCode } from 'src/util';\nimport { v4 } from 'uuid';\nimport { Registration } from '../registration/interfaces/registration.interface';\nimport { StorageService } from '../storage/storageService';\nimport { AuthService } from './../auth/auth.service';\nimport { MailService } from './../mail/mail.service';\nimport { CreateForgotPasswordDto } from './dto/create-forgot-password.dto';\nimport { CreateGoogleUserDto, EmailUserDto } from './dto/create-user.dto';\nimport { LoginUserDto } from './dto/login-user.dto';\nimport { RefreshAccessTokenDto } from './dto/refresh-access-token.dto';\nimport {\n  JwtResetPasswordDto,\n  ResetPasswordDto,\n} from './dto/reset-password.dto';\nimport { VerifyUserDto } from './dto/verify-user.dto';\nimport { User, UserDocument } from './interfaces/user.interface';\nimport { VerificationStatus } from '../constants/verification-status.enum';\nimport {\n  buildProfileStatus,\n  isProfileComplete as isProfileCompleteUtil,\n} from './profile-status.util';\nimport { NotificationService } from 'src/notifications/notification.service';\nimport { WalletService } from 'src/wallet/wallet.service';\n\n@Injectable()\nexport class UserService {\n  HOURS_TO_BLOCK = 6;\n  LOGIN_ATTEMPTS_TO_BLOCK = 5;\n\n  constructor(\n    @InjectModel('User') private readonly userModel: Model<UserDocument>,\n    @InjectModel('Registration') private readonly registrationModel: Model<Registration>,\n    private readonly mailService: MailService,\n    private readonly authService: AuthService,\n    private readonly storageService: StorageService,\n    private readonly notificationService: NotificationService,\n    private readonly walletService: WalletService,\n  ) { }\n\n  private async creditSignupReferrerIfEligible(savedUser: UserDocument) {\n    const referrerId = savedUser?.referredBy?.toString?.();\n    if (!referrerId) return;\n\n    try {\n      await this.walletService.credit({\n        userId: referrerId,\n        amount: 100,\n        type: 'referral_signup_credit',\n        sourceId: savedUser._id.toString(),\n        sourceType: 'referral_signup',\n        metadata: {\n          sourceId: savedUser._id.toString(),\n          referredUserId: savedUser._id.toString(),\n        },\n      });\n\n      await this.notificationService.createForUser(referrerId, {\n        title: 'Referral bonus',\n        message: `You earned Rs.100 wallet credit because ${savedUser.fullName || 'a Musafir'} signed up using your referral code.`,\n        type: 'wallet',\n        link: '/wallet',\n        metadata: {\n          referredUserId: savedUser._id.toString(),\n          amount: 100,\n          kind: 'referral_signup_credit',\n        },\n      });\n    } catch (err) {\n      console.log('Failed to credit signup referral bonus:', err);\n    }\n  }\n\n  private async creditVerificationReferrersIfEligible(verifiedUser: UserDocument) {\n    const referralCodes = (verifiedUser as any)?.verification?.ReferralIDs;\n    if (!Array.isArray(referralCodes) || referralCodes.length === 0) return;\n\n    try {\n      const referrers = await this.userModel\n        .find({\n          referralID: { $in: referralCodes },\n          'verification.status': VerificationStatus.VERIFIED,\n          roles: { $ne: 'admin' },\n        })\n        .select('_id fullName referralID')\n        .lean()\n        .exec();\n\n      await Promise.all(\n        referrers.map(async (referrer: any) => {\n          const referrerId = referrer?._id?.toString?.();\n          if (!referrerId) return;\n          const sourceId = `${verifiedUser._id.toString()}:verification:${referrerId}`;\n\n          await this.walletService.credit({\n            userId: referrerId,\n            amount: 200,\n            type: 'referral_verification_credit',\n            sourceId,\n            sourceType: 'referral_verification',\n            metadata: {\n              sourceId,\n              verifiedUserId: verifiedUser._id.toString(),\n              referralCode: referrer.referralID,\n            },\n          });\n\n          await this.notificationService.createForUser(referrerId, {\n            title: 'Verification bonus',\n            message: `You earned Rs.200 wallet credit because ${verifiedUser.fullName || 'a Musafir'} was verified using your referral code.`,\n            type: 'wallet',\n            link: '/wallet',\n            metadata: {\n              verifiedUserId: verifiedUser._id.toString(),\n              amount: 200,\n              kind: 'referral_verification_credit',\n            },\n          });\n        }),\n      );\n    } catch (err) {\n      console.log('Failed to credit verification referral bonuses:', err);\n    }\n  }\n\n  async awardVerificationReferralCredits(userId: string) {\n    const user = await this.userModel.findById(userId).exec();\n    if (!user) return;\n    if ((user as any)?.verification?.status !== VerificationStatus.VERIFIED) return;\n    await this.creditVerificationReferrersIfEligible(user);\n  }\n\n  private isProfileComplete(user: Partial<User>) {\n    return isProfileCompleteUtil(user);\n  }\n\n  private getProfileStatus(user: Partial<User>) {\n    return buildProfileStatus(user);\n  }\n\n  private normalizeVerificationForResponse(user: any) {\n    const verification = user?.verification;\n    if (!verification || typeof verification !== 'object') return;\n\n    if (verification.VerificationID && !verification.verificationID) {\n      verification.verificationID = verification.VerificationID;\n    }\n    if (Array.isArray(verification.ReferralIDs) && !verification.referralIDs) {\n      verification.referralIDs = verification.ReferralIDs;\n    }\n    if (verification.VideoLink && !verification.videoLink) {\n      verification.videoLink = verification.VideoLink;\n    }\n    if (verification.VerificationDate && !verification.verificationDate) {\n      verification.verificationDate = verification.VerificationDate;\n    }\n    if (\n      verification.VerificationRequestDate &&\n      !verification.verificationRequestDate\n    ) {\n      verification.verificationRequestDate = verification.VerificationRequestDate;\n    }\n    if (\n      typeof verification.RequestCall !== 'undefined' &&\n      typeof verification.requestCall === 'undefined'\n    ) {\n      verification.requestCall = verification.RequestCall;\n    }\n  }\n\n  addProfileStatus(user: any) {\n    const plainUser =\n      typeof user?.toObject === 'function' ? user.toObject() : user;\n\n    this.normalizeVerificationForResponse(plainUser);\n    const profileStatus = this.getProfileStatus(plainUser);\n\n    return {\n      ...(plainUser as any),\n      profileComplete: this.isProfileComplete(plainUser),\n      profileStatus,\n    };\n  }\n\n  private ensureReferralPairValid(\n    applicant: UserDocument,\n    referral1?: string,\n    referral2?: string,\n  ) {\n    if (!referral1 || !referral2) {\n      throw new BadRequestException('Two referral codes are required.');\n    }\n    if (referral1 === referral2) {\n      throw new BadRequestException('Referral codes must be different.');\n    }\n    if (\n      applicant.referralID &&\n      (applicant.referralID === referral1 || applicant.referralID === referral2)\n    ) {\n      throw new BadRequestException('You cannot use your own referral code.');\n    }\n  }\n\n  private resolveVerifiedReferrer(referralID: string) {\n    return this.userModel.findOne({\n      referralID,\n      'verification.status': VerificationStatus.VERIFIED,\n      roles: { $ne: 'admin' },\n    });\n  }\n\n  private async applyReferralAttribution(\n    user: UserDocument,\n    referralCode?: string,\n  ) {\n    if (!referralCode) return;\n    try {\n      const referrer = await this.resolveVerifiedReferrer(referralCode);\n      if (referrer) {\n        user.referredBy = referrer._id as any;\n        user.referredCode = referralCode;\n      }\n    } catch (err) {\n      // swallow attribution errors; should not block signup\n      console.warn('Referral attribution failed', err);\n    }\n  }\n\n  // Create User\n  async create(\n    createUserDto: any,\n  ): Promise<{ userId: any; verificationId: string }> {\n    createUserDto.password = generateRandomPassword();\n    const user = new this.userModel(createUserDto);\n    await this.isEmailUnique(user.email);\n    await this.applyReferralAttribution(user as any, createUserDto.referralCode || createUserDto.ref);\n    user.referralID = generateUniqueCode();\n    user.verification.VerificationID = v4();\n    user.verification.status = VerificationStatus.UNVERIFIED;\n    const password = createUserDto.password;\n    await this.mailService.sendEmailVerification(user.email, password);\n    const savedUser = await user.save();\n    await this.creditSignupReferrerIfEligible(savedUser as any);\n    return {\n      userId: savedUser._id,\n      verificationId: (savedUser.verification as any).VerificationID,\n    };\n  }\n\n  // Create Email User\n  async createEmailUser(userDto: EmailUserDto, req: Request) {\n    let user = await this.userModel.findOne({ email: userDto.email });\n    if (!user) {\n      user = new this.userModel(userDto);\n      await this.isEmailUnique(user.email);\n      await this.applyReferralAttribution(user as any, (userDto as any).referralCode || (userDto as any).ref);\n      user.referralID = generateUniqueCode();\n      user.emailVerified = true;\n      user.verification.VerificationID = v4();\n      user.verification.status = VerificationStatus.UNVERIFIED;\n      const saved = await user.save();\n      await this.creditSignupReferrerIfEligible(saved as any);\n      user = saved as any;\n    }\n    const userWithStatus = this.addProfileStatus(user);\n    return {\n      user: userWithStatus,\n      email: userWithStatus.email,\n      accessToken: await this.authService.createAccessToken(String(user._id)),\n      refreshToken: await this.authService.createRefreshToken(req, user._id),\n    };\n  }\n\n  // Create Google Users\n  async createGoogleUser(userDto: CreateGoogleUserDto, req: Request) {\n    let user = await this.userModel.findOne({ email: userDto.email });\n    if (!user) {\n      user = new this.userModel(userDto);\n      await this.isEmailUnique(user.email);\n      await this.applyReferralAttribution(user as any, (userDto as any).referralCode || (userDto as any).ref);\n      user.referralID = generateUniqueCode();\n      user.emailVerified = true;\n      user.verification.VerificationID = v4();\n      user.verification.status = VerificationStatus.UNVERIFIED;\n      const saved = await user.save();\n      await this.creditSignupReferrerIfEligible(saved as any);\n      user = saved as any;\n    }\n    const userWithStatus = this.addProfileStatus(user);\n    return {\n      user: userWithStatus,\n      accessToken: await this.authService.createAccessToken(String(user._id)),\n      refreshToken: await this.authService.createRefreshToken(req, user._id),\n    };\n  }\n\n  // Create Google Users\n  async createToken(user: { email: string; googleId: string }, req: Request) {\n    return {\n      email: user.email,\n      accessToken: await this.authService.createAccessToken(\n        String(user.googleId),\n      ),\n    };\n  }\n\n  // Verify Email\n  async verifyEmail(req: Request, password: string, verificationId: string) {\n    const user = await this.findByVerification(verificationId);\n    await this.checkPassword(password, user);\n    await this.setUserAsVerified(user as UserDocument);\n    // Send account created notification after password is set and email is verified\n    if (user.email && password) {\n      const firstName = user.fullName?.split(' ')[0] || 'User';\n      const loginUrl = process.env.FRONTEND_URL + '/login';\n      await this.mailService.sendAccountCreatedEmail(user.email, firstName, loginUrl);\n    }\n    return {\n      fullName: user.fullName,\n      email: user.email,\n      accessToken: await this.authService.createAccessToken(String(user._id)),\n      refreshToken: await this.authService.createRefreshToken(req, user._id),\n    };\n  }\n\n  // Login\n  async login(req: Request, loginUserDto: LoginUserDto) {\n    const user = await this.findUserByEmail(loginUserDto.email);\n    await this.checkPassword(loginUserDto.password, user);\n    const userWithStatus = this.addProfileStatus(user);\n    return {\n      user: userWithStatus,\n      fullName: user.fullName,\n      email: user.email,\n      accessToken: await this.authService.createAccessToken(String(user._id)),\n      refreshToken: await this.authService.createRefreshToken(req, user._id),\n    };\n  }\n\n  // Find user by email or phone\n  async findUserByEmailOrPhone(emailOrPhone: string) {\n    const raw = (emailOrPhone || '').trim();\n    if (!raw) {\n      throw new BadRequestException('emailOrPhone is required');\n    }\n\n    const isEmail = raw.includes('@');\n    const lower = raw.toLowerCase();\n\n    const escapeRegex = (s: string) => s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n    const digitsOnly = (s: string) => s.replace(/\\D/g, '');\n\n    let user: any = null;\n\n    if (isEmail) {\n      user = await this.userModel.findOne({ email: lower });\n    } else {\n      // 1) Exact phone match first\n      user = await this.userModel.findOne({ phone: raw });\n\n      // 2) Fallback: match by last 7 digits (e.g. +923444225504 => 4225504)\n      if (!user) {\n        const digits = digitsOnly(raw);\n        if (digits.length < 7) {\n          throw new NotFoundException('User not found');\n        }\n\n        // Try the most specific suffix first (entire digits string), then last 7.\n        const suffixes = digits.length > 7 ? [digits, digits.slice(-7)] : [digits];\n\n        for (const suffix of suffixes) {\n          const re = new RegExp(`${escapeRegex(suffix)}$`);\n          const matches = await this.userModel\n            .find({ phone: { $regex: re } })\n            .limit(5)\n            .exec();\n\n          if (matches.length === 1) {\n            user = matches[0];\n            break;\n          }\n          if (matches.length > 1) {\n            throw new ConflictException(\n              'Multiple users matched this phone number. Please enter full phone number or email.',\n            );\n          }\n        }\n      }\n    }\n\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    // Check if user has password (existing user)\n    if (user.password) {\n      throw new ConflictException('Account already exists. Please login.');\n    }\n\n    // Get user's registrations to find trips\n    const registrations = await this.registrationModel.find({ userId: user._id })\n      .populate('flagshipId', 'tripName')\n      .exec();\n\n    const trips = registrations\n      .map(reg => {\n        const flagship = reg.flagshipId as any;\n        return flagship?.tripName;\n      })\n      .filter(Boolean);\n\n    return {\n      user: {\n        _id: user._id,\n        fullName: user.fullName,\n        email: user.email,\n        phone: user.phone,\n        city: user.city || 'Unknown'\n      },\n      trips\n    };\n  }\n\n  // Verify musafir email and generate password\n  async verifyMusafirEmail(email: string, updateExisting?: boolean, userId?: string) {\n    let user;\n\n    if (updateExisting && userId) {\n      // Update existing user's email\n      user = await this.userModel.findById(userId);\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      // Check if the new email is already taken by another user\n      const existingUserWithEmail = await this.userModel.findOne({\n        email: email.toLowerCase(),\n        _id: { $ne: userId } // Exclude current user\n      });\n\n      if (existingUserWithEmail) {\n        throw new ConflictException('Email is already taken by another user');\n      }\n\n      // Update the user's email\n      user.email = email.toLowerCase();\n    } else {\n      // Find existing user\n      user = await this.userModel.findOne({ email: email.toLowerCase() });\n\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      // Check if user already has password\n      if (user.password) {\n        throw new ConflictException('Account already exists. Please login.');\n      }\n    }\n\n    // Generate new password\n    const newPassword = generateRandomPassword();\n    user.password = newPassword;\n    user.emailVerified = true;\n    // Preserve existing verification status; do not auto-verify on email confirm\n    if (!user.verification?.status) {\n      user.verification = user.verification || {};\n      user.verification.status = VerificationStatus.UNVERIFIED;\n    }\n\n    await user.save();\n\n    // Send email with password\n    await this.mailService.sendEmailVerification(user.email, newPassword);\n\n    return {\n      message: 'Password sent to your email',\n      email: user.email\n    };\n  }\n\n  // Refresh Access Token\n  async refreshAccessToken(refreshAccessTokenDto: RefreshAccessTokenDto) {\n    const userId = await this.authService.findRefreshToken(\n      refreshAccessTokenDto.refreshToken,\n    );\n    const user = await this.userModel.findById(userId);\n    if (!user) {\n      throw new BadRequestException('Bad request');\n    }\n    return {\n      accessToken: await this.authService.createAccessToken(String(user._id)),\n    };\n  }\n\n  // Forget Password\n  async forgotPassword(\n    req: Request,\n    createForgotPasswordDto: CreateForgotPasswordDto,\n  ) {\n    const user = await this.findByEmail(createForgotPasswordDto.email);\n\n    // Generate JWT token with 15 minutes expiry\n    const resetToken = jwt.sign(\n      {\n        userId: user._id,\n        email: user.email,\n        type: 'password_reset',\n      },\n      process.env.JWT_SECRET,\n      { expiresIn: '15m' },\n    );\n\n    // Create reset link with frontend URL\n    const resetLink = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;\n\n    // Send email with reset link\n    await this.mailService.sendPasswordResetEmail(\n      user.email,\n      resetLink,\n      user.fullName || 'User',\n    );\n\n    return {\n      email: createForgotPasswordDto.email,\n      message: 'Password reset link sent to your email.',\n    };\n  }\n\n  async findByReferralId(refferal: string): Promise<User> {\n    const user = await this.userModel.findOne({\n      referralID: refferal,\n      'verification.status': VerificationStatus.VERIFIED,\n    });\n    if (!user) {\n      throw new BadRequestException('Bad request.');\n    }\n    return user;\n  }\n\n  async verifyWithReferrals(applicantId: string, verifyUser: VerifyUserDto) {\n    const applicant = await this.userModel.findById(applicantId);\n    if (!applicant) {\n      throw new BadRequestException('Applicant not found.');\n    }\n\n    const { referral1, referral2 } = verifyUser;\n    this.ensureReferralPairValid(applicant, referral1, referral2);\n\n    const [user1, user2] = await Promise.all([\n      this.resolveVerifiedReferrer(referral1),\n      this.resolveVerifiedReferrer(referral2),\n    ]);\n\n    if (!user1 || !user2) {\n      throw new BadRequestException(\n        'Referral codes must belong to verified users.',\n      );\n    }\n\n    if (user1._id.equals(user2._id)) {\n      throw new BadRequestException(\n        'Referral codes must come from two different users.',\n      );\n    }\n\n    if (user1._id.equals(applicant._id) || user2._id.equals(applicant._id)) {\n      throw new BadRequestException('You cannot verify yourself.');\n    }\n\n    const genders = [user1.gender, user2.gender];\n    const hasMale = genders.includes('male');\n    const hasFemale = genders.includes('female');\n    if (!hasMale || !hasFemale) {\n      throw new BadRequestException(\n        'Referral codes must include at least one male and one female verified Musafir.',\n      );\n    }\n\n    const saved = await this.setUserVerified(applicantId, verifyUser, {\n      method: 'referral',\n      flagshipId: verifyUser.flagshipId,\n    });\n\n    // Notify referrers their code was used successfully\n    const referrerIds = [user1._id?.toString(), user2._id?.toString()].filter(Boolean) as string[];\n    if (referrerIds.length > 0) {\n      await this.notificationService.createForUsers(referrerIds, {\n        title: 'Your referral verified a Musafir',\n        message: `${applicant.fullName || 'A Musafir'} has been verified using your referral code${verifyUser.flagshipId ? ` for flagship ${verifyUser.flagshipId}` : ''}.`,\n        type: 'referral',\n        link: '/referrals',\n        metadata: {\n          applicantId: applicant._id?.toString(),\n          flagshipId: verifyUser.flagshipId,\n        },\n      });\n    }\n\n    return saved;\n  }\n\n  // Reset Password\n  async resetPassword(resetPasswordDto: ResetPasswordDto) {\n    // Find the user\n    const user = await this.userModel.findOne({\n      email: resetPasswordDto.email,\n      emailVerified: true,\n    });\n    if (!user) {\n      throw new BadRequestException('User not found or not verified.');\n    }\n\n    // Check previous password\n    const isPrevPasswordCorrect = await bcrypt.compare(\n      resetPasswordDto.previousPassword,\n      user.password,\n    );\n    if (!isPrevPasswordCorrect) {\n      throw new BadRequestException('Previous password is incorrect.');\n    }\n\n    // Check new password and confirm password match\n    if (resetPasswordDto.password !== resetPasswordDto.confirmPassword) {\n      throw new BadRequestException(\n        'New password and confirm password do not match.',\n      );\n    }\n\n    // Prevent reusing the same password\n    const isSameAsOld = await bcrypt.compare(\n      resetPasswordDto.password,\n      user.password,\n    );\n    if (isSameAsOld) {\n      throw new BadRequestException(\n        'New password must be different from the previous password.',\n      );\n    }\n\n    await this.resetUserPassword(user, resetPasswordDto.password);\n    return {\n      email: resetPasswordDto.email,\n      message: 'password successfully changed.',\n    };\n  }\n\n  // JWT-based Reset Password\n  async resetPasswordWithJwt(\n    token: string,\n    jwtResetPasswordDto: JwtResetPasswordDto,\n  ) {\n    try {\n      // Verify JWT token\n      const decoded = jwt.verify(token, process.env.JWT_SECRET) as any;\n\n      if (decoded.type !== 'password_reset') {\n        throw new BadRequestException('Invalid token type.');\n      }\n\n      // Find user\n      const user = await this.userModel.findById(decoded.userId);\n      if (!user) {\n        throw new BadRequestException('User not found.');\n      }\n\n      // Check if passwords match\n      if (\n        jwtResetPasswordDto.password !== jwtResetPasswordDto.confirmPassword\n      ) {\n        throw new BadRequestException(\n          'New password and confirm password do not match.',\n        );\n      }\n\n      // Update password\n      await this.resetUserPassword(user, jwtResetPasswordDto.password);\n\n      return {\n        email: user.email,\n        message: 'Password successfully changed.',\n      };\n    } catch (error) {\n      if (error.name === 'TokenExpiredError') {\n        throw new BadRequestException(\n          'Reset link has expired. Please request a new one.',\n        );\n      } else if (error.name === 'JsonWebTokenError') {\n        throw new BadRequestException('Invalid reset link.');\n      }\n      throw error;\n    }\n  }\n\n  async setUserVerified(\n    id: string,\n    verifyUser: VerifyUserDto,\n    options?: { method?: string; flagshipId?: string },\n  ) {\n    const user = await this.userModel.findById(id);\n    if (verifyUser.referral1 && verifyUser.referral2) {\n      user.verification.ReferralIDs = [\n        verifyUser.referral1,\n        verifyUser.referral2,\n      ];\n    }\n    user.verification.status = VerificationStatus.VERIFIED;\n    user.verification.VerificationDate = new Date();\n    if (options?.method) {\n      user.verification.method = options.method;\n    }\n    if (verifyUser.flagshipId || options?.flagshipId) {\n      user.verification.flagshipId = options?.flagshipId || verifyUser.flagshipId;\n    }\n    user.markModified('verification');\n    const savedUser = await user.save();\n    await this.creditVerificationReferrersIfEligible(savedUser as any);\n\n    // Send verification approved email if user has an email\n    if (user.email) {\n      try {\n        await this.mailService.sendVerificationApprovedEmail(\n          user.email,\n          user.fullName || 'Musafir'\n        );\n      } catch (error) {\n        console.log('Failed to send verification approved email:', error);\n        // Don't throw error - email failure shouldn't prevent user verification\n      }\n    }\n\n    return savedUser;\n  }\n\n  async requestVerification(id: string, verifyUser: VerifyUserDto) {\n    const user = await this.userModel.findById(id);\n    let method: string | undefined;\n    if (verifyUser.requestCall === 'true') {\n      user.verification.RequestCall = true;\n      method = 'call';\n    }\n    if (verifyUser.videoUrl) {\n      user.verification.VideoLink = verifyUser.videoUrl;\n      method = method || 'video';\n    }\n    if (verifyUser.flagshipId) {\n      user.verification.flagshipId = verifyUser.flagshipId;\n    }\n    user.verification.VerificationRequestDate = new Date();\n    user.verification.status = VerificationStatus.PENDING;\n    if (method) {\n      user.verification.method = method;\n    }\n    user.markModified('verification');\n    const saved = await user.save();\n\n    if (verifyUser.requestCall === 'true') {\n      await this.notifyCommunityLeadsAboutCall(saved);\n    }\n\n    return saved;\n  }\n\n  findAll(): any {\n    return { hello: 'world' };\n  }\n\n  async getUserData(user: User): Promise<User> {\n    const verifiedByMe = await this.userModel.countDocuments({\n      'verification.status': VerificationStatus.VERIFIED,\n      'verification.ReferralIDs': user.referralID,\n    });\n\n    const userWithStatus = this.addProfileStatus(user);\n\n    return {\n      ...(userWithStatus as any),\n      verificationStats: { verifiedByMe },\n    };\n  }\n\n  async unverifiedUsers(search?: string) {\n    const query: any = {\n      'verification.status': VerificationStatus.UNVERIFIED,\n      roles: { $ne: 'admin' },\n    };\n\n    if (search) {\n      const escapedSearch = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      query.$or = [\n        { fullName: { $regex: escapedSearch, $options: 'i' } },\n        { email: { $regex: escapedSearch, $options: 'i' } },\n      ];\n    }\n\n    const users = await this.userModel\n      .find(query)\n      .select('-password -__v')\n      .lean();\n    return users;\n  }\n\n  async verifiedUsers(search?: string) {\n    const query: any = {\n      'verification.status': VerificationStatus.VERIFIED,\n      roles: { $ne: 'admin' },\n    };\n\n    if (search) {\n      const escapedSearch = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      query.$or = [\n        { fullName: { $regex: escapedSearch, $options: 'i' } },\n        { email: { $regex: escapedSearch, $options: 'i' } },\n      ];\n    }\n\n    const users = await this.userModel\n      .find(query)\n      .select('-password -__v')\n      .lean();\n    return users;\n  }\n\n  async pendingVerificationUsers(search?: string) {\n    const query: any = {\n      'verification.status': VerificationStatus.PENDING,\n      roles: { $ne: 'admin' },\n    };\n\n    if (search) {\n      const escapedSearch = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      query.$or = [\n        { fullName: { $regex: escapedSearch, $options: 'i' } },\n        { email: { $regex: escapedSearch, $options: 'i' } },\n      ];\n    }\n\n    const users = await this.userModel\n      .find(query)\n      .select('-password -__v')\n      .lean();\n    return users;\n  }\n\n  async searchAllUsers(search: string) {\n    if (!search) {\n      return {\n        unverified: [],\n        pendingVerification: [],\n        verified: [],\n      };\n    }\n\n    const escapedSearch = search.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n    const query = {\n      roles: { $ne: 'admin' },\n      $or: [\n        { fullName: { $regex: escapedSearch, $options: 'i' } },\n        { email: { $regex: escapedSearch, $options: 'i' } },\n      ],\n    };\n\n    const allUsers = await this.userModel\n      .find(query)\n      .select('-password -__v')\n      .lean();\n\n    const groupedUsers = {\n      unverified: allUsers.filter(user => user.verification.status === VerificationStatus.UNVERIFIED),\n      pendingVerification: allUsers.filter(user => user.verification.status === VerificationStatus.PENDING),\n      verified: allUsers.filter(user => user.verification.status === VerificationStatus.VERIFIED),\n    };\n\n    return groupedUsers;\n  }\n\n  async checkEmailAvailability(email: string) {\n    if (!email) {\n      throw new BadRequestException('Email is required.');\n    }\n\n    const user = await this.userModel.findOne({ email });\n    if (user) {\n      return false;\n    }\n    return true;\n  }\n\n  // ********* Private Methods ******\n\n  /**\n   * Create an object composed of the picked object properties\n   * @param {Object} object\n   * @param {string[]} keys\n   * @returns {Object}\n   */\n  pick(object: { [x: string]: any }, keys: any[]): object {\n    return keys.reduce((obj: { [x: string]: any }, key: string | number) => {\n      if (object && Object.prototype.hasOwnProperty.call(object, key)) {\n        obj[key] = object[key];\n      }\n      return obj;\n    }, {});\n  }\n\n  private async getUser(userId: string): Promise<User> {\n    const user = await this.userModel.findOne({ _id: new ObjectId(userId) });\n    if (!user) {\n      throw new BadRequestException('No user found');\n    }\n    return user;\n  }\n\n  private async isEmailUnique(email: string) {\n    const user = await this.userModel.findOne({ email, emailVerified: true });\n    if (user) {\n      throw new BadRequestException('Email already existss.');\n    }\n  }\n\n  private buildRegistrationInfo(user): any {\n    const userRegistrationInfo = {\n      fullName: user.fullName,\n      email: user.email,\n      verified: user.verified,\n    };\n    return userRegistrationInfo;\n  }\n\n  private async findByVerification(verification: string): Promise<User> {\n    const user = await this.userModel.findOne({\n      'verification.VerificationID': verification,\n      'verification.status': VerificationStatus.UNVERIFIED,\n    });\n    if (!user) {\n      throw new BadRequestException('Bad request.');\n    }\n    return user;\n  }\n\n  private async findByEmail(email: string): Promise<User> {\n    const user = await this.userModel.findOne({ email });\n    if (!user) {\n      throw new NotFoundException('Email not found.');\n    }\n    return user;\n  }\n\n  private async setUserAsVerified(user: UserDocument) {\n    user.emailVerified = true;\n    await user.save();\n  }\n\n  private async findUserByEmail(email: string): Promise<User> {\n    const user = await this.userModel.findOne({ email });\n    if (!user) {\n      throw new NotFoundException('Wrong email or password.');\n    }\n    return user;\n  }\n\n  private async checkPassword(attemptPass: string, user) {\n    const match = await bcrypt.compare(attemptPass, user.password);\n    if (!match) {\n      await this.passwordsDoNotMatch(user);\n      throw new NotFoundException('Wrong email or password.');\n    }\n    return match;\n  }\n\n  private isUserBlocked(user) {\n    if (user.blockExpires > Date.now()) {\n      throw new ConflictException('User has been blocked try later.');\n    }\n  }\n\n  private async passwordsDoNotMatch(user) {\n    user.loginAttempts += 1;\n    await user.save();\n    if (user.loginAttempts >= this.LOGIN_ATTEMPTS_TO_BLOCK) {\n      await this.blockUser(user);\n      throw new ConflictException('User blocked.');\n    }\n  }\n\n  private async blockUser(user) {\n    user.blockExpires = addHours(new Date(), this.HOURS_TO_BLOCK);\n    await user.save();\n  }\n\n  private async passwordsAreMatch(user) {\n    user.loginAttempts = 0;\n    await user.save();\n  }\n\n  private async resetUserPassword(user, newPassword: string) {\n    user.password = newPassword;\n    await user.save();\n  }\n\n  async getUserById(userId: string) {\n    const user = await this.userModel.findById(userId);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n    return user;\n  }\n\n  async updateUser(userId: string, updateUserDto: any) {\n    const user = await this.userModel.findById(userId);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    // Update only the fields that are provided\n    if (updateUserDto.fullName) {\n      user.fullName = updateUserDto.fullName;\n    }\n    if (updateUserDto.phone) {\n      user.phone = updateUserDto.phone;\n    }\n    if (updateUserDto.city) {\n      user.city = updateUserDto.city;\n    }\n    if (updateUserDto.university) {\n      user.university = updateUserDto.university;\n    }\n    if (updateUserDto.employmentStatus) {\n      user.employmentStatus = updateUserDto.employmentStatus as any;\n      if (updateUserDto.employmentStatus === 'unemployed') {\n        user.university = '';\n      }\n    }\n    if (updateUserDto.socialLink) {\n      user.socialLink = updateUserDto.socialLink;\n    }\n    if (updateUserDto.gender) {\n      user.gender = updateUserDto.gender;\n    }\n    if (updateUserDto.cnic) {\n      user.cnic = updateUserDto.cnic;\n    }\n    if (typeof updateUserDto.profileImg !== 'undefined') {\n      user.profileImg = updateUserDto.profileImg;\n    }\n\n    return await user.save();\n  }\n\n  async approveUser(userId: string) {\n    return this.updateVerificationStatus(userId, VerificationStatus.VERIFIED);\n  }\n\n  async updateVerificationStatus(userId: string, status: VerificationStatus) {\n    const user = await this.userModel.findById(userId);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    if (\n      status !== VerificationStatus.VERIFIED &&\n      status !== VerificationStatus.UNVERIFIED\n    ) {\n      throw new BadRequestException(\n        'Status must be either verified or unverified',\n      );\n    }\n\n    user.verification.status = status;\n    if (status === VerificationStatus.VERIFIED) {\n      user.verification.VerificationDate = new Date();\n    } else {\n      user.verification.VerificationDate = undefined;\n      user.verification.RequestCall = false;\n    }\n    user.markModified('verification');\n\n    const savedUser = await user.save();\n    if (status === VerificationStatus.VERIFIED) {\n      await this.creditVerificationReferrersIfEligible(savedUser as any);\n    }\n\n    if (status === VerificationStatus.VERIFIED && user.email) {\n      try {\n        await this.mailService.sendVerificationApprovedEmail(\n          user.email,\n          user.fullName || 'Musafir'\n        );\n      } catch (error) {\n        console.log('Failed to send verification approved email:', error);\n      }\n    }\n\n    try {\n      await this.notificationService.ensureVerificationStatusNotification(\n        userId,\n        status,\n        {\n          metadata: { source: 'admin_override' },\n        },\n      );\n    } catch (error) {\n      console.log('Failed to send verification status notification:', error);\n    }\n\n    return savedUser;\n  }\n\n  async rejectUser(userId: string) {\n    const user = await this.userModel.findById(userId);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n    user.verification.status = VerificationStatus.REJECTED;\n    user.verification.VerificationDate = undefined;\n    user.verification.RequestCall = false;\n    user.verification.method = user.verification.method || 'admin';\n    user.markModified('verification');\n    const savedUser = await user.save();\n\n    // Send verification rejected email if user has an email\n    if (user.email) {\n      try {\n        await this.mailService.sendVerificationRejectedEmail(\n          user.email,\n          user.fullName || 'Musafir'\n        );\n      } catch (error) {\n        console.log('Failed to send verification rejected email:', error);\n        // Don't throw error - email failure shouldn't prevent user rejection\n      }\n    }\n\n    try {\n      await this.notificationService.ensureVerificationStatusNotification(\n        userId,\n        VerificationStatus.REJECTED,\n        {\n          metadata: { source: 'admin_override' },\n        },\n      );\n    } catch (error) {\n      console.log('Failed to send verification status notification:', error);\n    }\n\n    return savedUser;\n  }\n\n  private async notifyCommunityLeadsAboutCall(user: User) {\n    const leads = await this.userModel\n      .find({ roles: { $in: ['admin'] } })\n      .select('_id fullName email')\n      .lean();\n\n    const leadIds = leads.map((lead: any) => lead._id?.toString()).filter(Boolean);\n    if (leadIds.length === 0) return;\n\n    await this.notificationService.createForUsers(leadIds, {\n      title: 'Verification call requested',\n      message: `${user?.fullName || 'A Musafir'} requested an onboarding call for verification${(user as any)?.verification?.flagshipId ? ` (flagship ${(user as any).verification.flagshipId})` : ''}.`,\n      type: 'verification',\n      link: (user as any)?._id ? `/admin/user/${String((user as any)._id)}` : '/admin',\n      metadata: {\n        userId: (user as any)?._id?.toString?.(),\n        flagshipId: (user as any)?.verification?.flagshipId,\n        requestCall: true,\n      },\n    });\n  }\n\n  async uploadVerificationVideo(\n    video: Express.Multer.File,\n    userId: string,\n  ): Promise<User> {\n    try {\n      const user = await this.userModel.findById(userId);\n      if (!user) {\n        throw new NotFoundException('User not found');\n      }\n\n      const videoKey = `verification-videos/${userId}/${Date.now()}-${video.originalname}`;\n      await this.storageService.uploadFile(\n        videoKey,\n        video.buffer,\n        video.mimetype,\n      );\n      user.verification.videoStorageKey = videoKey;\n      user.verification.status = VerificationStatus.PENDING;\n      user.verification.method = 'video';\n      return await user.save();\n    } catch (error) {\n      throw new Error('Failed to upload video: ' + error.message);\n    }\n  }\n}\n"],"version":3}