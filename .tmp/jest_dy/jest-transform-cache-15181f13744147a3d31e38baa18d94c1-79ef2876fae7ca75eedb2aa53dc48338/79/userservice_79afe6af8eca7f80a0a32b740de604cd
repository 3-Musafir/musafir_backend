792875dc95ca1fdeea9e3c32533b4976
"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.UserService = void 0;
const common_1 = require("@nestjs/common");
const mongoose_1 = require("@nestjs/mongoose");
const bcrypt = __importStar(require("bcrypt"));
const bson_1 = require("bson");
const date_fns_1 = require("date-fns");
const jwt = __importStar(require("jsonwebtoken"));
const mongoose_2 = require("mongoose");
const util_1 = require("src/util");
const uuid_1 = require("uuid");
const storageService_1 = require("../storage/storageService");
const auth_service_1 = require("./../auth/auth.service");
const mail_service_1 = require("./../mail/mail.service");
const verification_status_enum_1 = require("../constants/verification-status.enum");
const profile_status_util_1 = require("./profile-status.util");
const notification_service_1 = require("src/notifications/notification.service");
const wallet_service_1 = require("src/wallet/wallet.service");
let UserService = class UserService {
    constructor(userModel, registrationModel, mailService, authService, storageService, notificationService, walletService) {
        this.userModel = userModel;
        this.registrationModel = registrationModel;
        this.mailService = mailService;
        this.authService = authService;
        this.storageService = storageService;
        this.notificationService = notificationService;
        this.walletService = walletService;
        this.HOURS_TO_BLOCK = 6;
        this.LOGIN_ATTEMPTS_TO_BLOCK = 5;
    }
    creditSignupReferrerIfEligible(savedUser) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a, _b;
            const referrerId = (_b = (_a = savedUser === null || savedUser === void 0 ? void 0 : savedUser.referredBy) === null || _a === void 0 ? void 0 : _a.toString) === null || _b === void 0 ? void 0 : _b.call(_a);
            if (!referrerId)
                return;
            try {
                yield this.walletService.credit({
                    userId: referrerId,
                    amount: 100,
                    type: 'referral_signup_credit',
                    sourceId: savedUser._id.toString(),
                    sourceType: 'referral_signup',
                    metadata: {
                        sourceId: savedUser._id.toString(),
                        referredUserId: savedUser._id.toString(),
                    },
                });
                yield this.notificationService.createForUser(referrerId, {
                    title: 'Referral bonus',
                    message: `You earned Rs.100 wallet credit because ${savedUser.fullName || 'a Musafir'} signed up using your referral code.`,
                    type: 'wallet',
                    link: '/wallet',
                    metadata: {
                        referredUserId: savedUser._id.toString(),
                        amount: 100,
                        kind: 'referral_signup_credit',
                    },
                });
            }
            catch (err) {
                console.log('Failed to credit signup referral bonus:', err);
            }
        });
    }
    creditVerificationReferrersIfEligible(verifiedUser) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const referralCodes = (_a = verifiedUser === null || verifiedUser === void 0 ? void 0 : verifiedUser.verification) === null || _a === void 0 ? void 0 : _a.ReferralIDs;
            if (!Array.isArray(referralCodes) || referralCodes.length === 0)
                return;
            try {
                const referrers = yield this.userModel
                    .find({
                    referralID: { $in: referralCodes },
                    'verification.status': verification_status_enum_1.VerificationStatus.VERIFIED,
                    roles: { $ne: 'admin' },
                })
                    .select('_id fullName referralID')
                    .lean()
                    .exec();
                yield Promise.all(referrers.map((referrer) => __awaiter(this, void 0, void 0, function* () {
                    var _a, _b;
                    const referrerId = (_b = (_a = referrer === null || referrer === void 0 ? void 0 : referrer._id) === null || _a === void 0 ? void 0 : _a.toString) === null || _b === void 0 ? void 0 : _b.call(_a);
                    if (!referrerId)
                        return;
                    const sourceId = `${verifiedUser._id.toString()}:verification:${referrerId}`;
                    yield this.walletService.credit({
                        userId: referrerId,
                        amount: 200,
                        type: 'referral_verification_credit',
                        sourceId,
                        sourceType: 'referral_verification',
                        metadata: {
                            sourceId,
                            verifiedUserId: verifiedUser._id.toString(),
                            referralCode: referrer.referralID,
                        },
                    });
                    yield this.notificationService.createForUser(referrerId, {
                        title: 'Verification bonus',
                        message: `You earned Rs.200 wallet credit because ${verifiedUser.fullName || 'a Musafir'} was verified using your referral code.`,
                        type: 'wallet',
                        link: '/wallet',
                        metadata: {
                            verifiedUserId: verifiedUser._id.toString(),
                            amount: 200,
                            kind: 'referral_verification_credit',
                        },
                    });
                })));
            }
            catch (err) {
                console.log('Failed to credit verification referral bonuses:', err);
            }
        });
    }
    awardVerificationReferralCredits(userId) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const user = yield this.userModel.findById(userId).exec();
            if (!user)
                return;
            if (((_a = user === null || user === void 0 ? void 0 : user.verification) === null || _a === void 0 ? void 0 : _a.status) !== verification_status_enum_1.VerificationStatus.VERIFIED)
                return;
            yield this.creditVerificationReferrersIfEligible(user);
        });
    }
    isProfileComplete(user) {
        return (0, profile_status_util_1.isProfileComplete)(user);
    }
    getProfileStatus(user) {
        return (0, profile_status_util_1.buildProfileStatus)(user);
    }
    normalizeVerificationForResponse(user) {
        const verification = user === null || user === void 0 ? void 0 : user.verification;
        if (!verification || typeof verification !== 'object')
            return;
        if (verification.VerificationID && !verification.verificationID) {
            verification.verificationID = verification.VerificationID;
        }
        if (Array.isArray(verification.ReferralIDs) && !verification.referralIDs) {
            verification.referralIDs = verification.ReferralIDs;
        }
        if (verification.VideoLink && !verification.videoLink) {
            verification.videoLink = verification.VideoLink;
        }
        if (verification.VerificationDate && !verification.verificationDate) {
            verification.verificationDate = verification.VerificationDate;
        }
        if (verification.VerificationRequestDate &&
            !verification.verificationRequestDate) {
            verification.verificationRequestDate = verification.VerificationRequestDate;
        }
        if (typeof verification.RequestCall !== 'undefined' &&
            typeof verification.requestCall === 'undefined') {
            verification.requestCall = verification.RequestCall;
        }
    }
    addProfileStatus(user) {
        const plainUser = typeof (user === null || user === void 0 ? void 0 : user.toObject) === 'function' ? user.toObject() : user;
        this.normalizeVerificationForResponse(plainUser);
        const profileStatus = this.getProfileStatus(plainUser);
        return Object.assign(Object.assign({}, plainUser), { profileComplete: this.isProfileComplete(plainUser), profileStatus });
    }
    ensureReferralPairValid(applicant, referral1, referral2) {
        if (!referral1 || !referral2) {
            throw new common_1.BadRequestException('Two referral codes are required.');
        }
        if (referral1 === referral2) {
            throw new common_1.BadRequestException('Referral codes must be different.');
        }
        if (applicant.referralID &&
            (applicant.referralID === referral1 || applicant.referralID === referral2)) {
            throw new common_1.BadRequestException('You cannot use your own referral code.');
        }
    }
    resolveVerifiedReferrer(referralID) {
        return this.userModel.findOne({
            referralID,
            'verification.status': verification_status_enum_1.VerificationStatus.VERIFIED,
            roles: { $ne: 'admin' },
        });
    }
    applyReferralAttribution(user, referralCode) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!referralCode)
                return;
            try {
                const referrer = yield this.resolveVerifiedReferrer(referralCode);
                if (referrer) {
                    user.referredBy = referrer._id;
                    user.referredCode = referralCode;
                }
            }
            catch (err) {
                // swallow attribution errors; should not block signup
                console.warn('Referral attribution failed', err);
            }
        });
    }
    // Create User
    create(createUserDto) {
        return __awaiter(this, void 0, void 0, function* () {
            createUserDto.password = (0, util_1.generateRandomPassword)();
            const user = new this.userModel(createUserDto);
            yield this.isEmailUnique(user.email);
            yield this.applyReferralAttribution(user, createUserDto.referralCode || createUserDto.ref);
            user.referralID = (0, util_1.generateUniqueCode)();
            user.verification.VerificationID = (0, uuid_1.v4)();
            user.verification.status = verification_status_enum_1.VerificationStatus.UNVERIFIED;
            const password = createUserDto.password;
            yield this.mailService.sendEmailVerification(user.email, password);
            const savedUser = yield user.save();
            yield this.creditSignupReferrerIfEligible(savedUser);
            return {
                userId: savedUser._id,
                verificationId: savedUser.verification.VerificationID,
            };
        });
    }
    // Create Email User
    createEmailUser(userDto, req) {
        return __awaiter(this, void 0, void 0, function* () {
            let user = yield this.userModel.findOne({ email: userDto.email });
            if (!user) {
                user = new this.userModel(userDto);
                yield this.isEmailUnique(user.email);
                yield this.applyReferralAttribution(user, userDto.referralCode || userDto.ref);
                user.referralID = (0, util_1.generateUniqueCode)();
                user.emailVerified = true;
                user.verification.VerificationID = (0, uuid_1.v4)();
                user.verification.status = verification_status_enum_1.VerificationStatus.UNVERIFIED;
                const saved = yield user.save();
                yield this.creditSignupReferrerIfEligible(saved);
                user = saved;
            }
            const userWithStatus = this.addProfileStatus(user);
            return {
                user: userWithStatus,
                email: userWithStatus.email,
                accessToken: yield this.authService.createAccessToken(String(user._id)),
                refreshToken: yield this.authService.createRefreshToken(req, user._id),
            };
        });
    }
    // Create Google Users
    createGoogleUser(userDto, req) {
        return __awaiter(this, void 0, void 0, function* () {
            let user = yield this.userModel.findOne({ email: userDto.email });
            if (!user) {
                user = new this.userModel(userDto);
                yield this.isEmailUnique(user.email);
                yield this.applyReferralAttribution(user, userDto.referralCode || userDto.ref);
                user.referralID = (0, util_1.generateUniqueCode)();
                user.emailVerified = true;
                user.verification.VerificationID = (0, uuid_1.v4)();
                user.verification.status = verification_status_enum_1.VerificationStatus.UNVERIFIED;
                const saved = yield user.save();
                yield this.creditSignupReferrerIfEligible(saved);
                user = saved;
            }
            const userWithStatus = this.addProfileStatus(user);
            return {
                user: userWithStatus,
                accessToken: yield this.authService.createAccessToken(String(user._id)),
                refreshToken: yield this.authService.createRefreshToken(req, user._id),
            };
        });
    }
    // Create Google Users
    createToken(user, req) {
        return __awaiter(this, void 0, void 0, function* () {
            return {
                email: user.email,
                accessToken: yield this.authService.createAccessToken(String(user.googleId)),
            };
        });
    }
    // Verify Email
    verifyEmail(req, password, verificationId) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const user = yield this.findByVerification(verificationId);
            yield this.checkPassword(password, user);
            yield this.setUserAsVerified(user);
            // Send account created notification after password is set and email is verified
            if (user.email && password) {
                const firstName = ((_a = user.fullName) === null || _a === void 0 ? void 0 : _a.split(' ')[0]) || 'User';
                const loginUrl = process.env.FRONTEND_URL + '/login';
                yield this.mailService.sendAccountCreatedEmail(user.email, firstName, loginUrl);
            }
            return {
                fullName: user.fullName,
                email: user.email,
                accessToken: yield this.authService.createAccessToken(String(user._id)),
                refreshToken: yield this.authService.createRefreshToken(req, user._id),
            };
        });
    }
    // Login
    login(req, loginUserDto) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.findUserByEmail(loginUserDto.email);
            yield this.checkPassword(loginUserDto.password, user);
            const userWithStatus = this.addProfileStatus(user);
            return {
                user: userWithStatus,
                fullName: user.fullName,
                email: user.email,
                accessToken: yield this.authService.createAccessToken(String(user._id)),
                refreshToken: yield this.authService.createRefreshToken(req, user._id),
            };
        });
    }
    // Find user by email or phone
    findUserByEmailOrPhone(emailOrPhone) {
        return __awaiter(this, void 0, void 0, function* () {
            const raw = (emailOrPhone || '').trim();
            if (!raw) {
                throw new common_1.BadRequestException('emailOrPhone is required');
            }
            const isEmail = raw.includes('@');
            const lower = raw.toLowerCase();
            const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const digitsOnly = (s) => s.replace(/\D/g, '');
            let user = null;
            if (isEmail) {
                user = yield this.userModel.findOne({ email: lower });
            }
            else {
                // 1) Exact phone match first
                user = yield this.userModel.findOne({ phone: raw });
                // 2) Fallback: match by last 7 digits (e.g. +923444225504 => 4225504)
                if (!user) {
                    const digits = digitsOnly(raw);
                    if (digits.length < 7) {
                        throw new common_1.NotFoundException('User not found');
                    }
                    // Try the most specific suffix first (entire digits string), then last 7.
                    const suffixes = digits.length > 7 ? [digits, digits.slice(-7)] : [digits];
                    for (const suffix of suffixes) {
                        const re = new RegExp(`${escapeRegex(suffix)}$`);
                        const matches = yield this.userModel
                            .find({ phone: { $regex: re } })
                            .limit(5)
                            .exec();
                        if (matches.length === 1) {
                            user = matches[0];
                            break;
                        }
                        if (matches.length > 1) {
                            throw new common_1.ConflictException('Multiple users matched this phone number. Please enter full phone number or email.');
                        }
                    }
                }
            }
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            // Check if user has password (existing user)
            if (user.password) {
                throw new common_1.ConflictException('Account already exists. Please login.');
            }
            // Get user's registrations to find trips
            const registrations = yield this.registrationModel.find({ userId: user._id })
                .populate('flagshipId', 'tripName')
                .exec();
            const trips = registrations
                .map(reg => {
                const flagship = reg.flagshipId;
                return flagship === null || flagship === void 0 ? void 0 : flagship.tripName;
            })
                .filter(Boolean);
            return {
                user: {
                    _id: user._id,
                    fullName: user.fullName,
                    email: user.email,
                    phone: user.phone,
                    city: user.city || 'Unknown'
                },
                trips
            };
        });
    }
    // Verify musafir email and generate password
    verifyMusafirEmail(email, updateExisting, userId) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            let user;
            if (updateExisting && userId) {
                // Update existing user's email
                user = yield this.userModel.findById(userId);
                if (!user) {
                    throw new common_1.NotFoundException('User not found');
                }
                // Check if the new email is already taken by another user
                const existingUserWithEmail = yield this.userModel.findOne({
                    email: email.toLowerCase(),
                    _id: { $ne: userId } // Exclude current user
                });
                if (existingUserWithEmail) {
                    throw new common_1.ConflictException('Email is already taken by another user');
                }
                // Update the user's email
                user.email = email.toLowerCase();
            }
            else {
                // Find existing user
                user = yield this.userModel.findOne({ email: email.toLowerCase() });
                if (!user) {
                    throw new common_1.NotFoundException('User not found');
                }
                // Check if user already has password
                if (user.password) {
                    throw new common_1.ConflictException('Account already exists. Please login.');
                }
            }
            // Generate new password
            const newPassword = (0, util_1.generateRandomPassword)();
            user.password = newPassword;
            user.emailVerified = true;
            // Preserve existing verification status; do not auto-verify on email confirm
            if (!((_a = user.verification) === null || _a === void 0 ? void 0 : _a.status)) {
                user.verification = user.verification || {};
                user.verification.status = verification_status_enum_1.VerificationStatus.UNVERIFIED;
            }
            yield user.save();
            // Send email with password
            yield this.mailService.sendEmailVerification(user.email, newPassword);
            return {
                message: 'Password sent to your email',
                email: user.email
            };
        });
    }
    // Refresh Access Token
    refreshAccessToken(refreshAccessTokenDto) {
        return __awaiter(this, void 0, void 0, function* () {
            const userId = yield this.authService.findRefreshToken(refreshAccessTokenDto.refreshToken);
            const user = yield this.userModel.findById(userId);
            if (!user) {
                throw new common_1.BadRequestException('Bad request');
            }
            return {
                accessToken: yield this.authService.createAccessToken(String(user._id)),
            };
        });
    }
    // Forget Password
    forgotPassword(req, createForgotPasswordDto) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.findByEmail(createForgotPasswordDto.email);
            // Generate JWT token with 15 minutes expiry
            const resetToken = jwt.sign({
                userId: user._id,
                email: user.email,
                type: 'password_reset',
            }, process.env.JWT_SECRET, { expiresIn: '15m' });
            // Create reset link with frontend URL
            const resetLink = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;
            // Send email with reset link
            yield this.mailService.sendPasswordResetEmail(user.email, resetLink, user.fullName || 'User');
            return {
                email: createForgotPasswordDto.email,
                message: 'Password reset link sent to your email.',
            };
        });
    }
    findByReferralId(refferal) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({
                referralID: refferal,
                'verification.status': verification_status_enum_1.VerificationStatus.VERIFIED,
            });
            if (!user) {
                throw new common_1.BadRequestException('Bad request.');
            }
            return user;
        });
    }
    verifyWithReferrals(applicantId, verifyUser) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a, _b, _c;
            const applicant = yield this.userModel.findById(applicantId);
            if (!applicant) {
                throw new common_1.BadRequestException('Applicant not found.');
            }
            const { referral1, referral2 } = verifyUser;
            this.ensureReferralPairValid(applicant, referral1, referral2);
            const [user1, user2] = yield Promise.all([
                this.resolveVerifiedReferrer(referral1),
                this.resolveVerifiedReferrer(referral2),
            ]);
            if (!user1 || !user2) {
                throw new common_1.BadRequestException('Referral codes must belong to verified users.');
            }
            if (user1._id.equals(user2._id)) {
                throw new common_1.BadRequestException('Referral codes must come from two different users.');
            }
            if (user1._id.equals(applicant._id) || user2._id.equals(applicant._id)) {
                throw new common_1.BadRequestException('You cannot verify yourself.');
            }
            const genders = [user1.gender, user2.gender];
            const hasMale = genders.includes('male');
            const hasFemale = genders.includes('female');
            if (!hasMale || !hasFemale) {
                throw new common_1.BadRequestException('Referral codes must include at least one male and one female verified Musafir.');
            }
            const saved = yield this.setUserVerified(applicantId, verifyUser, {
                method: 'referral',
                flagshipId: verifyUser.flagshipId,
            });
            // Notify referrers their code was used successfully
            const referrerIds = [(_a = user1._id) === null || _a === void 0 ? void 0 : _a.toString(), (_b = user2._id) === null || _b === void 0 ? void 0 : _b.toString()].filter(Boolean);
            if (referrerIds.length > 0) {
                yield this.notificationService.createForUsers(referrerIds, {
                    title: 'Your referral verified a Musafir',
                    message: `${applicant.fullName || 'A Musafir'} has been verified using your referral code${verifyUser.flagshipId ? ` for flagship ${verifyUser.flagshipId}` : ''}.`,
                    type: 'referral',
                    link: '/referrals',
                    metadata: {
                        applicantId: (_c = applicant._id) === null || _c === void 0 ? void 0 : _c.toString(),
                        flagshipId: verifyUser.flagshipId,
                    },
                });
            }
            return saved;
        });
    }
    // Reset Password
    resetPassword(resetPasswordDto) {
        return __awaiter(this, void 0, void 0, function* () {
            // Find the user
            const user = yield this.userModel.findOne({
                email: resetPasswordDto.email,
                emailVerified: true,
            });
            if (!user) {
                throw new common_1.BadRequestException('User not found or not verified.');
            }
            // Check previous password
            const isPrevPasswordCorrect = yield bcrypt.compare(resetPasswordDto.previousPassword, user.password);
            if (!isPrevPasswordCorrect) {
                throw new common_1.BadRequestException('Previous password is incorrect.');
            }
            // Check new password and confirm password match
            if (resetPasswordDto.password !== resetPasswordDto.confirmPassword) {
                throw new common_1.BadRequestException('New password and confirm password do not match.');
            }
            // Prevent reusing the same password
            const isSameAsOld = yield bcrypt.compare(resetPasswordDto.password, user.password);
            if (isSameAsOld) {
                throw new common_1.BadRequestException('New password must be different from the previous password.');
            }
            yield this.resetUserPassword(user, resetPasswordDto.password);
            return {
                email: resetPasswordDto.email,
                message: 'password successfully changed.',
            };
        });
    }
    // JWT-based Reset Password
    resetPasswordWithJwt(token, jwtResetPasswordDto) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                // Verify JWT token
                const decoded = jwt.verify(token, process.env.JWT_SECRET);
                if (decoded.type !== 'password_reset') {
                    throw new common_1.BadRequestException('Invalid token type.');
                }
                // Find user
                const user = yield this.userModel.findById(decoded.userId);
                if (!user) {
                    throw new common_1.BadRequestException('User not found.');
                }
                // Check if passwords match
                if (jwtResetPasswordDto.password !== jwtResetPasswordDto.confirmPassword) {
                    throw new common_1.BadRequestException('New password and confirm password do not match.');
                }
                // Update password
                yield this.resetUserPassword(user, jwtResetPasswordDto.password);
                return {
                    email: user.email,
                    message: 'Password successfully changed.',
                };
            }
            catch (error) {
                if (error.name === 'TokenExpiredError') {
                    throw new common_1.BadRequestException('Reset link has expired. Please request a new one.');
                }
                else if (error.name === 'JsonWebTokenError') {
                    throw new common_1.BadRequestException('Invalid reset link.');
                }
                throw error;
            }
        });
    }
    setUserVerified(id, verifyUser, options) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(id);
            if (verifyUser.referral1 && verifyUser.referral2) {
                user.verification.ReferralIDs = [
                    verifyUser.referral1,
                    verifyUser.referral2,
                ];
            }
            user.verification.status = verification_status_enum_1.VerificationStatus.VERIFIED;
            user.verification.VerificationDate = new Date();
            if (options === null || options === void 0 ? void 0 : options.method) {
                user.verification.method = options.method;
            }
            if (verifyUser.flagshipId || (options === null || options === void 0 ? void 0 : options.flagshipId)) {
                user.verification.flagshipId = (options === null || options === void 0 ? void 0 : options.flagshipId) || verifyUser.flagshipId;
            }
            user.markModified('verification');
            const savedUser = yield user.save();
            yield this.creditVerificationReferrersIfEligible(savedUser);
            // Send verification approved email if user has an email
            if (user.email) {
                try {
                    yield this.mailService.sendVerificationApprovedEmail(user.email, user.fullName || 'Musafir');
                }
                catch (error) {
                    console.log('Failed to send verification approved email:', error);
                    // Don't throw error - email failure shouldn't prevent user verification
                }
            }
            return savedUser;
        });
    }
    requestVerification(id, verifyUser) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(id);
            let method;
            if (verifyUser.requestCall === 'true') {
                user.verification.RequestCall = true;
                method = 'call';
            }
            if (verifyUser.videoUrl) {
                user.verification.VideoLink = verifyUser.videoUrl;
                method = method || 'video';
            }
            if (verifyUser.flagshipId) {
                user.verification.flagshipId = verifyUser.flagshipId;
            }
            user.verification.VerificationRequestDate = new Date();
            user.verification.status = verification_status_enum_1.VerificationStatus.PENDING;
            if (method) {
                user.verification.method = method;
            }
            user.markModified('verification');
            const saved = yield user.save();
            if (verifyUser.requestCall === 'true') {
                yield this.notifyCommunityLeadsAboutCall(saved);
            }
            return saved;
        });
    }
    findAll() {
        return { hello: 'world' };
    }
    getUserData(user) {
        return __awaiter(this, void 0, void 0, function* () {
            const verifiedByMe = yield this.userModel.countDocuments({
                'verification.status': verification_status_enum_1.VerificationStatus.VERIFIED,
                'verification.ReferralIDs': user.referralID,
            });
            const userWithStatus = this.addProfileStatus(user);
            return Object.assign(Object.assign({}, userWithStatus), { verificationStats: { verifiedByMe } });
        });
    }
    unverifiedUsers(search) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                'verification.status': verification_status_enum_1.VerificationStatus.UNVERIFIED,
                roles: { $ne: 'admin' },
            };
            if (search) {
                const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                query.$or = [
                    { fullName: { $regex: escapedSearch, $options: 'i' } },
                    { email: { $regex: escapedSearch, $options: 'i' } },
                ];
            }
            const users = yield this.userModel
                .find(query)
                .select('-password -__v')
                .lean();
            return users;
        });
    }
    verifiedUsers(search) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                'verification.status': verification_status_enum_1.VerificationStatus.VERIFIED,
                roles: { $ne: 'admin' },
            };
            if (search) {
                const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                query.$or = [
                    { fullName: { $regex: escapedSearch, $options: 'i' } },
                    { email: { $regex: escapedSearch, $options: 'i' } },
                ];
            }
            const users = yield this.userModel
                .find(query)
                .select('-password -__v')
                .lean();
            return users;
        });
    }
    pendingVerificationUsers(search) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                'verification.status': verification_status_enum_1.VerificationStatus.PENDING,
                roles: { $ne: 'admin' },
            };
            if (search) {
                const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                query.$or = [
                    { fullName: { $regex: escapedSearch, $options: 'i' } },
                    { email: { $regex: escapedSearch, $options: 'i' } },
                ];
            }
            const users = yield this.userModel
                .find(query)
                .select('-password -__v')
                .lean();
            return users;
        });
    }
    searchAllUsers(search) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!search) {
                return {
                    unverified: [],
                    pendingVerification: [],
                    verified: [],
                };
            }
            const escapedSearch = search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const query = {
                roles: { $ne: 'admin' },
                $or: [
                    { fullName: { $regex: escapedSearch, $options: 'i' } },
                    { email: { $regex: escapedSearch, $options: 'i' } },
                ],
            };
            const allUsers = yield this.userModel
                .find(query)
                .select('-password -__v')
                .lean();
            const groupedUsers = {
                unverified: allUsers.filter(user => user.verification.status === verification_status_enum_1.VerificationStatus.UNVERIFIED),
                pendingVerification: allUsers.filter(user => user.verification.status === verification_status_enum_1.VerificationStatus.PENDING),
                verified: allUsers.filter(user => user.verification.status === verification_status_enum_1.VerificationStatus.VERIFIED),
            };
            return groupedUsers;
        });
    }
    checkEmailAvailability(email) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!email) {
                throw new common_1.BadRequestException('Email is required.');
            }
            const user = yield this.userModel.findOne({ email });
            if (user) {
                return false;
            }
            return true;
        });
    }
    // ********* Private Methods ******
    /**
     * Create an object composed of the picked object properties
     * @param {Object} object
     * @param {string[]} keys
     * @returns {Object}
     */
    pick(object, keys) {
        return keys.reduce((obj, key) => {
            if (object && Object.prototype.hasOwnProperty.call(object, key)) {
                obj[key] = object[key];
            }
            return obj;
        }, {});
    }
    getUser(userId) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({ _id: new bson_1.ObjectId(userId) });
            if (!user) {
                throw new common_1.BadRequestException('No user found');
            }
            return user;
        });
    }
    isEmailUnique(email) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({ email, emailVerified: true });
            if (user) {
                throw new common_1.BadRequestException('Email already existss.');
            }
        });
    }
    buildRegistrationInfo(user) {
        const userRegistrationInfo = {
            fullName: user.fullName,
            email: user.email,
            verified: user.verified,
        };
        return userRegistrationInfo;
    }
    findByVerification(verification) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({
                'verification.VerificationID': verification,
                'verification.status': verification_status_enum_1.VerificationStatus.UNVERIFIED,
            });
            if (!user) {
                throw new common_1.BadRequestException('Bad request.');
            }
            return user;
        });
    }
    findByEmail(email) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({ email });
            if (!user) {
                throw new common_1.NotFoundException('Email not found.');
            }
            return user;
        });
    }
    setUserAsVerified(user) {
        return __awaiter(this, void 0, void 0, function* () {
            user.emailVerified = true;
            yield user.save();
        });
    }
    findUserByEmail(email) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findOne({ email });
            if (!user) {
                throw new common_1.NotFoundException('Wrong email or password.');
            }
            return user;
        });
    }
    checkPassword(attemptPass, user) {
        return __awaiter(this, void 0, void 0, function* () {
            const match = yield bcrypt.compare(attemptPass, user.password);
            if (!match) {
                yield this.passwordsDoNotMatch(user);
                throw new common_1.NotFoundException('Wrong email or password.');
            }
            return match;
        });
    }
    isUserBlocked(user) {
        if (user.blockExpires > Date.now()) {
            throw new common_1.ConflictException('User has been blocked try later.');
        }
    }
    passwordsDoNotMatch(user) {
        return __awaiter(this, void 0, void 0, function* () {
            user.loginAttempts += 1;
            yield user.save();
            if (user.loginAttempts >= this.LOGIN_ATTEMPTS_TO_BLOCK) {
                yield this.blockUser(user);
                throw new common_1.ConflictException('User blocked.');
            }
        });
    }
    blockUser(user) {
        return __awaiter(this, void 0, void 0, function* () {
            user.blockExpires = (0, date_fns_1.addHours)(new Date(), this.HOURS_TO_BLOCK);
            yield user.save();
        });
    }
    passwordsAreMatch(user) {
        return __awaiter(this, void 0, void 0, function* () {
            user.loginAttempts = 0;
            yield user.save();
        });
    }
    resetUserPassword(user, newPassword) {
        return __awaiter(this, void 0, void 0, function* () {
            user.password = newPassword;
            yield user.save();
        });
    }
    getUserById(userId) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(userId);
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            return user;
        });
    }
    updateUser(userId, updateUserDto) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(userId);
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            // Update only the fields that are provided
            if (updateUserDto.fullName) {
                user.fullName = updateUserDto.fullName;
            }
            if (updateUserDto.phone) {
                user.phone = updateUserDto.phone;
            }
            if (updateUserDto.city) {
                user.city = updateUserDto.city;
            }
            if (updateUserDto.university) {
                user.university = updateUserDto.university;
            }
            if (updateUserDto.employmentStatus) {
                user.employmentStatus = updateUserDto.employmentStatus;
                if (updateUserDto.employmentStatus === 'unemployed') {
                    user.university = '';
                }
            }
            if (updateUserDto.socialLink) {
                user.socialLink = updateUserDto.socialLink;
            }
            if (updateUserDto.gender) {
                user.gender = updateUserDto.gender;
            }
            if (updateUserDto.cnic) {
                user.cnic = updateUserDto.cnic;
            }
            if (typeof updateUserDto.profileImg !== 'undefined') {
                user.profileImg = updateUserDto.profileImg;
            }
            return yield user.save();
        });
    }
    approveUser(userId) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.updateVerificationStatus(userId, verification_status_enum_1.VerificationStatus.VERIFIED);
        });
    }
    updateVerificationStatus(userId, status) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(userId);
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            if (status !== verification_status_enum_1.VerificationStatus.VERIFIED &&
                status !== verification_status_enum_1.VerificationStatus.UNVERIFIED) {
                throw new common_1.BadRequestException('Status must be either verified or unverified');
            }
            user.verification.status = status;
            if (status === verification_status_enum_1.VerificationStatus.VERIFIED) {
                user.verification.VerificationDate = new Date();
            }
            else {
                user.verification.VerificationDate = undefined;
                user.verification.RequestCall = false;
            }
            user.markModified('verification');
            const savedUser = yield user.save();
            if (status === verification_status_enum_1.VerificationStatus.VERIFIED) {
                yield this.creditVerificationReferrersIfEligible(savedUser);
            }
            if (status === verification_status_enum_1.VerificationStatus.VERIFIED && user.email) {
                try {
                    yield this.mailService.sendVerificationApprovedEmail(user.email, user.fullName || 'Musafir');
                }
                catch (error) {
                    console.log('Failed to send verification approved email:', error);
                }
            }
            try {
                yield this.notificationService.ensureVerificationStatusNotification(userId, status, {
                    metadata: { source: 'admin_override' },
                });
            }
            catch (error) {
                console.log('Failed to send verification status notification:', error);
            }
            return savedUser;
        });
    }
    rejectUser(userId) {
        return __awaiter(this, void 0, void 0, function* () {
            const user = yield this.userModel.findById(userId);
            if (!user) {
                throw new common_1.NotFoundException('User not found');
            }
            user.verification.status = verification_status_enum_1.VerificationStatus.REJECTED;
            user.verification.VerificationDate = undefined;
            user.verification.RequestCall = false;
            user.verification.method = user.verification.method || 'admin';
            user.markModified('verification');
            const savedUser = yield user.save();
            // Send verification rejected email if user has an email
            if (user.email) {
                try {
                    yield this.mailService.sendVerificationRejectedEmail(user.email, user.fullName || 'Musafir');
                }
                catch (error) {
                    console.log('Failed to send verification rejected email:', error);
                    // Don't throw error - email failure shouldn't prevent user rejection
                }
            }
            try {
                yield this.notificationService.ensureVerificationStatusNotification(userId, verification_status_enum_1.VerificationStatus.REJECTED, {
                    metadata: { source: 'admin_override' },
                });
            }
            catch (error) {
                console.log('Failed to send verification status notification:', error);
            }
            return savedUser;
        });
    }
    notifyCommunityLeadsAboutCall(user) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a, _b, _c, _d;
            const leads = yield this.userModel
                .find({ roles: { $in: ['admin'] } })
                .select('_id fullName email')
                .lean();
            const leadIds = leads.map((lead) => { var _a; return (_a = lead._id) === null || _a === void 0 ? void 0 : _a.toString(); }).filter(Boolean);
            if (leadIds.length === 0)
                return;
            yield this.notificationService.createForUsers(leadIds, {
                title: 'Verification call requested',
                message: `${(user === null || user === void 0 ? void 0 : user.fullName) || 'A Musafir'} requested an onboarding call for verification${((_a = user === null || user === void 0 ? void 0 : user.verification) === null || _a === void 0 ? void 0 : _a.flagshipId) ? ` (flagship ${user.verification.flagshipId})` : ''}.`,
                type: 'verification',
                link: (user === null || user === void 0 ? void 0 : user._id) ? `/admin/user/${String(user._id)}` : '/admin',
                metadata: {
                    userId: (_c = (_b = user === null || user === void 0 ? void 0 : user._id) === null || _b === void 0 ? void 0 : _b.toString) === null || _c === void 0 ? void 0 : _c.call(_b),
                    flagshipId: (_d = user === null || user === void 0 ? void 0 : user.verification) === null || _d === void 0 ? void 0 : _d.flagshipId,
                    requestCall: true,
                },
            });
        });
    }
    uploadVerificationVideo(video, userId) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const user = yield this.userModel.findById(userId);
                if (!user) {
                    throw new common_1.NotFoundException('User not found');
                }
                const videoKey = `verification-videos/${userId}/${Date.now()}-${video.originalname}`;
                yield this.storageService.uploadFile(videoKey, video.buffer, video.mimetype);
                user.verification.videoStorageKey = videoKey;
                user.verification.status = verification_status_enum_1.VerificationStatus.PENDING;
                user.verification.method = 'video';
                return yield user.save();
            }
            catch (error) {
                throw new Error('Failed to upload video: ' + error.message);
            }
        });
    }
};
exports.UserService = UserService;
exports.UserService = UserService = __decorate([
    (0, common_1.Injectable)(),
    __param(0, (0, mongoose_1.InjectModel)('User')),
    __param(1, (0, mongoose_1.InjectModel)('Registration')),
    __metadata("design:paramtypes", [mongoose_2.Model,
        mongoose_2.Model,
        mail_service_1.MailService,
        auth_service_1.AuthService,
        storageService_1.StorageService,
        notification_service_1.NotificationService,
        wallet_service_1.WalletService])
], UserService);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2RldnByb2ZpbGUvRG9jdW1lbnRzL0dpdEh1Yi9tdXNhZmlyX2JhY2tlbmQvc3JjL3VzZXIvdXNlci5zZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUt3QjtBQUN4QiwrQ0FBK0M7QUFDL0MsK0NBQWlDO0FBQ2pDLCtCQUFnQztBQUNoQyx1Q0FBb0M7QUFFcEMsa0RBQW9DO0FBQ3BDLHVDQUFpQztBQUNqQyxtQ0FBc0U7QUFDdEUsK0JBQTBCO0FBRTFCLDhEQUEyRDtBQUMzRCx5REFBcUQ7QUFDckQseURBQXFEO0FBV3JELG9GQUEyRTtBQUMzRSwrREFHK0I7QUFDL0IsaUZBQTZFO0FBQzdFLDhEQUEwRDtBQUduRCxJQUFNLFdBQVcsR0FBakIsTUFBTSxXQUFXO0lBSXRCLFlBQ3VCLFNBQStDLEVBQ3ZDLGlCQUF1RCxFQUNuRSxXQUF3QixFQUN4QixXQUF3QixFQUN4QixjQUE4QixFQUM5QixtQkFBd0MsRUFDeEMsYUFBNEI7UUFOUCxjQUFTLEdBQVQsU0FBUyxDQUFxQjtRQUN0QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBQ25FLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBVi9DLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLDRCQUF1QixHQUFHLENBQUMsQ0FBQztJQVV4QixDQUFDO0lBRVMsOEJBQThCLENBQUMsU0FBdUI7OztZQUNsRSxNQUFNLFVBQVUsR0FBRyxNQUFBLE1BQUEsU0FBUyxhQUFULFNBQVMsdUJBQVQsU0FBUyxDQUFFLFVBQVUsMENBQUUsUUFBUSxrREFBSSxDQUFDO1lBQ3ZELElBQUksQ0FBQyxVQUFVO2dCQUFFLE9BQU87WUFF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QUcsT0FBTyxDQUFDO2dCQUNuQyxPQUFPLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzNCLENBQUM7WUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO2dCQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlELENBQUM7UUFDSCxDQUFDO0tBQUE7Q0FDRixDQUFBO0FBaHBDWSxrQ0FBVztzQkFBWCxXQUFXO0lBRHZCLElBQUEsbUJBQVUsR0FBRTtJQU1SLFdBQUEsSUFBQSxzQkFBVyxFQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ25CLFdBQUEsSUFBQSxzQkFBVyxFQUFDLGNBQWMsQ0FBQyxDQUFBO3FDQURxQixnQkFBSztRQUNXLGdCQUFLO1FBQ3hDLDBCQUFXO1FBQ1gsMEJBQVc7UUFDUiwrQkFBYztRQUNULDBDQUFtQjtRQUN6Qiw4QkFBYTtHQVhwQyxXQUFXLENBZ3BDdkIiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2RldnByb2ZpbGUvRG9jdW1lbnRzL0dpdEh1Yi9tdXNhZmlyX2JhY2tlbmQvc3JjL3VzZXIvdXNlci5zZXJ2aWNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhZFJlcXVlc3RFeGNlcHRpb24sXG4gIENvbmZsaWN0RXhjZXB0aW9uLFxuICBJbmplY3RhYmxlLFxuICBOb3RGb3VuZEV4Y2VwdGlvbixcbn0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgSW5qZWN0TW9kZWwgfSBmcm9tICdAbmVzdGpzL21vbmdvb3NlJztcbmltcG9ydCAqIGFzIGJjcnlwdCBmcm9tICdiY3J5cHQnO1xuaW1wb3J0IHsgT2JqZWN0SWQgfSBmcm9tICdic29uJztcbmltcG9ydCB7IGFkZEhvdXJzIH0gZnJvbSAnZGF0ZS1mbnMnO1xuaW1wb3J0IHsgUmVxdWVzdCB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0ICogYXMgand0IGZyb20gJ2pzb253ZWJ0b2tlbic7XG5pbXBvcnQgeyBNb2RlbCB9IGZyb20gJ21vbmdvb3NlJztcbmltcG9ydCB7IGdlbmVyYXRlUmFuZG9tUGFzc3dvcmQsIGdlbmVyYXRlVW5pcXVlQ29kZSB9IGZyb20gJ3NyYy91dGlsJztcbmltcG9ydCB7IHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBSZWdpc3RyYXRpb24gfSBmcm9tICcuLi9yZWdpc3RyYXRpb24vaW50ZXJmYWNlcy9yZWdpc3RyYXRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9zdG9yYWdlU2VydmljZSc7XG5pbXBvcnQgeyBBdXRoU2VydmljZSB9IGZyb20gJy4vLi4vYXV0aC9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgTWFpbFNlcnZpY2UgfSBmcm9tICcuLy4uL21haWwvbWFpbC5zZXJ2aWNlJztcbmltcG9ydCB7IENyZWF0ZUZvcmdvdFBhc3N3b3JkRHRvIH0gZnJvbSAnLi9kdG8vY3JlYXRlLWZvcmdvdC1wYXNzd29yZC5kdG8nO1xuaW1wb3J0IHsgQ3JlYXRlR29vZ2xlVXNlckR0bywgRW1haWxVc2VyRHRvIH0gZnJvbSAnLi9kdG8vY3JlYXRlLXVzZXIuZHRvJztcbmltcG9ydCB7IExvZ2luVXNlckR0byB9IGZyb20gJy4vZHRvL2xvZ2luLXVzZXIuZHRvJztcbmltcG9ydCB7IFJlZnJlc2hBY2Nlc3NUb2tlbkR0byB9IGZyb20gJy4vZHRvL3JlZnJlc2gtYWNjZXNzLXRva2VuLmR0byc7XG5pbXBvcnQge1xuICBKd3RSZXNldFBhc3N3b3JkRHRvLFxuICBSZXNldFBhc3N3b3JkRHRvLFxufSBmcm9tICcuL2R0by9yZXNldC1wYXNzd29yZC5kdG8nO1xuaW1wb3J0IHsgVmVyaWZ5VXNlckR0byB9IGZyb20gJy4vZHRvL3ZlcmlmeS11c2VyLmR0byc7XG5pbXBvcnQgeyBVc2VyLCBVc2VyRG9jdW1lbnQgfSBmcm9tICcuL2ludGVyZmFjZXMvdXNlci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgVmVyaWZpY2F0aW9uU3RhdHVzIH0gZnJvbSAnLi4vY29uc3RhbnRzL3ZlcmlmaWNhdGlvbi1zdGF0dXMuZW51bSc7XG5pbXBvcnQge1xuICBidWlsZFByb2ZpbGVTdGF0dXMsXG4gIGlzUHJvZmlsZUNvbXBsZXRlIGFzIGlzUHJvZmlsZUNvbXBsZXRlVXRpbCxcbn0gZnJvbSAnLi9wcm9maWxlLXN0YXR1cy51dGlsJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICdzcmMvbm90aWZpY2F0aW9ucy9ub3RpZmljYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBXYWxsZXRTZXJ2aWNlIH0gZnJvbSAnc3JjL3dhbGxldC93YWxsZXQuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBVc2VyU2VydmljZSB7XG4gIEhPVVJTX1RPX0JMT0NLID0gNjtcbiAgTE9HSU5fQVRURU1QVFNfVE9fQkxPQ0sgPSA1O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3RNb2RlbCgnVXNlcicpIHByaXZhdGUgcmVhZG9ubHkgdXNlck1vZGVsOiBNb2RlbDxVc2VyRG9jdW1lbnQ+LFxuICAgIEBJbmplY3RNb2RlbCgnUmVnaXN0cmF0aW9uJykgcHJpdmF0ZSByZWFkb25seSByZWdpc3RyYXRpb25Nb2RlbDogTW9kZWw8UmVnaXN0cmF0aW9uPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1haWxTZXJ2aWNlOiBNYWlsU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGF1dGhTZXJ2aWNlOiBBdXRoU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0b3JhZ2VTZXJ2aWNlOiBTdG9yYWdlU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZWFkb25seSB3YWxsZXRTZXJ2aWNlOiBXYWxsZXRTZXJ2aWNlLFxuICApIHsgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlZGl0U2lnbnVwUmVmZXJyZXJJZkVsaWdpYmxlKHNhdmVkVXNlcjogVXNlckRvY3VtZW50KSB7XG4gICAgY29uc3QgcmVmZXJyZXJJZCA9IHNhdmVkVXNlcj8ucmVmZXJyZWRCeT8udG9TdHJpbmc/LigpO1xuICAgIGlmICghcmVmZXJyZXJJZCkgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMud2FsbGV0U2VydmljZS5jcmVkaXQoe1xuICAgICAgICB1c2VySWQ6IHJlZmVycmVySWQsXG4gICAgICAgIGFtb3VudDogMTAwLFxuICAgICAgICB0eXBlOiAncmVmZXJyYWxfc2lnbnVwX2NyZWRpdCcsXG4gICAgICAgIHNvdXJjZUlkOiBzYXZlZFVzZXIuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgIHNvdXJjZVR5cGU6ICdyZWZlcnJhbF9zaWdudXAnLFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIHNvdXJjZUlkOiBzYXZlZFVzZXIuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgICAgcmVmZXJyZWRVc2VySWQ6IHNhdmVkVXNlci5faWQudG9TdHJpbmcoKSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlRm9yVXNlcihyZWZlcnJlcklkLCB7XG4gICAgICAgIHRpdGxlOiAnUmVmZXJyYWwgYm9udXMnLFxuICAgICAgICBtZXNzYWdlOiBgWW91IGVhcm5lZCBScy4xMDAgd2FsbGV0IGNyZWRpdCBiZWNhdXNlICR7c2F2ZWRVc2VyLmZ1bGxOYW1lIHx8ICdhIE11c2FmaXInfSBzaWduZWQgdXAgdXNpbmcgeW91ciByZWZlcnJhbCBjb2RlLmAsXG4gICAgICAgIHR5cGU6ICd3YWxsZXQnLFxuICAgICAgICBsaW5rOiAnL3dhbGxldCcsXG4gICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgcmVmZXJyZWRVc2VySWQ6IHNhdmVkVXNlci5faWQudG9TdHJpbmcoKSxcbiAgICAgICAgICBhbW91bnQ6IDEwMCxcbiAgICAgICAgICBraW5kOiAncmVmZXJyYWxfc2lnbnVwX2NyZWRpdCcsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gY3JlZGl0IHNpZ251cCByZWZlcnJhbCBib251czonLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlZGl0VmVyaWZpY2F0aW9uUmVmZXJyZXJzSWZFbGlnaWJsZSh2ZXJpZmllZFVzZXI6IFVzZXJEb2N1bWVudCkge1xuICAgIGNvbnN0IHJlZmVycmFsQ29kZXMgPSAodmVyaWZpZWRVc2VyIGFzIGFueSk/LnZlcmlmaWNhdGlvbj8uUmVmZXJyYWxJRHM7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KHJlZmVycmFsQ29kZXMpIHx8IHJlZmVycmFsQ29kZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVmZXJyZXJzID0gYXdhaXQgdGhpcy51c2VyTW9kZWxcbiAgICAgICAgLmZpbmQoe1xuICAgICAgICAgIHJlZmVycmFsSUQ6IHsgJGluOiByZWZlcnJhbENvZGVzIH0sXG4gICAgICAgICAgJ3ZlcmlmaWNhdGlvbi5zdGF0dXMnOiBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQsXG4gICAgICAgICAgcm9sZXM6IHsgJG5lOiAnYWRtaW4nIH0sXG4gICAgICAgIH0pXG4gICAgICAgIC5zZWxlY3QoJ19pZCBmdWxsTmFtZSByZWZlcnJhbElEJylcbiAgICAgICAgLmxlYW4oKVxuICAgICAgICAuZXhlYygpO1xuXG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChcbiAgICAgICAgcmVmZXJyZXJzLm1hcChhc3luYyAocmVmZXJyZXI6IGFueSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlZmVycmVySWQgPSByZWZlcnJlcj8uX2lkPy50b1N0cmluZz8uKCk7XG4gICAgICAgICAgaWYgKCFyZWZlcnJlcklkKSByZXR1cm47XG4gICAgICAgICAgY29uc3Qgc291cmNlSWQgPSBgJHt2ZXJpZmllZFVzZXIuX2lkLnRvU3RyaW5nKCl9OnZlcmlmaWNhdGlvbjoke3JlZmVycmVySWR9YDtcblxuICAgICAgICAgIGF3YWl0IHRoaXMud2FsbGV0U2VydmljZS5jcmVkaXQoe1xuICAgICAgICAgICAgdXNlcklkOiByZWZlcnJlcklkLFxuICAgICAgICAgICAgYW1vdW50OiAyMDAsXG4gICAgICAgICAgICB0eXBlOiAncmVmZXJyYWxfdmVyaWZpY2F0aW9uX2NyZWRpdCcsXG4gICAgICAgICAgICBzb3VyY2VJZCxcbiAgICAgICAgICAgIHNvdXJjZVR5cGU6ICdyZWZlcnJhbF92ZXJpZmljYXRpb24nLFxuICAgICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgc291cmNlSWQsXG4gICAgICAgICAgICAgIHZlcmlmaWVkVXNlcklkOiB2ZXJpZmllZFVzZXIuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgIHJlZmVycmFsQ29kZTogcmVmZXJyZXIucmVmZXJyYWxJRCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBhd2FpdCB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2UuY3JlYXRlRm9yVXNlcihyZWZlcnJlcklkLCB7XG4gICAgICAgICAgICB0aXRsZTogJ1ZlcmlmaWNhdGlvbiBib251cycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgWW91IGVhcm5lZCBScy4yMDAgd2FsbGV0IGNyZWRpdCBiZWNhdXNlICR7dmVyaWZpZWRVc2VyLmZ1bGxOYW1lIHx8ICdhIE11c2FmaXInfSB3YXMgdmVyaWZpZWQgdXNpbmcgeW91ciByZWZlcnJhbCBjb2RlLmAsXG4gICAgICAgICAgICB0eXBlOiAnd2FsbGV0JyxcbiAgICAgICAgICAgIGxpbms6ICcvd2FsbGV0JyxcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgIHZlcmlmaWVkVXNlcklkOiB2ZXJpZmllZFVzZXIuX2lkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgIGFtb3VudDogMjAwLFxuICAgICAgICAgICAgICBraW5kOiAncmVmZXJyYWxfdmVyaWZpY2F0aW9uX2NyZWRpdCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGNyZWRpdCB2ZXJpZmljYXRpb24gcmVmZXJyYWwgYm9udXNlczonLCBlcnIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGF3YXJkVmVyaWZpY2F0aW9uUmVmZXJyYWxDcmVkaXRzKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRCeUlkKHVzZXJJZCkuZXhlYygpO1xuICAgIGlmICghdXNlcikgcmV0dXJuO1xuICAgIGlmICgodXNlciBhcyBhbnkpPy52ZXJpZmljYXRpb24/LnN0YXR1cyAhPT0gVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVEKSByZXR1cm47XG4gICAgYXdhaXQgdGhpcy5jcmVkaXRWZXJpZmljYXRpb25SZWZlcnJlcnNJZkVsaWdpYmxlKHVzZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Byb2ZpbGVDb21wbGV0ZSh1c2VyOiBQYXJ0aWFsPFVzZXI+KSB7XG4gICAgcmV0dXJuIGlzUHJvZmlsZUNvbXBsZXRlVXRpbCh1c2VyKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UHJvZmlsZVN0YXR1cyh1c2VyOiBQYXJ0aWFsPFVzZXI+KSB7XG4gICAgcmV0dXJuIGJ1aWxkUHJvZmlsZVN0YXR1cyh1c2VyKTtcbiAgfVxuXG4gIHByaXZhdGUgbm9ybWFsaXplVmVyaWZpY2F0aW9uRm9yUmVzcG9uc2UodXNlcjogYW55KSB7XG4gICAgY29uc3QgdmVyaWZpY2F0aW9uID0gdXNlcj8udmVyaWZpY2F0aW9uO1xuICAgIGlmICghdmVyaWZpY2F0aW9uIHx8IHR5cGVvZiB2ZXJpZmljYXRpb24gIT09ICdvYmplY3QnKSByZXR1cm47XG5cbiAgICBpZiAodmVyaWZpY2F0aW9uLlZlcmlmaWNhdGlvbklEICYmICF2ZXJpZmljYXRpb24udmVyaWZpY2F0aW9uSUQpIHtcbiAgICAgIHZlcmlmaWNhdGlvbi52ZXJpZmljYXRpb25JRCA9IHZlcmlmaWNhdGlvbi5WZXJpZmljYXRpb25JRDtcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmVyaWZpY2F0aW9uLlJlZmVycmFsSURzKSAmJiAhdmVyaWZpY2F0aW9uLnJlZmVycmFsSURzKSB7XG4gICAgICB2ZXJpZmljYXRpb24ucmVmZXJyYWxJRHMgPSB2ZXJpZmljYXRpb24uUmVmZXJyYWxJRHM7XG4gICAgfVxuICAgIGlmICh2ZXJpZmljYXRpb24uVmlkZW9MaW5rICYmICF2ZXJpZmljYXRpb24udmlkZW9MaW5rKSB7XG4gICAgICB2ZXJpZmljYXRpb24udmlkZW9MaW5rID0gdmVyaWZpY2F0aW9uLlZpZGVvTGluaztcbiAgICB9XG4gICAgaWYgKHZlcmlmaWNhdGlvbi5WZXJpZmljYXRpb25EYXRlICYmICF2ZXJpZmljYXRpb24udmVyaWZpY2F0aW9uRGF0ZSkge1xuICAgICAgdmVyaWZpY2F0aW9uLnZlcmlmaWNhdGlvbkRhdGUgPSB2ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uRGF0ZTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgdmVyaWZpY2F0aW9uLlZlcmlmaWNhdGlvblJlcXVlc3REYXRlICYmXG4gICAgICAhdmVyaWZpY2F0aW9uLnZlcmlmaWNhdGlvblJlcXVlc3REYXRlXG4gICAgKSB7XG4gICAgICB2ZXJpZmljYXRpb24udmVyaWZpY2F0aW9uUmVxdWVzdERhdGUgPSB2ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uUmVxdWVzdERhdGU7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIHR5cGVvZiB2ZXJpZmljYXRpb24uUmVxdWVzdENhbGwgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICB0eXBlb2YgdmVyaWZpY2F0aW9uLnJlcXVlc3RDYWxsID09PSAndW5kZWZpbmVkJ1xuICAgICkge1xuICAgICAgdmVyaWZpY2F0aW9uLnJlcXVlc3RDYWxsID0gdmVyaWZpY2F0aW9uLlJlcXVlc3RDYWxsO1xuICAgIH1cbiAgfVxuXG4gIGFkZFByb2ZpbGVTdGF0dXModXNlcjogYW55KSB7XG4gICAgY29uc3QgcGxhaW5Vc2VyID1cbiAgICAgIHR5cGVvZiB1c2VyPy50b09iamVjdCA9PT0gJ2Z1bmN0aW9uJyA/IHVzZXIudG9PYmplY3QoKSA6IHVzZXI7XG5cbiAgICB0aGlzLm5vcm1hbGl6ZVZlcmlmaWNhdGlvbkZvclJlc3BvbnNlKHBsYWluVXNlcik7XG4gICAgY29uc3QgcHJvZmlsZVN0YXR1cyA9IHRoaXMuZ2V0UHJvZmlsZVN0YXR1cyhwbGFpblVzZXIpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLihwbGFpblVzZXIgYXMgYW55KSxcbiAgICAgIHByb2ZpbGVDb21wbGV0ZTogdGhpcy5pc1Byb2ZpbGVDb21wbGV0ZShwbGFpblVzZXIpLFxuICAgICAgcHJvZmlsZVN0YXR1cyxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBlbnN1cmVSZWZlcnJhbFBhaXJWYWxpZChcbiAgICBhcHBsaWNhbnQ6IFVzZXJEb2N1bWVudCxcbiAgICByZWZlcnJhbDE/OiBzdHJpbmcsXG4gICAgcmVmZXJyYWwyPzogc3RyaW5nLFxuICApIHtcbiAgICBpZiAoIXJlZmVycmFsMSB8fCAhcmVmZXJyYWwyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVHdvIHJlZmVycmFsIGNvZGVzIGFyZSByZXF1aXJlZC4nKTtcbiAgICB9XG4gICAgaWYgKHJlZmVycmFsMSA9PT0gcmVmZXJyYWwyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignUmVmZXJyYWwgY29kZXMgbXVzdCBiZSBkaWZmZXJlbnQuJyk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGFwcGxpY2FudC5yZWZlcnJhbElEICYmXG4gICAgICAoYXBwbGljYW50LnJlZmVycmFsSUQgPT09IHJlZmVycmFsMSB8fCBhcHBsaWNhbnQucmVmZXJyYWxJRCA9PT0gcmVmZXJyYWwyKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1lvdSBjYW5ub3QgdXNlIHlvdXIgb3duIHJlZmVycmFsIGNvZGUuJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNvbHZlVmVyaWZpZWRSZWZlcnJlcihyZWZlcnJhbElEOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7XG4gICAgICByZWZlcnJhbElELFxuICAgICAgJ3ZlcmlmaWNhdGlvbi5zdGF0dXMnOiBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQsXG4gICAgICByb2xlczogeyAkbmU6ICdhZG1pbicgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYXBwbHlSZWZlcnJhbEF0dHJpYnV0aW9uKFxuICAgIHVzZXI6IFVzZXJEb2N1bWVudCxcbiAgICByZWZlcnJhbENvZGU/OiBzdHJpbmcsXG4gICkge1xuICAgIGlmICghcmVmZXJyYWxDb2RlKSByZXR1cm47XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlZmVycmVyID0gYXdhaXQgdGhpcy5yZXNvbHZlVmVyaWZpZWRSZWZlcnJlcihyZWZlcnJhbENvZGUpO1xuICAgICAgaWYgKHJlZmVycmVyKSB7XG4gICAgICAgIHVzZXIucmVmZXJyZWRCeSA9IHJlZmVycmVyLl9pZCBhcyBhbnk7XG4gICAgICAgIHVzZXIucmVmZXJyZWRDb2RlID0gcmVmZXJyYWxDb2RlO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gc3dhbGxvdyBhdHRyaWJ1dGlvbiBlcnJvcnM7IHNob3VsZCBub3QgYmxvY2sgc2lnbnVwXG4gICAgICBjb25zb2xlLndhcm4oJ1JlZmVycmFsIGF0dHJpYnV0aW9uIGZhaWxlZCcsIGVycik7XG4gICAgfVxuICB9XG5cbiAgLy8gQ3JlYXRlIFVzZXJcbiAgYXN5bmMgY3JlYXRlKFxuICAgIGNyZWF0ZVVzZXJEdG86IGFueSxcbiAgKTogUHJvbWlzZTx7IHVzZXJJZDogYW55OyB2ZXJpZmljYXRpb25JZDogc3RyaW5nIH0+IHtcbiAgICBjcmVhdGVVc2VyRHRvLnBhc3N3b3JkID0gZ2VuZXJhdGVSYW5kb21QYXNzd29yZCgpO1xuICAgIGNvbnN0IHVzZXIgPSBuZXcgdGhpcy51c2VyTW9kZWwoY3JlYXRlVXNlckR0byk7XG4gICAgYXdhaXQgdGhpcy5pc0VtYWlsVW5pcXVlKHVzZXIuZW1haWwpO1xuICAgIGF3YWl0IHRoaXMuYXBwbHlSZWZlcnJhbEF0dHJpYnV0aW9uKHVzZXIgYXMgYW55LCBjcmVhdGVVc2VyRHRvLnJlZmVycmFsQ29kZSB8fCBjcmVhdGVVc2VyRHRvLnJlZik7XG4gICAgdXNlci5yZWZlcnJhbElEID0gZ2VuZXJhdGVVbmlxdWVDb2RlKCk7XG4gICAgdXNlci52ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uSUQgPSB2NCgpO1xuICAgIHVzZXIudmVyaWZpY2F0aW9uLnN0YXR1cyA9IFZlcmlmaWNhdGlvblN0YXR1cy5VTlZFUklGSUVEO1xuICAgIGNvbnN0IHBhc3N3b3JkID0gY3JlYXRlVXNlckR0by5wYXNzd29yZDtcbiAgICBhd2FpdCB0aGlzLm1haWxTZXJ2aWNlLnNlbmRFbWFpbFZlcmlmaWNhdGlvbih1c2VyLmVtYWlsLCBwYXNzd29yZCk7XG4gICAgY29uc3Qgc2F2ZWRVc2VyID0gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgYXdhaXQgdGhpcy5jcmVkaXRTaWdudXBSZWZlcnJlcklmRWxpZ2libGUoc2F2ZWRVc2VyIGFzIGFueSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXJJZDogc2F2ZWRVc2VyLl9pZCxcbiAgICAgIHZlcmlmaWNhdGlvbklkOiAoc2F2ZWRVc2VyLnZlcmlmaWNhdGlvbiBhcyBhbnkpLlZlcmlmaWNhdGlvbklELFxuICAgIH07XG4gIH1cblxuICAvLyBDcmVhdGUgRW1haWwgVXNlclxuICBhc3luYyBjcmVhdGVFbWFpbFVzZXIodXNlckR0bzogRW1haWxVc2VyRHRvLCByZXE6IFJlcXVlc3QpIHtcbiAgICBsZXQgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoeyBlbWFpbDogdXNlckR0by5lbWFpbCB9KTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHVzZXIgPSBuZXcgdGhpcy51c2VyTW9kZWwodXNlckR0byk7XG4gICAgICBhd2FpdCB0aGlzLmlzRW1haWxVbmlxdWUodXNlci5lbWFpbCk7XG4gICAgICBhd2FpdCB0aGlzLmFwcGx5UmVmZXJyYWxBdHRyaWJ1dGlvbih1c2VyIGFzIGFueSwgKHVzZXJEdG8gYXMgYW55KS5yZWZlcnJhbENvZGUgfHwgKHVzZXJEdG8gYXMgYW55KS5yZWYpO1xuICAgICAgdXNlci5yZWZlcnJhbElEID0gZ2VuZXJhdGVVbmlxdWVDb2RlKCk7XG4gICAgICB1c2VyLmVtYWlsVmVyaWZpZWQgPSB0cnVlO1xuICAgICAgdXNlci52ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uSUQgPSB2NCgpO1xuICAgICAgdXNlci52ZXJpZmljYXRpb24uc3RhdHVzID0gVmVyaWZpY2F0aW9uU3RhdHVzLlVOVkVSSUZJRUQ7XG4gICAgICBjb25zdCBzYXZlZCA9IGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgICAgYXdhaXQgdGhpcy5jcmVkaXRTaWdudXBSZWZlcnJlcklmRWxpZ2libGUoc2F2ZWQgYXMgYW55KTtcbiAgICAgIHVzZXIgPSBzYXZlZCBhcyBhbnk7XG4gICAgfVxuICAgIGNvbnN0IHVzZXJXaXRoU3RhdHVzID0gdGhpcy5hZGRQcm9maWxlU3RhdHVzKHVzZXIpO1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyOiB1c2VyV2l0aFN0YXR1cyxcbiAgICAgIGVtYWlsOiB1c2VyV2l0aFN0YXR1cy5lbWFpbCxcbiAgICAgIGFjY2Vzc1Rva2VuOiBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZUFjY2Vzc1Rva2VuKFN0cmluZyh1c2VyLl9pZCkpLFxuICAgICAgcmVmcmVzaFRva2VuOiBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZVJlZnJlc2hUb2tlbihyZXEsIHVzZXIuX2lkKSxcbiAgICB9O1xuICB9XG5cbiAgLy8gQ3JlYXRlIEdvb2dsZSBVc2Vyc1xuICBhc3luYyBjcmVhdGVHb29nbGVVc2VyKHVzZXJEdG86IENyZWF0ZUdvb2dsZVVzZXJEdG8sIHJlcTogUmVxdWVzdCkge1xuICAgIGxldCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7IGVtYWlsOiB1c2VyRHRvLmVtYWlsIH0pO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdXNlciA9IG5ldyB0aGlzLnVzZXJNb2RlbCh1c2VyRHRvKTtcbiAgICAgIGF3YWl0IHRoaXMuaXNFbWFpbFVuaXF1ZSh1c2VyLmVtYWlsKTtcbiAgICAgIGF3YWl0IHRoaXMuYXBwbHlSZWZlcnJhbEF0dHJpYnV0aW9uKHVzZXIgYXMgYW55LCAodXNlckR0byBhcyBhbnkpLnJlZmVycmFsQ29kZSB8fCAodXNlckR0byBhcyBhbnkpLnJlZik7XG4gICAgICB1c2VyLnJlZmVycmFsSUQgPSBnZW5lcmF0ZVVuaXF1ZUNvZGUoKTtcbiAgICAgIHVzZXIuZW1haWxWZXJpZmllZCA9IHRydWU7XG4gICAgICB1c2VyLnZlcmlmaWNhdGlvbi5WZXJpZmljYXRpb25JRCA9IHY0KCk7XG4gICAgICB1c2VyLnZlcmlmaWNhdGlvbi5zdGF0dXMgPSBWZXJpZmljYXRpb25TdGF0dXMuVU5WRVJJRklFRDtcbiAgICAgIGNvbnN0IHNhdmVkID0gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgICBhd2FpdCB0aGlzLmNyZWRpdFNpZ251cFJlZmVycmVySWZFbGlnaWJsZShzYXZlZCBhcyBhbnkpO1xuICAgICAgdXNlciA9IHNhdmVkIGFzIGFueTtcbiAgICB9XG4gICAgY29uc3QgdXNlcldpdGhTdGF0dXMgPSB0aGlzLmFkZFByb2ZpbGVTdGF0dXModXNlcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXI6IHVzZXJXaXRoU3RhdHVzLFxuICAgICAgYWNjZXNzVG9rZW46IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UuY3JlYXRlQWNjZXNzVG9rZW4oU3RyaW5nKHVzZXIuX2lkKSksXG4gICAgICByZWZyZXNoVG9rZW46IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UuY3JlYXRlUmVmcmVzaFRva2VuKHJlcSwgdXNlci5faWQpLFxuICAgIH07XG4gIH1cblxuICAvLyBDcmVhdGUgR29vZ2xlIFVzZXJzXG4gIGFzeW5jIGNyZWF0ZVRva2VuKHVzZXI6IHsgZW1haWw6IHN0cmluZzsgZ29vZ2xlSWQ6IHN0cmluZyB9LCByZXE6IFJlcXVlc3QpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICBhY2Nlc3NUb2tlbjogYXdhaXQgdGhpcy5hdXRoU2VydmljZS5jcmVhdGVBY2Nlc3NUb2tlbihcbiAgICAgICAgU3RyaW5nKHVzZXIuZ29vZ2xlSWQpLFxuICAgICAgKSxcbiAgICB9O1xuICB9XG5cbiAgLy8gVmVyaWZ5IEVtYWlsXG4gIGFzeW5jIHZlcmlmeUVtYWlsKHJlcTogUmVxdWVzdCwgcGFzc3dvcmQ6IHN0cmluZywgdmVyaWZpY2F0aW9uSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmZpbmRCeVZlcmlmaWNhdGlvbih2ZXJpZmljYXRpb25JZCk7XG4gICAgYXdhaXQgdGhpcy5jaGVja1Bhc3N3b3JkKHBhc3N3b3JkLCB1c2VyKTtcbiAgICBhd2FpdCB0aGlzLnNldFVzZXJBc1ZlcmlmaWVkKHVzZXIgYXMgVXNlckRvY3VtZW50KTtcbiAgICAvLyBTZW5kIGFjY291bnQgY3JlYXRlZCBub3RpZmljYXRpb24gYWZ0ZXIgcGFzc3dvcmQgaXMgc2V0IGFuZCBlbWFpbCBpcyB2ZXJpZmllZFxuICAgIGlmICh1c2VyLmVtYWlsICYmIHBhc3N3b3JkKSB7XG4gICAgICBjb25zdCBmaXJzdE5hbWUgPSB1c2VyLmZ1bGxOYW1lPy5zcGxpdCgnICcpWzBdIHx8ICdVc2VyJztcbiAgICAgIGNvbnN0IGxvZ2luVXJsID0gcHJvY2Vzcy5lbnYuRlJPTlRFTkRfVVJMICsgJy9sb2dpbic7XG4gICAgICBhd2FpdCB0aGlzLm1haWxTZXJ2aWNlLnNlbmRBY2NvdW50Q3JlYXRlZEVtYWlsKHVzZXIuZW1haWwsIGZpcnN0TmFtZSwgbG9naW5VcmwpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgZnVsbE5hbWU6IHVzZXIuZnVsbE5hbWUsXG4gICAgICBlbWFpbDogdXNlci5lbWFpbCxcbiAgICAgIGFjY2Vzc1Rva2VuOiBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZUFjY2Vzc1Rva2VuKFN0cmluZyh1c2VyLl9pZCkpLFxuICAgICAgcmVmcmVzaFRva2VuOiBhd2FpdCB0aGlzLmF1dGhTZXJ2aWNlLmNyZWF0ZVJlZnJlc2hUb2tlbihyZXEsIHVzZXIuX2lkKSxcbiAgICB9O1xuICB9XG5cbiAgLy8gTG9naW5cbiAgYXN5bmMgbG9naW4ocmVxOiBSZXF1ZXN0LCBsb2dpblVzZXJEdG86IExvZ2luVXNlckR0bykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmZpbmRVc2VyQnlFbWFpbChsb2dpblVzZXJEdG8uZW1haWwpO1xuICAgIGF3YWl0IHRoaXMuY2hlY2tQYXNzd29yZChsb2dpblVzZXJEdG8ucGFzc3dvcmQsIHVzZXIpO1xuICAgIGNvbnN0IHVzZXJXaXRoU3RhdHVzID0gdGhpcy5hZGRQcm9maWxlU3RhdHVzKHVzZXIpO1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyOiB1c2VyV2l0aFN0YXR1cyxcbiAgICAgIGZ1bGxOYW1lOiB1c2VyLmZ1bGxOYW1lLFxuICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICBhY2Nlc3NUb2tlbjogYXdhaXQgdGhpcy5hdXRoU2VydmljZS5jcmVhdGVBY2Nlc3NUb2tlbihTdHJpbmcodXNlci5faWQpKSxcbiAgICAgIHJlZnJlc2hUb2tlbjogYXdhaXQgdGhpcy5hdXRoU2VydmljZS5jcmVhdGVSZWZyZXNoVG9rZW4ocmVxLCB1c2VyLl9pZCksXG4gICAgfTtcbiAgfVxuXG4gIC8vIEZpbmQgdXNlciBieSBlbWFpbCBvciBwaG9uZVxuICBhc3luYyBmaW5kVXNlckJ5RW1haWxPclBob25lKGVtYWlsT3JQaG9uZTogc3RyaW5nKSB7XG4gICAgY29uc3QgcmF3ID0gKGVtYWlsT3JQaG9uZSB8fCAnJykudHJpbSgpO1xuICAgIGlmICghcmF3KSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignZW1haWxPclBob25lIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNFbWFpbCA9IHJhdy5pbmNsdWRlcygnQCcpO1xuICAgIGNvbnN0IGxvd2VyID0gcmF3LnRvTG93ZXJDYXNlKCk7XG5cbiAgICBjb25zdCBlc2NhcGVSZWdleCA9IChzOiBzdHJpbmcpID0+IHMucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xcXVxcXFxdL2csICdcXFxcJCYnKTtcbiAgICBjb25zdCBkaWdpdHNPbmx5ID0gKHM6IHN0cmluZykgPT4gcy5yZXBsYWNlKC9cXEQvZywgJycpO1xuXG4gICAgbGV0IHVzZXI6IGFueSA9IG51bGw7XG5cbiAgICBpZiAoaXNFbWFpbCkge1xuICAgICAgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoeyBlbWFpbDogbG93ZXIgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIDEpIEV4YWN0IHBob25lIG1hdGNoIGZpcnN0XG4gICAgICB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7IHBob25lOiByYXcgfSk7XG5cbiAgICAgIC8vIDIpIEZhbGxiYWNrOiBtYXRjaCBieSBsYXN0IDcgZGlnaXRzIChlLmcuICs5MjM0NDQyMjU1MDQgPT4gNDIyNTUwNClcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICBjb25zdCBkaWdpdHMgPSBkaWdpdHNPbmx5KHJhdyk7XG4gICAgICAgIGlmIChkaWdpdHMubGVuZ3RoIDwgNykge1xuICAgICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRyeSB0aGUgbW9zdCBzcGVjaWZpYyBzdWZmaXggZmlyc3QgKGVudGlyZSBkaWdpdHMgc3RyaW5nKSwgdGhlbiBsYXN0IDcuXG4gICAgICAgIGNvbnN0IHN1ZmZpeGVzID0gZGlnaXRzLmxlbmd0aCA+IDcgPyBbZGlnaXRzLCBkaWdpdHMuc2xpY2UoLTcpXSA6IFtkaWdpdHNdO1xuXG4gICAgICAgIGZvciAoY29uc3Qgc3VmZml4IG9mIHN1ZmZpeGVzKSB7XG4gICAgICAgICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKGAke2VzY2FwZVJlZ2V4KHN1ZmZpeCl9JGApO1xuICAgICAgICAgIGNvbnN0IG1hdGNoZXMgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbFxuICAgICAgICAgICAgLmZpbmQoeyBwaG9uZTogeyAkcmVnZXg6IHJlIH0gfSlcbiAgICAgICAgICAgIC5saW1pdCg1KVxuICAgICAgICAgICAgLmV4ZWMoKTtcblxuICAgICAgICAgIGlmIChtYXRjaGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgdXNlciA9IG1hdGNoZXNbMF07XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKG1hdGNoZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKFxuICAgICAgICAgICAgICAnTXVsdGlwbGUgdXNlcnMgbWF0Y2hlZCB0aGlzIHBob25lIG51bWJlci4gUGxlYXNlIGVudGVyIGZ1bGwgcGhvbmUgbnVtYmVyIG9yIGVtYWlsLicsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaGFzIHBhc3N3b3JkIChleGlzdGluZyB1c2VyKVxuICAgIGlmICh1c2VyLnBhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oJ0FjY291bnQgYWxyZWFkeSBleGlzdHMuIFBsZWFzZSBsb2dpbi4nKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgdXNlcidzIHJlZ2lzdHJhdGlvbnMgdG8gZmluZCB0cmlwc1xuICAgIGNvbnN0IHJlZ2lzdHJhdGlvbnMgPSBhd2FpdCB0aGlzLnJlZ2lzdHJhdGlvbk1vZGVsLmZpbmQoeyB1c2VySWQ6IHVzZXIuX2lkIH0pXG4gICAgICAucG9wdWxhdGUoJ2ZsYWdzaGlwSWQnLCAndHJpcE5hbWUnKVxuICAgICAgLmV4ZWMoKTtcblxuICAgIGNvbnN0IHRyaXBzID0gcmVnaXN0cmF0aW9uc1xuICAgICAgLm1hcChyZWcgPT4ge1xuICAgICAgICBjb25zdCBmbGFnc2hpcCA9IHJlZy5mbGFnc2hpcElkIGFzIGFueTtcbiAgICAgICAgcmV0dXJuIGZsYWdzaGlwPy50cmlwTmFtZTtcbiAgICAgIH0pXG4gICAgICAuZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVzZXI6IHtcbiAgICAgICAgX2lkOiB1c2VyLl9pZCxcbiAgICAgICAgZnVsbE5hbWU6IHVzZXIuZnVsbE5hbWUsXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICBwaG9uZTogdXNlci5waG9uZSxcbiAgICAgICAgY2l0eTogdXNlci5jaXR5IHx8ICdVbmtub3duJ1xuICAgICAgfSxcbiAgICAgIHRyaXBzXG4gICAgfTtcbiAgfVxuXG4gIC8vIFZlcmlmeSBtdXNhZmlyIGVtYWlsIGFuZCBnZW5lcmF0ZSBwYXNzd29yZFxuICBhc3luYyB2ZXJpZnlNdXNhZmlyRW1haWwoZW1haWw6IHN0cmluZywgdXBkYXRlRXhpc3Rpbmc/OiBib29sZWFuLCB1c2VySWQ/OiBzdHJpbmcpIHtcbiAgICBsZXQgdXNlcjtcblxuICAgIGlmICh1cGRhdGVFeGlzdGluZyAmJiB1c2VySWQpIHtcbiAgICAgIC8vIFVwZGF0ZSBleGlzdGluZyB1c2VyJ3MgZW1haWxcbiAgICAgIHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kQnlJZCh1c2VySWQpO1xuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdGhlIG5ldyBlbWFpbCBpcyBhbHJlYWR5IHRha2VuIGJ5IGFub3RoZXIgdXNlclxuICAgICAgY29uc3QgZXhpc3RpbmdVc2VyV2l0aEVtYWlsID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7XG4gICAgICAgIGVtYWlsOiBlbWFpbC50b0xvd2VyQ2FzZSgpLFxuICAgICAgICBfaWQ6IHsgJG5lOiB1c2VySWQgfSAvLyBFeGNsdWRlIGN1cnJlbnQgdXNlclxuICAgICAgfSk7XG5cbiAgICAgIGlmIChleGlzdGluZ1VzZXJXaXRoRW1haWwpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKCdFbWFpbCBpcyBhbHJlYWR5IHRha2VuIGJ5IGFub3RoZXIgdXNlcicpO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdGhlIHVzZXIncyBlbWFpbFxuICAgICAgdXNlci5lbWFpbCA9IGVtYWlsLnRvTG93ZXJDYXNlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEZpbmQgZXhpc3RpbmcgdXNlclxuICAgICAgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoeyBlbWFpbDogZW1haWwudG9Mb3dlckNhc2UoKSB9KTtcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgdXNlciBhbHJlYWR5IGhhcyBwYXNzd29yZFxuICAgICAgaWYgKHVzZXIucGFzc3dvcmQpIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbmZsaWN0RXhjZXB0aW9uKCdBY2NvdW50IGFscmVhZHkgZXhpc3RzLiBQbGVhc2UgbG9naW4uJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgbmV3IHBhc3N3b3JkXG4gICAgY29uc3QgbmV3UGFzc3dvcmQgPSBnZW5lcmF0ZVJhbmRvbVBhc3N3b3JkKCk7XG4gICAgdXNlci5wYXNzd29yZCA9IG5ld1Bhc3N3b3JkO1xuICAgIHVzZXIuZW1haWxWZXJpZmllZCA9IHRydWU7XG4gICAgLy8gUHJlc2VydmUgZXhpc3RpbmcgdmVyaWZpY2F0aW9uIHN0YXR1czsgZG8gbm90IGF1dG8tdmVyaWZ5IG9uIGVtYWlsIGNvbmZpcm1cbiAgICBpZiAoIXVzZXIudmVyaWZpY2F0aW9uPy5zdGF0dXMpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uID0gdXNlci52ZXJpZmljYXRpb24gfHwge307XG4gICAgICB1c2VyLnZlcmlmaWNhdGlvbi5zdGF0dXMgPSBWZXJpZmljYXRpb25TdGF0dXMuVU5WRVJJRklFRDtcbiAgICB9XG5cbiAgICBhd2FpdCB1c2VyLnNhdmUoKTtcblxuICAgIC8vIFNlbmQgZW1haWwgd2l0aCBwYXNzd29yZFxuICAgIGF3YWl0IHRoaXMubWFpbFNlcnZpY2Uuc2VuZEVtYWlsVmVyaWZpY2F0aW9uKHVzZXIuZW1haWwsIG5ld1Bhc3N3b3JkKTtcblxuICAgIHJldHVybiB7XG4gICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgc2VudCB0byB5b3VyIGVtYWlsJyxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsXG4gICAgfTtcbiAgfVxuXG4gIC8vIFJlZnJlc2ggQWNjZXNzIFRva2VuXG4gIGFzeW5jIHJlZnJlc2hBY2Nlc3NUb2tlbihyZWZyZXNoQWNjZXNzVG9rZW5EdG86IFJlZnJlc2hBY2Nlc3NUb2tlbkR0bykge1xuICAgIGNvbnN0IHVzZXJJZCA9IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UuZmluZFJlZnJlc2hUb2tlbihcbiAgICAgIHJlZnJlc2hBY2Nlc3NUb2tlbkR0by5yZWZyZXNoVG9rZW4sXG4gICAgKTtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZEJ5SWQodXNlcklkKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdCYWQgcmVxdWVzdCcpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgYWNjZXNzVG9rZW46IGF3YWl0IHRoaXMuYXV0aFNlcnZpY2UuY3JlYXRlQWNjZXNzVG9rZW4oU3RyaW5nKHVzZXIuX2lkKSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIEZvcmdldCBQYXNzd29yZFxuICBhc3luYyBmb3Jnb3RQYXNzd29yZChcbiAgICByZXE6IFJlcXVlc3QsXG4gICAgY3JlYXRlRm9yZ290UGFzc3dvcmREdG86IENyZWF0ZUZvcmdvdFBhc3N3b3JkRHRvLFxuICApIHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy5maW5kQnlFbWFpbChjcmVhdGVGb3Jnb3RQYXNzd29yZER0by5lbWFpbCk7XG5cbiAgICAvLyBHZW5lcmF0ZSBKV1QgdG9rZW4gd2l0aCAxNSBtaW51dGVzIGV4cGlyeVxuICAgIGNvbnN0IHJlc2V0VG9rZW4gPSBqd3Quc2lnbihcbiAgICAgIHtcbiAgICAgICAgdXNlcklkOiB1c2VyLl9pZCxcbiAgICAgICAgZW1haWw6IHVzZXIuZW1haWwsXG4gICAgICAgIHR5cGU6ICdwYXNzd29yZF9yZXNldCcsXG4gICAgICB9LFxuICAgICAgcHJvY2Vzcy5lbnYuSldUX1NFQ1JFVCxcbiAgICAgIHsgZXhwaXJlc0luOiAnMTVtJyB9LFxuICAgICk7XG5cbiAgICAvLyBDcmVhdGUgcmVzZXQgbGluayB3aXRoIGZyb250ZW5kIFVSTFxuICAgIGNvbnN0IHJlc2V0TGluayA9IGAke3Byb2Nlc3MuZW52LkZST05URU5EX1VSTH0vcmVzZXQtcGFzc3dvcmQ/dG9rZW49JHtyZXNldFRva2VufWA7XG5cbiAgICAvLyBTZW5kIGVtYWlsIHdpdGggcmVzZXQgbGlua1xuICAgIGF3YWl0IHRoaXMubWFpbFNlcnZpY2Uuc2VuZFBhc3N3b3JkUmVzZXRFbWFpbChcbiAgICAgIHVzZXIuZW1haWwsXG4gICAgICByZXNldExpbmssXG4gICAgICB1c2VyLmZ1bGxOYW1lIHx8ICdVc2VyJyxcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGVtYWlsOiBjcmVhdGVGb3Jnb3RQYXNzd29yZER0by5lbWFpbCxcbiAgICAgIG1lc3NhZ2U6ICdQYXNzd29yZCByZXNldCBsaW5rIHNlbnQgdG8geW91ciBlbWFpbC4nLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBmaW5kQnlSZWZlcnJhbElkKHJlZmZlcmFsOiBzdHJpbmcpOiBQcm9taXNlPFVzZXI+IHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7XG4gICAgICByZWZlcnJhbElEOiByZWZmZXJhbCxcbiAgICAgICd2ZXJpZmljYXRpb24uc3RhdHVzJzogVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVELFxuICAgIH0pO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0JhZCByZXF1ZXN0LicpO1xuICAgIH1cbiAgICByZXR1cm4gdXNlcjtcbiAgfVxuXG4gIGFzeW5jIHZlcmlmeVdpdGhSZWZlcnJhbHMoYXBwbGljYW50SWQ6IHN0cmluZywgdmVyaWZ5VXNlcjogVmVyaWZ5VXNlckR0bykge1xuICAgIGNvbnN0IGFwcGxpY2FudCA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRCeUlkKGFwcGxpY2FudElkKTtcbiAgICBpZiAoIWFwcGxpY2FudCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0FwcGxpY2FudCBub3QgZm91bmQuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgeyByZWZlcnJhbDEsIHJlZmVycmFsMiB9ID0gdmVyaWZ5VXNlcjtcbiAgICB0aGlzLmVuc3VyZVJlZmVycmFsUGFpclZhbGlkKGFwcGxpY2FudCwgcmVmZXJyYWwxLCByZWZlcnJhbDIpO1xuXG4gICAgY29uc3QgW3VzZXIxLCB1c2VyMl0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnJlc29sdmVWZXJpZmllZFJlZmVycmVyKHJlZmVycmFsMSksXG4gICAgICB0aGlzLnJlc29sdmVWZXJpZmllZFJlZmVycmVyKHJlZmVycmFsMiksXG4gICAgXSk7XG5cbiAgICBpZiAoIXVzZXIxIHx8ICF1c2VyMikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdSZWZlcnJhbCBjb2RlcyBtdXN0IGJlbG9uZyB0byB2ZXJpZmllZCB1c2Vycy4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAodXNlcjEuX2lkLmVxdWFscyh1c2VyMi5faWQpKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ1JlZmVycmFsIGNvZGVzIG11c3QgY29tZSBmcm9tIHR3byBkaWZmZXJlbnQgdXNlcnMuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHVzZXIxLl9pZC5lcXVhbHMoYXBwbGljYW50Ll9pZCkgfHwgdXNlcjIuX2lkLmVxdWFscyhhcHBsaWNhbnQuX2lkKSkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1lvdSBjYW5ub3QgdmVyaWZ5IHlvdXJzZWxmLicpO1xuICAgIH1cblxuICAgIGNvbnN0IGdlbmRlcnMgPSBbdXNlcjEuZ2VuZGVyLCB1c2VyMi5nZW5kZXJdO1xuICAgIGNvbnN0IGhhc01hbGUgPSBnZW5kZXJzLmluY2x1ZGVzKCdtYWxlJyk7XG4gICAgY29uc3QgaGFzRmVtYWxlID0gZ2VuZGVycy5pbmNsdWRlcygnZmVtYWxlJyk7XG4gICAgaWYgKCFoYXNNYWxlIHx8ICFoYXNGZW1hbGUpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAnUmVmZXJyYWwgY29kZXMgbXVzdCBpbmNsdWRlIGF0IGxlYXN0IG9uZSBtYWxlIGFuZCBvbmUgZmVtYWxlIHZlcmlmaWVkIE11c2FmaXIuJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgc2F2ZWQgPSBhd2FpdCB0aGlzLnNldFVzZXJWZXJpZmllZChhcHBsaWNhbnRJZCwgdmVyaWZ5VXNlciwge1xuICAgICAgbWV0aG9kOiAncmVmZXJyYWwnLFxuICAgICAgZmxhZ3NoaXBJZDogdmVyaWZ5VXNlci5mbGFnc2hpcElkLFxuICAgIH0pO1xuXG4gICAgLy8gTm90aWZ5IHJlZmVycmVycyB0aGVpciBjb2RlIHdhcyB1c2VkIHN1Y2Nlc3NmdWxseVxuICAgIGNvbnN0IHJlZmVycmVySWRzID0gW3VzZXIxLl9pZD8udG9TdHJpbmcoKSwgdXNlcjIuX2lkPy50b1N0cmluZygpXS5maWx0ZXIoQm9vbGVhbikgYXMgc3RyaW5nW107XG4gICAgaWYgKHJlZmVycmVySWRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5jcmVhdGVGb3JVc2VycyhyZWZlcnJlcklkcywge1xuICAgICAgICB0aXRsZTogJ1lvdXIgcmVmZXJyYWwgdmVyaWZpZWQgYSBNdXNhZmlyJyxcbiAgICAgICAgbWVzc2FnZTogYCR7YXBwbGljYW50LmZ1bGxOYW1lIHx8ICdBIE11c2FmaXInfSBoYXMgYmVlbiB2ZXJpZmllZCB1c2luZyB5b3VyIHJlZmVycmFsIGNvZGUke3ZlcmlmeVVzZXIuZmxhZ3NoaXBJZCA/IGAgZm9yIGZsYWdzaGlwICR7dmVyaWZ5VXNlci5mbGFnc2hpcElkfWAgOiAnJ30uYCxcbiAgICAgICAgdHlwZTogJ3JlZmVycmFsJyxcbiAgICAgICAgbGluazogJy9yZWZlcnJhbHMnLFxuICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgIGFwcGxpY2FudElkOiBhcHBsaWNhbnQuX2lkPy50b1N0cmluZygpLFxuICAgICAgICAgIGZsYWdzaGlwSWQ6IHZlcmlmeVVzZXIuZmxhZ3NoaXBJZCxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBzYXZlZDtcbiAgfVxuXG4gIC8vIFJlc2V0IFBhc3N3b3JkXG4gIGFzeW5jIHJlc2V0UGFzc3dvcmQocmVzZXRQYXNzd29yZER0bzogUmVzZXRQYXNzd29yZER0bykge1xuICAgIC8vIEZpbmQgdGhlIHVzZXJcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZE9uZSh7XG4gICAgICBlbWFpbDogcmVzZXRQYXNzd29yZER0by5lbWFpbCxcbiAgICAgIGVtYWlsVmVyaWZpZWQ6IHRydWUsXG4gICAgfSk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQgb3Igbm90IHZlcmlmaWVkLicpO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHByZXZpb3VzIHBhc3N3b3JkXG4gICAgY29uc3QgaXNQcmV2UGFzc3dvcmRDb3JyZWN0ID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUoXG4gICAgICByZXNldFBhc3N3b3JkRHRvLnByZXZpb3VzUGFzc3dvcmQsXG4gICAgICB1c2VyLnBhc3N3b3JkLFxuICAgICk7XG4gICAgaWYgKCFpc1ByZXZQYXNzd29yZENvcnJlY3QpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdQcmV2aW91cyBwYXNzd29yZCBpcyBpbmNvcnJlY3QuJyk7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgbmV3IHBhc3N3b3JkIGFuZCBjb25maXJtIHBhc3N3b3JkIG1hdGNoXG4gICAgaWYgKHJlc2V0UGFzc3dvcmREdG8ucGFzc3dvcmQgIT09IHJlc2V0UGFzc3dvcmREdG8uY29uZmlybVBhc3N3b3JkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ05ldyBwYXNzd29yZCBhbmQgY29uZmlybSBwYXNzd29yZCBkbyBub3QgbWF0Y2guJyxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gUHJldmVudCByZXVzaW5nIHRoZSBzYW1lIHBhc3N3b3JkXG4gICAgY29uc3QgaXNTYW1lQXNPbGQgPSBhd2FpdCBiY3J5cHQuY29tcGFyZShcbiAgICAgIHJlc2V0UGFzc3dvcmREdG8ucGFzc3dvcmQsXG4gICAgICB1c2VyLnBhc3N3b3JkLFxuICAgICk7XG4gICAgaWYgKGlzU2FtZUFzT2xkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgJ05ldyBwYXNzd29yZCBtdXN0IGJlIGRpZmZlcmVudCBmcm9tIHRoZSBwcmV2aW91cyBwYXNzd29yZC4nLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnJlc2V0VXNlclBhc3N3b3JkKHVzZXIsIHJlc2V0UGFzc3dvcmREdG8ucGFzc3dvcmQpO1xuICAgIHJldHVybiB7XG4gICAgICBlbWFpbDogcmVzZXRQYXNzd29yZER0by5lbWFpbCxcbiAgICAgIG1lc3NhZ2U6ICdwYXNzd29yZCBzdWNjZXNzZnVsbHkgY2hhbmdlZC4nLFxuICAgIH07XG4gIH1cblxuICAvLyBKV1QtYmFzZWQgUmVzZXQgUGFzc3dvcmRcbiAgYXN5bmMgcmVzZXRQYXNzd29yZFdpdGhKd3QoXG4gICAgdG9rZW46IHN0cmluZyxcbiAgICBqd3RSZXNldFBhc3N3b3JkRHRvOiBKd3RSZXNldFBhc3N3b3JkRHRvLFxuICApIHtcbiAgICB0cnkge1xuICAgICAgLy8gVmVyaWZ5IEpXVCB0b2tlblxuICAgICAgY29uc3QgZGVjb2RlZCA9IGp3dC52ZXJpZnkodG9rZW4sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQpIGFzIGFueTtcblxuICAgICAgaWYgKGRlY29kZWQudHlwZSAhPT0gJ3Bhc3N3b3JkX3Jlc2V0Jykge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignSW52YWxpZCB0b2tlbiB0eXBlLicpO1xuICAgICAgfVxuXG4gICAgICAvLyBGaW5kIHVzZXJcbiAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kQnlJZChkZWNvZGVkLnVzZXJJZCk7XG4gICAgICBpZiAoIXVzZXIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kLicpO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiBwYXNzd29yZHMgbWF0Y2hcbiAgICAgIGlmIChcbiAgICAgICAgand0UmVzZXRQYXNzd29yZER0by5wYXNzd29yZCAhPT0gand0UmVzZXRQYXNzd29yZER0by5jb25maXJtUGFzc3dvcmRcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbihcbiAgICAgICAgICAnTmV3IHBhc3N3b3JkIGFuZCBjb25maXJtIHBhc3N3b3JkIGRvIG5vdCBtYXRjaC4nLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgcGFzc3dvcmRcbiAgICAgIGF3YWl0IHRoaXMucmVzZXRVc2VyUGFzc3dvcmQodXNlciwgand0UmVzZXRQYXNzd29yZER0by5wYXNzd29yZCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgICBtZXNzYWdlOiAnUGFzc3dvcmQgc3VjY2Vzc2Z1bGx5IGNoYW5nZWQuJyxcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvci5uYW1lID09PSAnVG9rZW5FeHBpcmVkRXJyb3InKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKFxuICAgICAgICAgICdSZXNldCBsaW5rIGhhcyBleHBpcmVkLiBQbGVhc2UgcmVxdWVzdCBhIG5ldyBvbmUuJyxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IubmFtZSA9PT0gJ0pzb25XZWJUb2tlbkVycm9yJykge1xuICAgICAgICB0aHJvdyBuZXcgQmFkUmVxdWVzdEV4Y2VwdGlvbignSW52YWxpZCByZXNldCBsaW5rLicpO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2V0VXNlclZlcmlmaWVkKFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdmVyaWZ5VXNlcjogVmVyaWZ5VXNlckR0byxcbiAgICBvcHRpb25zPzogeyBtZXRob2Q/OiBzdHJpbmc7IGZsYWdzaGlwSWQ/OiBzdHJpbmcgfSxcbiAgKSB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRCeUlkKGlkKTtcbiAgICBpZiAodmVyaWZ5VXNlci5yZWZlcnJhbDEgJiYgdmVyaWZ5VXNlci5yZWZlcnJhbDIpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLlJlZmVycmFsSURzID0gW1xuICAgICAgICB2ZXJpZnlVc2VyLnJlZmVycmFsMSxcbiAgICAgICAgdmVyaWZ5VXNlci5yZWZlcnJhbDIsXG4gICAgICBdO1xuICAgIH1cbiAgICB1c2VyLnZlcmlmaWNhdGlvbi5zdGF0dXMgPSBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQ7XG4gICAgdXNlci52ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgaWYgKG9wdGlvbnM/Lm1ldGhvZCkge1xuICAgICAgdXNlci52ZXJpZmljYXRpb24ubWV0aG9kID0gb3B0aW9ucy5tZXRob2Q7XG4gICAgfVxuICAgIGlmICh2ZXJpZnlVc2VyLmZsYWdzaGlwSWQgfHwgb3B0aW9ucz8uZmxhZ3NoaXBJZCkge1xuICAgICAgdXNlci52ZXJpZmljYXRpb24uZmxhZ3NoaXBJZCA9IG9wdGlvbnM/LmZsYWdzaGlwSWQgfHwgdmVyaWZ5VXNlci5mbGFnc2hpcElkO1xuICAgIH1cbiAgICB1c2VyLm1hcmtNb2RpZmllZCgndmVyaWZpY2F0aW9uJyk7XG4gICAgY29uc3Qgc2F2ZWRVc2VyID0gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgYXdhaXQgdGhpcy5jcmVkaXRWZXJpZmljYXRpb25SZWZlcnJlcnNJZkVsaWdpYmxlKHNhdmVkVXNlciBhcyBhbnkpO1xuXG4gICAgLy8gU2VuZCB2ZXJpZmljYXRpb24gYXBwcm92ZWQgZW1haWwgaWYgdXNlciBoYXMgYW4gZW1haWxcbiAgICBpZiAodXNlci5lbWFpbCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5tYWlsU2VydmljZS5zZW5kVmVyaWZpY2F0aW9uQXBwcm92ZWRFbWFpbChcbiAgICAgICAgICB1c2VyLmVtYWlsLFxuICAgICAgICAgIHVzZXIuZnVsbE5hbWUgfHwgJ011c2FmaXInXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIHNlbmQgdmVyaWZpY2F0aW9uIGFwcHJvdmVkIGVtYWlsOicsIGVycm9yKTtcbiAgICAgICAgLy8gRG9uJ3QgdGhyb3cgZXJyb3IgLSBlbWFpbCBmYWlsdXJlIHNob3VsZG4ndCBwcmV2ZW50IHVzZXIgdmVyaWZpY2F0aW9uXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNhdmVkVXNlcjtcbiAgfVxuXG4gIGFzeW5jIHJlcXVlc3RWZXJpZmljYXRpb24oaWQ6IHN0cmluZywgdmVyaWZ5VXNlcjogVmVyaWZ5VXNlckR0bykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kQnlJZChpZCk7XG4gICAgbGV0IG1ldGhvZDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGlmICh2ZXJpZnlVc2VyLnJlcXVlc3RDYWxsID09PSAndHJ1ZScpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLlJlcXVlc3RDYWxsID0gdHJ1ZTtcbiAgICAgIG1ldGhvZCA9ICdjYWxsJztcbiAgICB9XG4gICAgaWYgKHZlcmlmeVVzZXIudmlkZW9VcmwpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLlZpZGVvTGluayA9IHZlcmlmeVVzZXIudmlkZW9Vcmw7XG4gICAgICBtZXRob2QgPSBtZXRob2QgfHwgJ3ZpZGVvJztcbiAgICB9XG4gICAgaWYgKHZlcmlmeVVzZXIuZmxhZ3NoaXBJZCkge1xuICAgICAgdXNlci52ZXJpZmljYXRpb24uZmxhZ3NoaXBJZCA9IHZlcmlmeVVzZXIuZmxhZ3NoaXBJZDtcbiAgICB9XG4gICAgdXNlci52ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uUmVxdWVzdERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIHVzZXIudmVyaWZpY2F0aW9uLnN0YXR1cyA9IFZlcmlmaWNhdGlvblN0YXR1cy5QRU5ESU5HO1xuICAgIGlmIChtZXRob2QpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLm1ldGhvZCA9IG1ldGhvZDtcbiAgICB9XG4gICAgdXNlci5tYXJrTW9kaWZpZWQoJ3ZlcmlmaWNhdGlvbicpO1xuICAgIGNvbnN0IHNhdmVkID0gYXdhaXQgdXNlci5zYXZlKCk7XG5cbiAgICBpZiAodmVyaWZ5VXNlci5yZXF1ZXN0Q2FsbCA9PT0gJ3RydWUnKSB7XG4gICAgICBhd2FpdCB0aGlzLm5vdGlmeUNvbW11bml0eUxlYWRzQWJvdXRDYWxsKHNhdmVkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2F2ZWQ7XG4gIH1cblxuICBmaW5kQWxsKCk6IGFueSB7XG4gICAgcmV0dXJuIHsgaGVsbG86ICd3b3JsZCcgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJEYXRhKHVzZXI6IFVzZXIpOiBQcm9taXNlPFVzZXI+IHtcbiAgICBjb25zdCB2ZXJpZmllZEJ5TWUgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5jb3VudERvY3VtZW50cyh7XG4gICAgICAndmVyaWZpY2F0aW9uLnN0YXR1cyc6IFZlcmlmaWNhdGlvblN0YXR1cy5WRVJJRklFRCxcbiAgICAgICd2ZXJpZmljYXRpb24uUmVmZXJyYWxJRHMnOiB1c2VyLnJlZmVycmFsSUQsXG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyV2l0aFN0YXR1cyA9IHRoaXMuYWRkUHJvZmlsZVN0YXR1cyh1c2VyKTtcblxuICAgIHJldHVybiB7XG4gICAgICAuLi4odXNlcldpdGhTdGF0dXMgYXMgYW55KSxcbiAgICAgIHZlcmlmaWNhdGlvblN0YXRzOiB7IHZlcmlmaWVkQnlNZSB9LFxuICAgIH07XG4gIH1cblxuICBhc3luYyB1bnZlcmlmaWVkVXNlcnMoc2VhcmNoPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcXVlcnk6IGFueSA9IHtcbiAgICAgICd2ZXJpZmljYXRpb24uc3RhdHVzJzogVmVyaWZpY2F0aW9uU3RhdHVzLlVOVkVSSUZJRUQsXG4gICAgICByb2xlczogeyAkbmU6ICdhZG1pbicgfSxcbiAgICB9O1xuXG4gICAgaWYgKHNlYXJjaCkge1xuICAgICAgY29uc3QgZXNjYXBlZFNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKC9bLiorP14ke30oKXxbXFxdXFxcXF0vZywgJ1xcXFwkJicpO1xuICAgICAgcXVlcnkuJG9yID0gW1xuICAgICAgICB7IGZ1bGxOYW1lOiB7ICRyZWdleDogZXNjYXBlZFNlYXJjaCwgJG9wdGlvbnM6ICdpJyB9IH0sXG4gICAgICAgIHsgZW1haWw6IHsgJHJlZ2V4OiBlc2NhcGVkU2VhcmNoLCAkb3B0aW9uczogJ2knIH0gfSxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcnMgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbFxuICAgICAgLmZpbmQocXVlcnkpXG4gICAgICAuc2VsZWN0KCctcGFzc3dvcmQgLV9fdicpXG4gICAgICAubGVhbigpO1xuICAgIHJldHVybiB1c2VycztcbiAgfVxuXG4gIGFzeW5jIHZlcmlmaWVkVXNlcnMoc2VhcmNoPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcXVlcnk6IGFueSA9IHtcbiAgICAgICd2ZXJpZmljYXRpb24uc3RhdHVzJzogVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVELFxuICAgICAgcm9sZXM6IHsgJG5lOiAnYWRtaW4nIH0sXG4gICAgfTtcblxuICAgIGlmIChzZWFyY2gpIHtcbiAgICAgIGNvbnN0IGVzY2FwZWRTZWFyY2ggPSBzZWFyY2gucmVwbGFjZSgvWy4qKz9eJHt9KCl8W1xcXVxcXFxdL2csICdcXFxcJCYnKTtcbiAgICAgIHF1ZXJ5LiRvciA9IFtcbiAgICAgICAgeyBmdWxsTmFtZTogeyAkcmVnZXg6IGVzY2FwZWRTZWFyY2gsICRvcHRpb25zOiAnaScgfSB9LFxuICAgICAgICB7IGVtYWlsOiB7ICRyZWdleDogZXNjYXBlZFNlYXJjaCwgJG9wdGlvbnM6ICdpJyB9IH0sXG4gICAgICBdO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgdGhpcy51c2VyTW9kZWxcbiAgICAgIC5maW5kKHF1ZXJ5KVxuICAgICAgLnNlbGVjdCgnLXBhc3N3b3JkIC1fX3YnKVxuICAgICAgLmxlYW4oKTtcbiAgICByZXR1cm4gdXNlcnM7XG4gIH1cblxuICBhc3luYyBwZW5kaW5nVmVyaWZpY2F0aW9uVXNlcnMoc2VhcmNoPzogc3RyaW5nKSB7XG4gICAgY29uc3QgcXVlcnk6IGFueSA9IHtcbiAgICAgICd2ZXJpZmljYXRpb24uc3RhdHVzJzogVmVyaWZpY2F0aW9uU3RhdHVzLlBFTkRJTkcsXG4gICAgICByb2xlczogeyAkbmU6ICdhZG1pbicgfSxcbiAgICB9O1xuXG4gICAgaWYgKHNlYXJjaCkge1xuICAgICAgY29uc3QgZXNjYXBlZFNlYXJjaCA9IHNlYXJjaC5yZXBsYWNlKC9bLiorP14ke30oKXxbXFxdXFxcXF0vZywgJ1xcXFwkJicpO1xuICAgICAgcXVlcnkuJG9yID0gW1xuICAgICAgICB7IGZ1bGxOYW1lOiB7ICRyZWdleDogZXNjYXBlZFNlYXJjaCwgJG9wdGlvbnM6ICdpJyB9IH0sXG4gICAgICAgIHsgZW1haWw6IHsgJHJlZ2V4OiBlc2NhcGVkU2VhcmNoLCAkb3B0aW9uczogJ2knIH0gfSxcbiAgICAgIF07XG4gICAgfVxuXG4gICAgY29uc3QgdXNlcnMgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbFxuICAgICAgLmZpbmQocXVlcnkpXG4gICAgICAuc2VsZWN0KCctcGFzc3dvcmQgLV9fdicpXG4gICAgICAubGVhbigpO1xuICAgIHJldHVybiB1c2VycztcbiAgfVxuXG4gIGFzeW5jIHNlYXJjaEFsbFVzZXJzKHNlYXJjaDogc3RyaW5nKSB7XG4gICAgaWYgKCFzZWFyY2gpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHVudmVyaWZpZWQ6IFtdLFxuICAgICAgICBwZW5kaW5nVmVyaWZpY2F0aW9uOiBbXSxcbiAgICAgICAgdmVyaWZpZWQ6IFtdLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBlc2NhcGVkU2VhcmNoID0gc2VhcmNoLnJlcGxhY2UoL1suKis/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7XG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICByb2xlczogeyAkbmU6ICdhZG1pbicgfSxcbiAgICAgICRvcjogW1xuICAgICAgICB7IGZ1bGxOYW1lOiB7ICRyZWdleDogZXNjYXBlZFNlYXJjaCwgJG9wdGlvbnM6ICdpJyB9IH0sXG4gICAgICAgIHsgZW1haWw6IHsgJHJlZ2V4OiBlc2NhcGVkU2VhcmNoLCAkb3B0aW9uczogJ2knIH0gfSxcbiAgICAgIF0sXG4gICAgfTtcblxuICAgIGNvbnN0IGFsbFVzZXJzID0gYXdhaXQgdGhpcy51c2VyTW9kZWxcbiAgICAgIC5maW5kKHF1ZXJ5KVxuICAgICAgLnNlbGVjdCgnLXBhc3N3b3JkIC1fX3YnKVxuICAgICAgLmxlYW4oKTtcblxuICAgIGNvbnN0IGdyb3VwZWRVc2VycyA9IHtcbiAgICAgIHVudmVyaWZpZWQ6IGFsbFVzZXJzLmZpbHRlcih1c2VyID0+IHVzZXIudmVyaWZpY2F0aW9uLnN0YXR1cyA9PT0gVmVyaWZpY2F0aW9uU3RhdHVzLlVOVkVSSUZJRUQpLFxuICAgICAgcGVuZGluZ1ZlcmlmaWNhdGlvbjogYWxsVXNlcnMuZmlsdGVyKHVzZXIgPT4gdXNlci52ZXJpZmljYXRpb24uc3RhdHVzID09PSBWZXJpZmljYXRpb25TdGF0dXMuUEVORElORyksXG4gICAgICB2ZXJpZmllZDogYWxsVXNlcnMuZmlsdGVyKHVzZXIgPT4gdXNlci52ZXJpZmljYXRpb24uc3RhdHVzID09PSBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQpLFxuICAgIH07XG5cbiAgICByZXR1cm4gZ3JvdXBlZFVzZXJzO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tFbWFpbEF2YWlsYWJpbGl0eShlbWFpbDogc3RyaW5nKSB7XG4gICAgaWYgKCFlbWFpbCkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0VtYWlsIGlzIHJlcXVpcmVkLicpO1xuICAgIH1cblxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHsgZW1haWwgfSk7XG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvLyAqKioqKioqKiogUHJpdmF0ZSBNZXRob2RzICoqKioqKlxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYW4gb2JqZWN0IGNvbXBvc2VkIG9mIHRoZSBwaWNrZWQgb2JqZWN0IHByb3BlcnRpZXNcbiAgICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFxuICAgKiBAcGFyYW0ge3N0cmluZ1tdfSBrZXlzXG4gICAqIEByZXR1cm5zIHtPYmplY3R9XG4gICAqL1xuICBwaWNrKG9iamVjdDogeyBbeDogc3RyaW5nXTogYW55IH0sIGtleXM6IGFueVtdKTogb2JqZWN0IHtcbiAgICByZXR1cm4ga2V5cy5yZWR1Y2UoKG9iajogeyBbeDogc3RyaW5nXTogYW55IH0sIGtleTogc3RyaW5nIHwgbnVtYmVyKSA9PiB7XG4gICAgICBpZiAob2JqZWN0ICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHtcbiAgICAgICAgb2JqW2tleV0gPSBvYmplY3Rba2V5XTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSwge30pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRVc2VyKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoeyBfaWQ6IG5ldyBPYmplY3RJZCh1c2VySWQpIH0pO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ05vIHVzZXIgZm91bmQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGlzRW1haWxVbmlxdWUoZW1haWw6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHsgZW1haWwsIGVtYWlsVmVyaWZpZWQ6IHRydWUgfSk7XG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBCYWRSZXF1ZXN0RXhjZXB0aW9uKCdFbWFpbCBhbHJlYWR5IGV4aXN0c3MuJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFJlZ2lzdHJhdGlvbkluZm8odXNlcik6IGFueSB7XG4gICAgY29uc3QgdXNlclJlZ2lzdHJhdGlvbkluZm8gPSB7XG4gICAgICBmdWxsTmFtZTogdXNlci5mdWxsTmFtZSxcbiAgICAgIGVtYWlsOiB1c2VyLmVtYWlsLFxuICAgICAgdmVyaWZpZWQ6IHVzZXIudmVyaWZpZWQsXG4gICAgfTtcbiAgICByZXR1cm4gdXNlclJlZ2lzdHJhdGlvbkluZm87XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRCeVZlcmlmaWNhdGlvbih2ZXJpZmljYXRpb246IHN0cmluZyk6IFByb21pc2U8VXNlcj4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHtcbiAgICAgICd2ZXJpZmljYXRpb24uVmVyaWZpY2F0aW9uSUQnOiB2ZXJpZmljYXRpb24sXG4gICAgICAndmVyaWZpY2F0aW9uLnN0YXR1cyc6IFZlcmlmaWNhdGlvblN0YXR1cy5VTlZFUklGSUVELFxuICAgIH0pO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oJ0JhZCByZXF1ZXN0LicpO1xuICAgIH1cbiAgICByZXR1cm4gdXNlcjtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluZEJ5RW1haWwoZW1haWw6IHN0cmluZyk6IFByb21pc2U8VXNlcj4ge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kT25lKHsgZW1haWwgfSk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ0VtYWlsIG5vdCBmb3VuZC4nKTtcbiAgICB9XG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNldFVzZXJBc1ZlcmlmaWVkKHVzZXI6IFVzZXJEb2N1bWVudCkge1xuICAgIHVzZXIuZW1haWxWZXJpZmllZCA9IHRydWU7XG4gICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGZpbmRVc2VyQnlFbWFpbChlbWFpbDogc3RyaW5nKTogUHJvbWlzZTxVc2VyPiB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRPbmUoeyBlbWFpbCB9KTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignV3JvbmcgZW1haWwgb3IgcGFzc3dvcmQuJyk7XG4gICAgfVxuICAgIHJldHVybiB1c2VyO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja1Bhc3N3b3JkKGF0dGVtcHRQYXNzOiBzdHJpbmcsIHVzZXIpIHtcbiAgICBjb25zdCBtYXRjaCA9IGF3YWl0IGJjcnlwdC5jb21wYXJlKGF0dGVtcHRQYXNzLCB1c2VyLnBhc3N3b3JkKTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICBhd2FpdCB0aGlzLnBhc3N3b3Jkc0RvTm90TWF0Y2godXNlcik7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1dyb25nIGVtYWlsIG9yIHBhc3N3b3JkLicpO1xuICAgIH1cbiAgICByZXR1cm4gbWF0Y2g7XG4gIH1cblxuICBwcml2YXRlIGlzVXNlckJsb2NrZWQodXNlcikge1xuICAgIGlmICh1c2VyLmJsb2NrRXhwaXJlcyA+IERhdGUubm93KCkpIHtcbiAgICAgIHRocm93IG5ldyBDb25mbGljdEV4Y2VwdGlvbignVXNlciBoYXMgYmVlbiBibG9ja2VkIHRyeSBsYXRlci4nKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHBhc3N3b3Jkc0RvTm90TWF0Y2godXNlcikge1xuICAgIHVzZXIubG9naW5BdHRlbXB0cyArPSAxO1xuICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xuICAgIGlmICh1c2VyLmxvZ2luQXR0ZW1wdHMgPj0gdGhpcy5MT0dJTl9BVFRFTVBUU19UT19CTE9DSykge1xuICAgICAgYXdhaXQgdGhpcy5ibG9ja1VzZXIodXNlcik7XG4gICAgICB0aHJvdyBuZXcgQ29uZmxpY3RFeGNlcHRpb24oJ1VzZXIgYmxvY2tlZC4nKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGJsb2NrVXNlcih1c2VyKSB7XG4gICAgdXNlci5ibG9ja0V4cGlyZXMgPSBhZGRIb3VycyhuZXcgRGF0ZSgpLCB0aGlzLkhPVVJTX1RPX0JMT0NLKTtcbiAgICBhd2FpdCB1c2VyLnNhdmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGFzc3dvcmRzQXJlTWF0Y2godXNlcikge1xuICAgIHVzZXIubG9naW5BdHRlbXB0cyA9IDA7XG4gICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlc2V0VXNlclBhc3N3b3JkKHVzZXIsIG5ld1Bhc3N3b3JkOiBzdHJpbmcpIHtcbiAgICB1c2VyLnBhc3N3b3JkID0gbmV3UGFzc3dvcmQ7XG4gICAgYXdhaXQgdXNlci5zYXZlKCk7XG4gIH1cblxuICBhc3luYyBnZXRVc2VyQnlJZCh1c2VySWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kQnlJZCh1c2VySWQpO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgIH1cbiAgICByZXR1cm4gdXNlcjtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVVzZXIodXNlcklkOiBzdHJpbmcsIHVwZGF0ZVVzZXJEdG86IGFueSkge1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnVzZXJNb2RlbC5maW5kQnlJZCh1c2VySWQpO1xuICAgIGlmICghdXNlcikge1xuICAgICAgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdVc2VyIG5vdCBmb3VuZCcpO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBvbmx5IHRoZSBmaWVsZHMgdGhhdCBhcmUgcHJvdmlkZWRcbiAgICBpZiAodXBkYXRlVXNlckR0by5mdWxsTmFtZSkge1xuICAgICAgdXNlci5mdWxsTmFtZSA9IHVwZGF0ZVVzZXJEdG8uZnVsbE5hbWU7XG4gICAgfVxuICAgIGlmICh1cGRhdGVVc2VyRHRvLnBob25lKSB7XG4gICAgICB1c2VyLnBob25lID0gdXBkYXRlVXNlckR0by5waG9uZTtcbiAgICB9XG4gICAgaWYgKHVwZGF0ZVVzZXJEdG8uY2l0eSkge1xuICAgICAgdXNlci5jaXR5ID0gdXBkYXRlVXNlckR0by5jaXR5O1xuICAgIH1cbiAgICBpZiAodXBkYXRlVXNlckR0by51bml2ZXJzaXR5KSB7XG4gICAgICB1c2VyLnVuaXZlcnNpdHkgPSB1cGRhdGVVc2VyRHRvLnVuaXZlcnNpdHk7XG4gICAgfVxuICAgIGlmICh1cGRhdGVVc2VyRHRvLmVtcGxveW1lbnRTdGF0dXMpIHtcbiAgICAgIHVzZXIuZW1wbG95bWVudFN0YXR1cyA9IHVwZGF0ZVVzZXJEdG8uZW1wbG95bWVudFN0YXR1cyBhcyBhbnk7XG4gICAgICBpZiAodXBkYXRlVXNlckR0by5lbXBsb3ltZW50U3RhdHVzID09PSAndW5lbXBsb3llZCcpIHtcbiAgICAgICAgdXNlci51bml2ZXJzaXR5ID0gJyc7XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh1cGRhdGVVc2VyRHRvLnNvY2lhbExpbmspIHtcbiAgICAgIHVzZXIuc29jaWFsTGluayA9IHVwZGF0ZVVzZXJEdG8uc29jaWFsTGluaztcbiAgICB9XG4gICAgaWYgKHVwZGF0ZVVzZXJEdG8uZ2VuZGVyKSB7XG4gICAgICB1c2VyLmdlbmRlciA9IHVwZGF0ZVVzZXJEdG8uZ2VuZGVyO1xuICAgIH1cbiAgICBpZiAodXBkYXRlVXNlckR0by5jbmljKSB7XG4gICAgICB1c2VyLmNuaWMgPSB1cGRhdGVVc2VyRHRvLmNuaWM7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdXBkYXRlVXNlckR0by5wcm9maWxlSW1nICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgdXNlci5wcm9maWxlSW1nID0gdXBkYXRlVXNlckR0by5wcm9maWxlSW1nO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB1c2VyLnNhdmUoKTtcbiAgfVxuXG4gIGFzeW5jIGFwcHJvdmVVc2VyKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlVmVyaWZpY2F0aW9uU3RhdHVzKHVzZXJJZCwgVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVEKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVZlcmlmaWNhdGlvblN0YXR1cyh1c2VySWQ6IHN0cmluZywgc3RhdHVzOiBWZXJpZmljYXRpb25TdGF0dXMpIHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZEJ5SWQodXNlcklkKTtcbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVXNlciBub3QgZm91bmQnKTtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBzdGF0dXMgIT09IFZlcmlmaWNhdGlvblN0YXR1cy5WRVJJRklFRCAmJlxuICAgICAgc3RhdHVzICE9PSBWZXJpZmljYXRpb25TdGF0dXMuVU5WRVJJRklFRFxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEJhZFJlcXVlc3RFeGNlcHRpb24oXG4gICAgICAgICdTdGF0dXMgbXVzdCBiZSBlaXRoZXIgdmVyaWZpZWQgb3IgdW52ZXJpZmllZCcsXG4gICAgICApO1xuICAgIH1cblxuICAgIHVzZXIudmVyaWZpY2F0aW9uLnN0YXR1cyA9IHN0YXR1cztcbiAgICBpZiAoc3RhdHVzID09PSBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQpIHtcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLlZlcmlmaWNhdGlvbkRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB1c2VyLnZlcmlmaWNhdGlvbi5WZXJpZmljYXRpb25EYXRlID0gdW5kZWZpbmVkO1xuICAgICAgdXNlci52ZXJpZmljYXRpb24uUmVxdWVzdENhbGwgPSBmYWxzZTtcbiAgICB9XG4gICAgdXNlci5tYXJrTW9kaWZpZWQoJ3ZlcmlmaWNhdGlvbicpO1xuXG4gICAgY29uc3Qgc2F2ZWRVc2VyID0gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgaWYgKHN0YXR1cyA9PT0gVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVEKSB7XG4gICAgICBhd2FpdCB0aGlzLmNyZWRpdFZlcmlmaWNhdGlvblJlZmVycmVyc0lmRWxpZ2libGUoc2F2ZWRVc2VyIGFzIGFueSk7XG4gICAgfVxuXG4gICAgaWYgKHN0YXR1cyA9PT0gVmVyaWZpY2F0aW9uU3RhdHVzLlZFUklGSUVEICYmIHVzZXIuZW1haWwpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMubWFpbFNlcnZpY2Uuc2VuZFZlcmlmaWNhdGlvbkFwcHJvdmVkRW1haWwoXG4gICAgICAgICAgdXNlci5lbWFpbCxcbiAgICAgICAgICB1c2VyLmZ1bGxOYW1lIHx8ICdNdXNhZmlyJ1xuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBzZW5kIHZlcmlmaWNhdGlvbiBhcHByb3ZlZCBlbWFpbDonLCBlcnJvcik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5lbnN1cmVWZXJpZmljYXRpb25TdGF0dXNOb3RpZmljYXRpb24oXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICB7XG4gICAgICAgICAgbWV0YWRhdGE6IHsgc291cmNlOiAnYWRtaW5fb3ZlcnJpZGUnIH0sXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIHNlbmQgdmVyaWZpY2F0aW9uIHN0YXR1cyBub3RpZmljYXRpb246JywgZXJyb3IpO1xuICAgIH1cblxuICAgIHJldHVybiBzYXZlZFVzZXI7XG4gIH1cblxuICBhc3luYyByZWplY3RVc2VyKHVzZXJJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMudXNlck1vZGVsLmZpbmRCeUlkKHVzZXJJZCk7XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgfVxuICAgIHVzZXIudmVyaWZpY2F0aW9uLnN0YXR1cyA9IFZlcmlmaWNhdGlvblN0YXR1cy5SRUpFQ1RFRDtcbiAgICB1c2VyLnZlcmlmaWNhdGlvbi5WZXJpZmljYXRpb25EYXRlID0gdW5kZWZpbmVkO1xuICAgIHVzZXIudmVyaWZpY2F0aW9uLlJlcXVlc3RDYWxsID0gZmFsc2U7XG4gICAgdXNlci52ZXJpZmljYXRpb24ubWV0aG9kID0gdXNlci52ZXJpZmljYXRpb24ubWV0aG9kIHx8ICdhZG1pbic7XG4gICAgdXNlci5tYXJrTW9kaWZpZWQoJ3ZlcmlmaWNhdGlvbicpO1xuICAgIGNvbnN0IHNhdmVkVXNlciA9IGF3YWl0IHVzZXIuc2F2ZSgpO1xuXG4gICAgLy8gU2VuZCB2ZXJpZmljYXRpb24gcmVqZWN0ZWQgZW1haWwgaWYgdXNlciBoYXMgYW4gZW1haWxcbiAgICBpZiAodXNlci5lbWFpbCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5tYWlsU2VydmljZS5zZW5kVmVyaWZpY2F0aW9uUmVqZWN0ZWRFbWFpbChcbiAgICAgICAgICB1c2VyLmVtYWlsLFxuICAgICAgICAgIHVzZXIuZnVsbE5hbWUgfHwgJ011c2FmaXInXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIHNlbmQgdmVyaWZpY2F0aW9uIHJlamVjdGVkIGVtYWlsOicsIGVycm9yKTtcbiAgICAgICAgLy8gRG9uJ3QgdGhyb3cgZXJyb3IgLSBlbWFpbCBmYWlsdXJlIHNob3VsZG4ndCBwcmV2ZW50IHVzZXIgcmVqZWN0aW9uXG4gICAgICB9XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5lbnN1cmVWZXJpZmljYXRpb25TdGF0dXNOb3RpZmljYXRpb24oXG4gICAgICAgIHVzZXJJZCxcbiAgICAgICAgVmVyaWZpY2F0aW9uU3RhdHVzLlJFSkVDVEVELFxuICAgICAgICB7XG4gICAgICAgICAgbWV0YWRhdGE6IHsgc291cmNlOiAnYWRtaW5fb3ZlcnJpZGUnIH0sXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIHNlbmQgdmVyaWZpY2F0aW9uIHN0YXR1cyBub3RpZmljYXRpb246JywgZXJyb3IpO1xuICAgIH1cblxuICAgIHJldHVybiBzYXZlZFVzZXI7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIG5vdGlmeUNvbW11bml0eUxlYWRzQWJvdXRDYWxsKHVzZXI6IFVzZXIpIHtcbiAgICBjb25zdCBsZWFkcyA9IGF3YWl0IHRoaXMudXNlck1vZGVsXG4gICAgICAuZmluZCh7IHJvbGVzOiB7ICRpbjogWydhZG1pbiddIH0gfSlcbiAgICAgIC5zZWxlY3QoJ19pZCBmdWxsTmFtZSBlbWFpbCcpXG4gICAgICAubGVhbigpO1xuXG4gICAgY29uc3QgbGVhZElkcyA9IGxlYWRzLm1hcCgobGVhZDogYW55KSA9PiBsZWFkLl9pZD8udG9TdHJpbmcoKSkuZmlsdGVyKEJvb2xlYW4pO1xuICAgIGlmIChsZWFkSWRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXG4gICAgYXdhaXQgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlLmNyZWF0ZUZvclVzZXJzKGxlYWRJZHMsIHtcbiAgICAgIHRpdGxlOiAnVmVyaWZpY2F0aW9uIGNhbGwgcmVxdWVzdGVkJyxcbiAgICAgIG1lc3NhZ2U6IGAke3VzZXI/LmZ1bGxOYW1lIHx8ICdBIE11c2FmaXInfSByZXF1ZXN0ZWQgYW4gb25ib2FyZGluZyBjYWxsIGZvciB2ZXJpZmljYXRpb24keyh1c2VyIGFzIGFueSk/LnZlcmlmaWNhdGlvbj8uZmxhZ3NoaXBJZCA/IGAgKGZsYWdzaGlwICR7KHVzZXIgYXMgYW55KS52ZXJpZmljYXRpb24uZmxhZ3NoaXBJZH0pYCA6ICcnfS5gLFxuICAgICAgdHlwZTogJ3ZlcmlmaWNhdGlvbicsXG4gICAgICBsaW5rOiAodXNlciBhcyBhbnkpPy5faWQgPyBgL2FkbWluL3VzZXIvJHtTdHJpbmcoKHVzZXIgYXMgYW55KS5faWQpfWAgOiAnL2FkbWluJyxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIHVzZXJJZDogKHVzZXIgYXMgYW55KT8uX2lkPy50b1N0cmluZz8uKCksXG4gICAgICAgIGZsYWdzaGlwSWQ6ICh1c2VyIGFzIGFueSk/LnZlcmlmaWNhdGlvbj8uZmxhZ3NoaXBJZCxcbiAgICAgICAgcmVxdWVzdENhbGw6IHRydWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgdXBsb2FkVmVyaWZpY2F0aW9uVmlkZW8oXG4gICAgdmlkZW86IEV4cHJlc3MuTXVsdGVyLkZpbGUsXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8VXNlcj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgdGhpcy51c2VyTW9kZWwuZmluZEJ5SWQodXNlcklkKTtcbiAgICAgIGlmICghdXNlcikge1xuICAgICAgICB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oJ1VzZXIgbm90IGZvdW5kJyk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHZpZGVvS2V5ID0gYHZlcmlmaWNhdGlvbi12aWRlb3MvJHt1c2VySWR9LyR7RGF0ZS5ub3coKX0tJHt2aWRlby5vcmlnaW5hbG5hbWV9YDtcbiAgICAgIGF3YWl0IHRoaXMuc3RvcmFnZVNlcnZpY2UudXBsb2FkRmlsZShcbiAgICAgICAgdmlkZW9LZXksXG4gICAgICAgIHZpZGVvLmJ1ZmZlcixcbiAgICAgICAgdmlkZW8ubWltZXR5cGUsXG4gICAgICApO1xuICAgICAgdXNlci52ZXJpZmljYXRpb24udmlkZW9TdG9yYWdlS2V5ID0gdmlkZW9LZXk7XG4gICAgICB1c2VyLnZlcmlmaWNhdGlvbi5zdGF0dXMgPSBWZXJpZmljYXRpb25TdGF0dXMuUEVORElORztcbiAgICAgIHVzZXIudmVyaWZpY2F0aW9uLm1ldGhvZCA9ICd2aWRlbyc7XG4gICAgICByZXR1cm4gYXdhaXQgdXNlci5zYXZlKCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHVwbG9hZCB2aWRlbzogJyArIGVycm9yLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9