{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/mail/mail.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/mail/mail.service.ts"],"sourcesContent":["import { MailerService } from '@nestjs-modules/mailer';\nimport { BadRequestException, Injectable, Logger } from '@nestjs/common';\nimport { join } from 'path';\nimport * as fs from 'fs';\nimport * as handlebars from 'handlebars';\nimport brevo, {\n  TransactionalEmailsApi,\n  SendSmtpEmail,\n  TransactionalEmailsApiApiKeys\n  // ApiClient,\n} from '@getbrevo/brevo';\n\n@Injectable()\nexport class MailService {\n  private readonly logger = new Logger(MailService.name);\n  private readonly brevoClient: brevo.TransactionalEmailsApi;\n  private readonly templatesDir: string;\n\n  constructor() {\n    const brevoApiKey = process.env.BREVO_API_KEY;\n    if (!brevoApiKey) {\n      throw new Error('BREVO_API_KEY is not set in environment variables');\n    }\n\n    const apiInstance = new TransactionalEmailsApi();\n\n    apiInstance.setApiKey(\n      TransactionalEmailsApiApiKeys.apiKey,\n      brevoApiKey\n    );\n\n    this.brevoClient = apiInstance;\n\n    this.templatesDir = join(__dirname, 'templates');\n  }\n\n\n  private renderTemplate(templateName: string, context: Record<string, any>): string {\n    const templatePath = join(this.templatesDir, `${templateName}.hbs`);\n\n    if (!fs.existsSync(templatePath)) {\n      throw new Error(`Email template \"${templateName}\" not found at ${templatePath}`);\n    }\n\n    const templateSource = fs.readFileSync(templatePath, 'utf8');\n    const compiledTemplate = handlebars.compile(templateSource);\n    return compiledTemplate(context);\n  }\n\n\n  async sendMail(\n    to: string,\n    subject: string,\n    templateName: string,\n    context: Record<string, any>,\n  ) {\n    try {\n      if (!to) {\n        throw new BadRequestException('Recipient email (to) is required');\n      }\n      if (!process.env.MUSAFIR_MAIL) {\n        throw new BadRequestException(\n          'MUSAFIR_MAIL is not set in environment variables',\n        );\n      }\n\n      const htmlContent = this.renderTemplate(templateName, context);\n\n      const email = new SendSmtpEmail();\n      email.subject = subject;\n      email.htmlContent = htmlContent;\n      email.sender = { email: process.env.MAIL_FROM_TRANSACTIONAL };\n      email.to = [{ email: to }];\n\n      const response = await this.brevoClient.sendTransacEmail(email);\n      this.logger.log(`✅ Email sent successfully to ${to}`);\n    } catch (error: any) {\n      this.logger.error(`❌ Failed to send email to ${to}: ${error.message}`, error.stack);\n      if (error.response?.body) {\n        this.logger.error(`Brevo API response: ${JSON.stringify(error.response.body)}`);\n      }\n      throw error;\n    }\n  }\n\n  async sendEmailVerification(emailto: string, password: string) {\n    try {\n      await this.sendMail(\n        emailto,\n        'Verify Your 3Musafir Account',\n        'email-confirmation',\n        {\n          password: password,\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log(error);\n      return error;\n    }\n  }\n\n  async sendReEvaluateRequestToJury(\n    registrationId: string,\n    flagshipName: string,\n    name: string,\n    email: string,\n    musafirNumber: string,\n    city: string,\n  ) {\n    try {\n      await this.sendMail(\n        process.env.MUSAFIR_MAIL,\n        'Re-Evaluate Request to Jury',\n        './askJuryToReEvaluate',\n        {\n          registrationId: registrationId,\n          flagshipName: flagshipName,\n          name: name,\n          email: email,\n          musafirNumber: musafirNumber,\n          city: city,\n        },\n      );\n    } catch (error) {\n      return error;\n    }\n  }\n\n  async sendTripQuery(\n    flagshipId: string,\n    flagshipName: string,\n    name: string,\n    email: string,\n    musafirNumber: string,\n    city: string,\n    tripQuery: string,\n  ) {\n    if (!process.env.MUSAFIR_MAIL) {\n      throw new BadRequestException(\n        'From Email is not set in environment variables',\n      );\n    }\n\n    await this.sendMail(process.env.MUSAFIR_MAIL, 'Trip Query', './tripQuery', {\n      flagshipId: flagshipId,\n      flagshipName: flagshipName,\n      name: name,\n      email: email,\n      musafirNumber: musafirNumber,\n      city: city,\n      tripQuery: tripQuery,\n    });\n\n    return true;\n  }\n\n  async sendPasswordResetEmail(\n    email: string,\n    resetLink: string,\n    userName: string,\n  ) {\n    try {\n      await this.sendMail(\n        email,\n        'Reset Your 3Musafir Password',\n        './password-reset',\n        {\n          resetLink: resetLink,\n          userName: userName,\n        },\n      );\n    } catch (error) {\n      return error;\n    }\n  }\n\n  async sendAccountCreatedEmail(email: string, firstName: string, loginUrl: string) {\n    try {\n      await this.sendMail(\n        email,\n        'Your 3M account is ready',\n        './account-created',\n        {\n          firstName,\n          loginUrl,\n        },\n      );\n    } catch (error) {\n      console.log(error);\n      return error;\n    }\n  }\n\n  async sendVerificationApprovedEmail(email: string, fullName: string) {\n    try {\n      await this.sendMail(\n        email,\n        'Your 3Musafir Account Has Been Verified',\n        './verification-approved',\n        {\n          fullName: fullName,\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log('Error sending verification approved email:', error);\n      return error;\n    }\n  }\n\n  async sendVerificationRejectedEmail(email: string, fullName: string) {\n    try {\n      await this.sendMail(\n        email,\n        'Your 3Musafir Account Verification Status',\n        './verification-rejected',\n        {\n          fullName: fullName,\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log('Error sending verification rejected email:', error);\n      return error;\n    }\n  }\n\n  async sendPaymentApprovedEmail(\n    email: string,\n    fullName: string,\n    amount: number,\n    tripName: string,\n    paymentDate: Date,\n    options?: { remainingDue?: number; paymentUrl?: string }\n  ) {\n    try {\n      await this.sendMail(\n        email,\n        'Your 3Musafir Payment Has Been Approved',\n        './payment-approved',\n        {\n          fullName: fullName,\n          amount: amount,\n          tripName: tripName,\n          paymentDate: paymentDate.toLocaleDateString('en-US', {\n            year: 'numeric',\n            month: 'long',\n            day: 'numeric'\n          }),\n          remainingDue: options?.remainingDue,\n          paymentUrl: options?.paymentUrl,\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log('Error sending payment approved email:', error);\n      return error;\n    }\n  }\n\n  async sendPaymentRejectedEmail(\n    email: string,\n    fullName: string,\n    amount: number,\n    tripName: string,\n    reason?: string\n  ) {\n    try {\n      await this.sendMail(\n        email,\n        'Your 3Musafir Payment Was Not Approved',\n        './payment-rejected',\n        {\n          fullName: fullName,\n          amount: amount,\n          tripName: tripName,\n          reason: reason || 'Please ensure all payment details are correct and the screenshot is clear.',\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log('Error sending payment rejected email:', error);\n      return error;\n    }\n  }\n\n  async sendAdminRegistrationNotification(context: {\n    registrationId: string;\n    flagshipId: string;\n    flagshipName: string;\n    userName: string;\n    userEmail?: string;\n    userPhone?: string;\n    userCity?: string;\n    joiningFromCity?: string;\n    tier?: string;\n    bedPreference?: string;\n    roomSharing?: string;\n    groupMembers?: string[];\n    expectations?: string;\n    tripType?: string;\n    price?: number;\n    amountDue?: number;\n    createdAt?: Date | string;\n    startDate?: Date | string;\n    endDate?: Date | string;\n    destination?: string;\n    category?: string;\n  }) {\n    try {\n      const formatDate = (d?: Date | string) =>\n        d ? new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : undefined;\n\n      await this.sendMail(\n        process.env.MUSAFIR_MAIL,\n        'New Trip Registration Submitted',\n        './admin-registration-notification',\n        {\n          ...context,\n          createdAt: formatDate(context.createdAt),\n          startDate: formatDate(context.startDate),\n          endDate: formatDate(context.endDate),\n          groupMembers: context.groupMembers && context.groupMembers.length ? context.groupMembers : undefined,\n        },\n      );\n      return true;\n    } catch (error) {\n      console.log('Error sending admin registration notification:', error);\n      return error;\n    }\n  }\n}\n"],"version":3}