{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.createPayment.walletIdempotency.spec.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.createPayment.walletIdempotency.spec.ts"],"sourcesContent":["import { PaymentService } from './payment.service';\nimport { VerificationStatus } from 'src/constants/verification-status.enum';\nimport { WALLET_TX_IDEMPOTENT_MARKER } from 'src/wallet/wallet.service';\n\ndescribe('PaymentService.createPayment wallet idempotency', () => {\n  it('skips registration updates when wallet debit is idempotent', async () => {\n    const registration: any = {\n      _id: 'reg1',\n      userId: 'user1',\n      amountDue: 800,\n      walletPaid: 200,\n      discountApplied: 0,\n      status: 'pending',\n      isPaid: false,\n      price: 1000,\n    };\n\n    const paymentModel: any = {\n      exists: jest.fn(async () => null),\n    };\n    const userModel: any = {\n      findById: jest.fn(async () => ({\n        _id: 'user1',\n        verification: { status: VerificationStatus.VERIFIED },\n      })),\n    };\n    const bankAccountModel: any = {};\n    const flagshipModel: any = {};\n    const registrationModel: any = {\n      findById: jest.fn(async () => registration),\n      findByIdAndUpdate: jest.fn(),\n    };\n    const refundModel: any = {};\n    const storageService: any = {};\n    const mailService: any = {};\n    const notificationService: any = {};\n\n    const walletTx: any = { _id: 'wallet_tx_1', amount: 200 };\n    Object.defineProperty(walletTx, WALLET_TX_IDEMPOTENT_MARKER, {\n      value: true,\n      enumerable: false,\n    });\n\n    const walletService: any = {\n      debit: jest.fn(async () => walletTx),\n      voidBySource: jest.fn(),\n    };\n    const refundSettlementService: any = {};\n\n    const service = new PaymentService(\n      paymentModel,\n      userModel,\n      bankAccountModel,\n      flagshipModel,\n      registrationModel,\n      refundModel,\n      storageService,\n      mailService,\n      notificationService,\n      walletService,\n      refundSettlementService,\n    );\n\n    const result: any = await service.createPayment(\n      {\n        registration: 'reg1',\n        amount: 0,\n        walletAmount: 200,\n        walletUseId: 'attempt_1',\n        discount: 0,\n      } as any,\n      undefined,\n      { _id: 'user1' } as any,\n    );\n\n    expect(walletService.debit).toHaveBeenCalled();\n    expect(registrationModel.findByIdAndUpdate).not.toHaveBeenCalled();\n    expect(result).toMatchObject({\n      statusCode: 200,\n      data: {\n        registrationId: 'reg1',\n        walletApplied: 200,\n        amountDue: 800,\n      },\n    });\n  });\n});\n\n"],"version":3}