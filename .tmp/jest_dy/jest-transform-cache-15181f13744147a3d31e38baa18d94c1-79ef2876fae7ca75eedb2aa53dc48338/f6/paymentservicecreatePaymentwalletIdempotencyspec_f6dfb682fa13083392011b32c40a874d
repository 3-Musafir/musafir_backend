119fb6a2391ca235a67e1bfb94c07181
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const payment_service_1 = require("./payment.service");
const verification_status_enum_1 = require("src/constants/verification-status.enum");
const wallet_service_1 = require("src/wallet/wallet.service");
describe('PaymentService.createPayment wallet idempotency', () => {
    it('skips registration updates when wallet debit is idempotent', () => __awaiter(void 0, void 0, void 0, function* () {
        const registration = {
            _id: 'reg1',
            userId: 'user1',
            amountDue: 800,
            walletPaid: 200,
            discountApplied: 0,
            status: 'pending',
            isPaid: false,
            price: 1000,
        };
        const paymentModel = {
            exists: jest.fn(() => __awaiter(void 0, void 0, void 0, function* () { return null; })),
        };
        const userModel = {
            findById: jest.fn(() => __awaiter(void 0, void 0, void 0, function* () {
                return ({
                    _id: 'user1',
                    verification: { status: verification_status_enum_1.VerificationStatus.VERIFIED },
                });
            })),
        };
        const bankAccountModel = {};
        const flagshipModel = {};
        const registrationModel = {
            findById: jest.fn(() => __awaiter(void 0, void 0, void 0, function* () { return registration; })),
            findByIdAndUpdate: jest.fn(),
        };
        const refundModel = {};
        const storageService = {};
        const mailService = {};
        const notificationService = {};
        const walletTx = { _id: 'wallet_tx_1', amount: 200 };
        Object.defineProperty(walletTx, wallet_service_1.WALLET_TX_IDEMPOTENT_MARKER, {
            value: true,
            enumerable: false,
        });
        const walletService = {
            debit: jest.fn(() => __awaiter(void 0, void 0, void 0, function* () { return walletTx; })),
            voidBySource: jest.fn(),
        };
        const refundSettlementService = {};
        const service = new payment_service_1.PaymentService(paymentModel, userModel, bankAccountModel, flagshipModel, registrationModel, refundModel, storageService, mailService, notificationService, walletService, refundSettlementService);
        const result = yield service.createPayment({
            registration: 'reg1',
            amount: 0,
            walletAmount: 200,
            walletUseId: 'attempt_1',
            discount: 0,
        }, undefined, { _id: 'user1' });
        expect(walletService.debit).toHaveBeenCalled();
        expect(registrationModel.findByIdAndUpdate).not.toHaveBeenCalled();
        expect(result).toMatchObject({
            statusCode: 200,
            data: {
                registrationId: 'reg1',
                walletApplied: 200,
                amountDue: 800,
            },
        });
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2RldnByb2ZpbGUvRG9jdW1lbnRzL0dpdEh1Yi9tdXNhZmlyX2JhY2tlbmQvc3JjL3BheW1lbnQvcGF5bWVudC5zZXJ2aWNlLmNyZWF0ZVBheW1lbnQud2FsbGV0SWRlbXBvdGVuY3kuc3BlYy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHVEQUFtRDtBQUNuRCxxRkFBNEU7QUFDNUUsOERBQXdFO0FBRXhFLFFBQVEsQ0FBQyxpREFBaUQsRUFBRSxHQUFHLEVBQUU7SUFDL0QsRUFBRSxDQUFDLDREQUE0RCxFQUFFLEdBQVMsRUFBRTtRQUMxRSxNQUFNLFlBQVksR0FBUTtZQUN4QixHQUFHLEVBQUUsTUFBTTtZQUNYLE1BQU0sRUFBRSxPQUFPO1lBQ2YsU0FBUyxFQUFFLEdBQUc7WUFDZCxVQUFVLEVBQUUsR0FBRztZQUNmLGVBQWUsRUFBRSxDQUFDO1lBQ2xCLE1BQU0sRUFBRSxTQUFTO1lBQ2pCLE1BQU0sRUFBRSxLQUFLO1lBQ2IsS0FBSyxFQUFFLElBQUk7U0FDWixDQUFDO1FBRUYsTUFBTSxZQUFZLEdBQVE7WUFDeEIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBUyxFQUFFLGtEQUFDLE9BQUEsSUFBSSxDQUFBLEdBQUEsQ0FBQztTQUNsQyxDQUFDO1FBQ0YsTUFBTSxTQUFTLEdBQVE7WUFDckIsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBUyxFQUFFO2dCQUFDLE9BQUEsQ0FBQztvQkFDN0IsR0FBRyxFQUFFLE9BQU87b0JBQ1osWUFBWSxFQUFFLEVBQUUsTUFBTSxFQUFFLDZDQUFrQixDQUFDLFFBQVEsRUFBRTtpQkFDdEQsQ0FBQyxDQUFBO2NBQUEsQ0FBQztTQUNKLENBQUM7UUFDRixNQUFNLGdCQUFnQixHQUFRLEVBQUUsQ0FBQztRQUNqQyxNQUFNLGFBQWEsR0FBUSxFQUFFLENBQUM7UUFDOUIsTUFBTSxpQkFBaUIsR0FBUTtZQUM3QixRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFTLEVBQUUsa0RBQUMsT0FBQSxZQUFZLENBQUEsR0FBQSxDQUFDO1lBQzNDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDN0IsQ0FBQztRQUNGLE1BQU0sV0FBVyxHQUFRLEVBQUUsQ0FBQztRQUM1QixNQUFNLGNBQWMsR0FBUSxFQUFFLENBQUM7UUFDL0IsTUFBTSxXQUFXLEdBQVEsRUFBRSxDQUFDO1FBQzVCLE1BQU0sbUJBQW1CLEdBQVEsRUFBRSxDQUFDO1FBRXBDLE1BQU0sUUFBUSxHQUFRLEVBQUUsR0FBRyxFQUFFLGFBQWEsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFDMUQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsNENBQTJCLEVBQUU7WUFDM0QsS0FBSyxFQUFFLElBQUk7WUFDWCxVQUFVLEVBQUUsS0FBSztTQUNsQixDQUFDLENBQUM7UUFFSCxNQUFNLGFBQWEsR0FBUTtZQUN6QixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFTLEVBQUUsa0RBQUMsT0FBQSxRQUFRLENBQUEsR0FBQSxDQUFDO1lBQ3BDLFlBQVksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3hCLENBQUM7UUFDRixNQUFNLHVCQUF1QixHQUFRLEVBQUUsQ0FBQztRQUV4QyxNQUFNLE9BQU8sR0FBRyxJQUFJLGdDQUFjLENBQ2hDLFlBQVksRUFDWixTQUFTLEVBQ1QsZ0JBQWdCLEVBQ2hCLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsV0FBVyxFQUNYLGNBQWMsRUFDZCxXQUFXLEVBQ1gsbUJBQW1CLEVBQ25CLGFBQWEsRUFDYix1QkFBdUIsQ0FDeEIsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFRLE1BQU0sT0FBTyxDQUFDLGFBQWEsQ0FDN0M7WUFDRSxZQUFZLEVBQUUsTUFBTTtZQUNwQixNQUFNLEVBQUUsQ0FBQztZQUNULFlBQVksRUFBRSxHQUFHO1lBQ2pCLFdBQVcsRUFBRSxXQUFXO1lBQ3hCLFFBQVEsRUFBRSxDQUFDO1NBQ0wsRUFDUixTQUFTLEVBQ1QsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFTLENBQ3hCLENBQUM7UUFFRixNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDL0MsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDbkUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGFBQWEsQ0FBQztZQUMzQixVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRTtnQkFDSixjQUFjLEVBQUUsTUFBTTtnQkFDdEIsYUFBYSxFQUFFLEdBQUc7Z0JBQ2xCLFNBQVMsRUFBRSxHQUFHO2FBQ2Y7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUEsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2RldnByb2ZpbGUvRG9jdW1lbnRzL0dpdEh1Yi9tdXNhZmlyX2JhY2tlbmQvc3JjL3BheW1lbnQvcGF5bWVudC5zZXJ2aWNlLmNyZWF0ZVBheW1lbnQud2FsbGV0SWRlbXBvdGVuY3kuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXltZW50U2VydmljZSB9IGZyb20gJy4vcGF5bWVudC5zZXJ2aWNlJztcbmltcG9ydCB7IFZlcmlmaWNhdGlvblN0YXR1cyB9IGZyb20gJ3NyYy9jb25zdGFudHMvdmVyaWZpY2F0aW9uLXN0YXR1cy5lbnVtJztcbmltcG9ydCB7IFdBTExFVF9UWF9JREVNUE9URU5UX01BUktFUiB9IGZyb20gJ3NyYy93YWxsZXQvd2FsbGV0LnNlcnZpY2UnO1xuXG5kZXNjcmliZSgnUGF5bWVudFNlcnZpY2UuY3JlYXRlUGF5bWVudCB3YWxsZXQgaWRlbXBvdGVuY3knLCAoKSA9PiB7XG4gIGl0KCdza2lwcyByZWdpc3RyYXRpb24gdXBkYXRlcyB3aGVuIHdhbGxldCBkZWJpdCBpcyBpZGVtcG90ZW50JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlZ2lzdHJhdGlvbjogYW55ID0ge1xuICAgICAgX2lkOiAncmVnMScsXG4gICAgICB1c2VySWQ6ICd1c2VyMScsXG4gICAgICBhbW91bnREdWU6IDgwMCxcbiAgICAgIHdhbGxldFBhaWQ6IDIwMCxcbiAgICAgIGRpc2NvdW50QXBwbGllZDogMCxcbiAgICAgIHN0YXR1czogJ3BlbmRpbmcnLFxuICAgICAgaXNQYWlkOiBmYWxzZSxcbiAgICAgIHByaWNlOiAxMDAwLFxuICAgIH07XG5cbiAgICBjb25zdCBwYXltZW50TW9kZWw6IGFueSA9IHtcbiAgICAgIGV4aXN0czogamVzdC5mbihhc3luYyAoKSA9PiBudWxsKSxcbiAgICB9O1xuICAgIGNvbnN0IHVzZXJNb2RlbDogYW55ID0ge1xuICAgICAgZmluZEJ5SWQ6IGplc3QuZm4oYXN5bmMgKCkgPT4gKHtcbiAgICAgICAgX2lkOiAndXNlcjEnLFxuICAgICAgICB2ZXJpZmljYXRpb246IHsgc3RhdHVzOiBWZXJpZmljYXRpb25TdGF0dXMuVkVSSUZJRUQgfSxcbiAgICAgIH0pKSxcbiAgICB9O1xuICAgIGNvbnN0IGJhbmtBY2NvdW50TW9kZWw6IGFueSA9IHt9O1xuICAgIGNvbnN0IGZsYWdzaGlwTW9kZWw6IGFueSA9IHt9O1xuICAgIGNvbnN0IHJlZ2lzdHJhdGlvbk1vZGVsOiBhbnkgPSB7XG4gICAgICBmaW5kQnlJZDogamVzdC5mbihhc3luYyAoKSA9PiByZWdpc3RyYXRpb24pLFxuICAgICAgZmluZEJ5SWRBbmRVcGRhdGU6IGplc3QuZm4oKSxcbiAgICB9O1xuICAgIGNvbnN0IHJlZnVuZE1vZGVsOiBhbnkgPSB7fTtcbiAgICBjb25zdCBzdG9yYWdlU2VydmljZTogYW55ID0ge307XG4gICAgY29uc3QgbWFpbFNlcnZpY2U6IGFueSA9IHt9O1xuICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2U6IGFueSA9IHt9O1xuXG4gICAgY29uc3Qgd2FsbGV0VHg6IGFueSA9IHsgX2lkOiAnd2FsbGV0X3R4XzEnLCBhbW91bnQ6IDIwMCB9O1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3YWxsZXRUeCwgV0FMTEVUX1RYX0lERU1QT1RFTlRfTUFSS0VSLCB7XG4gICAgICB2YWx1ZTogdHJ1ZSxcbiAgICAgIGVudW1lcmFibGU6IGZhbHNlLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgd2FsbGV0U2VydmljZTogYW55ID0ge1xuICAgICAgZGViaXQ6IGplc3QuZm4oYXN5bmMgKCkgPT4gd2FsbGV0VHgpLFxuICAgICAgdm9pZEJ5U291cmNlOiBqZXN0LmZuKCksXG4gICAgfTtcbiAgICBjb25zdCByZWZ1bmRTZXR0bGVtZW50U2VydmljZTogYW55ID0ge307XG5cbiAgICBjb25zdCBzZXJ2aWNlID0gbmV3IFBheW1lbnRTZXJ2aWNlKFxuICAgICAgcGF5bWVudE1vZGVsLFxuICAgICAgdXNlck1vZGVsLFxuICAgICAgYmFua0FjY291bnRNb2RlbCxcbiAgICAgIGZsYWdzaGlwTW9kZWwsXG4gICAgICByZWdpc3RyYXRpb25Nb2RlbCxcbiAgICAgIHJlZnVuZE1vZGVsLFxuICAgICAgc3RvcmFnZVNlcnZpY2UsXG4gICAgICBtYWlsU2VydmljZSxcbiAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2UsXG4gICAgICB3YWxsZXRTZXJ2aWNlLFxuICAgICAgcmVmdW5kU2V0dGxlbWVudFNlcnZpY2UsXG4gICAgKTtcblxuICAgIGNvbnN0IHJlc3VsdDogYW55ID0gYXdhaXQgc2VydmljZS5jcmVhdGVQYXltZW50KFxuICAgICAge1xuICAgICAgICByZWdpc3RyYXRpb246ICdyZWcxJyxcbiAgICAgICAgYW1vdW50OiAwLFxuICAgICAgICB3YWxsZXRBbW91bnQ6IDIwMCxcbiAgICAgICAgd2FsbGV0VXNlSWQ6ICdhdHRlbXB0XzEnLFxuICAgICAgICBkaXNjb3VudDogMCxcbiAgICAgIH0gYXMgYW55LFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgeyBfaWQ6ICd1c2VyMScgfSBhcyBhbnksXG4gICAgKTtcblxuICAgIGV4cGVjdCh3YWxsZXRTZXJ2aWNlLmRlYml0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgZXhwZWN0KHJlZ2lzdHJhdGlvbk1vZGVsLmZpbmRCeUlkQW5kVXBkYXRlKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvTWF0Y2hPYmplY3Qoe1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgZGF0YToge1xuICAgICAgICByZWdpc3RyYXRpb25JZDogJ3JlZzEnLFxuICAgICAgICB3YWxsZXRBcHBsaWVkOiAyMDAsXG4gICAgICAgIGFtb3VudER1ZTogODAwLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuIl0sInZlcnNpb24iOjN9