{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/flagship/flagship.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/flagship/flagship.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  InternalServerErrorException,\n  NotFoundException,\n} from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { CreateFlagshipDto } from './dto/create-flagship.dto';\nimport { UpdateFlagshipDto } from './dto/update-flagship.dto';\nimport { Flagship } from './interfaces/flagship.interface';\nimport { User } from 'src/user/interfaces/user.interface';\nimport dayjs = require('dayjs');\nimport { Registration } from 'src/registration/interfaces/registration.interface';\nimport { Payment } from 'src/payment/interface/payment.interface';\nimport { FlagshipFilterDto } from './dto/get-flagship.dto';\nimport { RegistrationService } from 'src/registration/registration.service';\nimport { MailService } from 'src/mail/mail.service';\nimport { successResponse, errorResponse } from '../constants/response';\nimport { StorageService } from 'src/storage/storageService';\nimport sharp from 'sharp';\nimport { NotificationService } from 'src/notifications/notification.service';\nimport { VerificationStatus } from 'src/constants/verification-status.enum';\nimport { UserService } from 'src/user/user.service';\n\n@Injectable()\nexport class FlagshipService {\n  constructor(\n    @InjectModel('Flagship') private readonly flagshipModel: Model<Flagship>,\n    private readonly registrationService: RegistrationService,\n    private readonly mailService: MailService,\n    private readonly storageService: StorageService,\n    @InjectModel('User') private readonly userModel: Model<User>,\n    @InjectModel('Registration')\n    private readonly registerationModel: Model<Registration>,\n    @InjectModel('Payment')\n    private readonly paymentModel: Model<Payment>,\n    private readonly notificationService: NotificationService,\n    private readonly userService: UserService,\n  ) { }\n\n  async create(createFlagshipDto: CreateFlagshipDto): Promise<Flagship> {\n    const startDate = dayjs(createFlagshipDto.startDate);\n    const endDate = dayjs(createFlagshipDto.endDate);\n    const diffDays = endDate.diff(startDate, 'day');\n    createFlagshipDto.days = diffDays;\n    const newFlagship = new this.flagshipModel(createFlagshipDto);\n    const saved = await newFlagship.save();\n    await this.notifyNewFlagship(saved);\n    return saved;\n  }\n\n  async createFlagship(\n    createFlagshipDto: CreateFlagshipDto,\n  ): Promise<Flagship> {\n    const startDate = new Date(createFlagshipDto.startDate);\n    const endDate = new Date(createFlagshipDto.endDate);\n\n    if (startDate >= endDate) {\n      throw new BadRequestException('Start date must be before end date.');\n    }\n\n    const flagship = new this.flagshipModel(createFlagshipDto);\n    return flagship.save();\n  }\n\n  async findAll(): Promise<Flagship[]> {\n    return await this.flagshipModel.find().exec();\n  }\n\n  async getAllFlagships(\n    filterDto: FlagshipFilterDto,\n    options?: { excludeRegisteredUserId?: string },\n  ): Promise<Flagship[]> {\n    const query: any = {};\n\n    const buildStringQuery = (value: string) => ({\n      $regex: new RegExp(value, 'i'),\n    });\n\n    const exactMatchFields = new Set([\n      'status',\n      'visibility',\n      'category',\n      'created_By',\n      'createdBy',\n    ]);\n\n    const dateFields = new Set(['startDate', 'endDate', 'registrationDeadline', 'advancePaymentDeadline', 'earlyBirdDeadline']);\n\n    for (const key of Object.keys(filterDto)) {\n      const value = filterDto[key];\n      if (value !== undefined) {\n        if (key === 'includePast') {\n          continue;\n        }\n        if (dateFields.has(key) && typeof value === 'string') {\n          const asDate = new Date(value);\n          if (!Number.isNaN(asDate.getTime())) {\n            query[key] = asDate;\n            continue;\n          }\n        }\n        if (exactMatchFields.has(key)) {\n          query[key] = value;\n          continue;\n        }\n        if (typeof value === 'string') {\n          query[key] = buildStringQuery(value);\n        } else if (typeof value === 'object' && value !== null) {\n          query[key] = value;\n        } else {\n          query[key] = value;\n        }\n      }\n    }\n\n    if (options?.excludeRegisteredUserId) {\n      const registeredFlagshipIds = await this.registerationModel.distinct(\n        'flagship',\n        { userId: options.excludeRegisteredUserId },\n      );\n\n      if (Array.isArray(registeredFlagshipIds) && registeredFlagshipIds.length > 0) {\n        if (query._id) {\n          query.$and = Array.isArray(query.$and) ? query.$and : [];\n          query.$and.push({ _id: query._id });\n          delete query._id;\n          query.$and.push({ _id: { $nin: registeredFlagshipIds } });\n        } else {\n          query._id = { $nin: registeredFlagshipIds };\n        }\n      }\n    }\n\n    const sort: Record<string, 1 | -1> =\n      filterDto?.status === 'completed' ? { endDate: -1 } : { startDate: 1 };\n\n    const flagships = await this.flagshipModel\n      .find(query)\n      .sort(sort)\n      .populate('created_By')\n      .exec();\n\n    const processedFlagships = await Promise.all(\n      flagships.map(async (flagship) => {\n        const flagshipObj = flagship.toObject();\n        if (flagship.images && flagship.images.length > 0) {\n          const imageUrls = await Promise.all(\n            flagship.images.map(async (imageKey) => {\n              return await this.storageService.getSignedUrl(imageKey);\n            }),\n          );\n          flagshipObj.images = imageUrls;\n        }\n        return flagshipObj;\n      }),\n    );\n\n    return processedFlagships;\n  }\n\n  async findOne(\n    id: string,\n    options?: { restrictToPublishedPublic?: boolean },\n  ): Promise<Flagship> {\n    const query: any = { _id: id };\n    if (options?.restrictToPublishedPublic) {\n      query.visibility = 'public';\n      query.status = 'published';\n    }\n\n    const flagship = await this.flagshipModel.findOne(query).exec();\n    if (!flagship) {\n      throw new NotFoundException(`Flagship not found`);\n    }\n\n    if (flagship.images && flagship.images.length > 0) {\n      const imageUrls = await Promise.all(\n        flagship.images.map(async (imageKey) => {\n          return await this.storageService.getSignedUrl(imageKey);\n        }),\n      );\n      flagship.images = imageUrls;\n    }\n\n    if (flagship.detailedPlan) {\n      flagship.detailedPlan = await this.storageService.getSignedUrl(\n        flagship.detailedPlan,\n      );\n    }\n\n    return flagship;\n  }\n\n  private async notifyNewFlagship(flagship: Flagship) {\n    try {\n      const users = await this.userModel\n        .find({ roles: { $ne: 'admin' } })\n        .select('_id')\n        .lean();\n      const userIds = users.map((u) => u._id.toString());\n      if (userIds.length === 0) return;\n\n      await this.notificationService.createForUsers(userIds, {\n        title: 'New Flagship Posted',\n        message: `${flagship.tripName} is now live. Check it out!`,\n        type: 'flagship',\n        link: `/flagship/details?id=${flagship['_id']}`,\n        metadata: { flagshipId: flagship['_id'] },\n      });\n    } catch (error) {\n      console.log('Failed to broadcast flagship notification', error?.message || error);\n    }\n  }\n\n  async update(\n    id: number,\n    updateFlagshipDto: UpdateFlagshipDto,\n  ): Promise<Flagship> {\n    const updatedFlagship = await this.flagshipModel\n      .findByIdAndUpdate(id, updateFlagshipDto, { new: true })\n      .exec();\n    if (!updatedFlagship) {\n      throw new NotFoundException(`Flagship with ID ${id} not found`);\n    }\n    return updatedFlagship;\n  }\n\n  async updateFlagship(\n    id: string,\n    updateDto: UpdateFlagshipDto,\n  ): Promise<Flagship> {\n    const updateData: Partial<UpdateFlagshipDto> = {};\n    const allowedFields: (keyof UpdateFlagshipDto)[] = [\n      'totalSeats',\n      'femaleSeats',\n      'maleSeats',\n      'citySeats',\n      'bedSeats',\n      'mattressSeats',\n      'roomSharingPreference',\n      'tocs',\n      'travelPlan',\n      'locations',\n      'basePrice',\n      'mattressTiers',\n      'tiers',\n      'discounts',\n      'selectedBank',\n      'publish',\n      'status',\n      'tripDates',\n      'registrationDeadline',\n      'advancePaymentDeadline',\n      'earlyBirdDeadline',\n    ];\n\n    allowedFields.forEach((field) => {\n      if (updateDto[field] !== undefined) {\n        (updateData as any)[field] = updateDto[field];\n      }\n    });\n\n    if (updateDto.files && updateDto.files.length > 0) {\n      try {\n        const existingFlagship = await this.flagshipModel.findById(id);\n        if (!existingFlagship) {\n          throw new NotFoundException('Flagship not found');\n        }\n        const imageKeys: string[] = existingFlagship.images || [];\n\n        for (const file of updateDto.files) {\n          try {\n            const webpBuffer = await sharp(file.buffer)\n              .webp({ quality: 80 })\n              .toBuffer();\n\n            const originalName = file.originalname.split('.')[0];\n            const fileKey = `flagship/${id}/${Date.now()}-${originalName}.webp`;\n\n            await this.storageService.uploadFile(\n              fileKey,\n              webpBuffer,\n              'image/webp',\n            );\n\n            imageKeys.push(fileKey);\n          } catch (error) {\n            throw new BadRequestException(\n              `Failed to upload file ${file.originalname}: ${error.message}`,\n            );\n          }\n        }\n\n        updateData['images'] = imageKeys;\n      } catch (error) {\n        if (error instanceof NotFoundException) {\n          throw error;\n        }\n        throw new BadRequestException(\n          `Failed to process file uploads: ${error.message}`,\n        );\n      }\n    }\n\n    if (updateDto.detailedPlanDoc) {\n      const detailedPlanKey = `flagship/${id}/detailed-plan-${Date.now()}-${updateDto.detailedPlanDoc.originalname}`;\n      await this.storageService.uploadFile(\n        detailedPlanKey,\n        updateDto.detailedPlanDoc.buffer,\n        updateDto.detailedPlanDoc.mimetype || 'application/octet-stream',\n      );\n      updateData['detailedPlan'] = detailedPlanKey;\n    }\n\n    const updatedFlagship = await this.flagshipModel.findByIdAndUpdate(\n      id,\n      { $set: updateData },\n      { new: true, runValidators: true },\n    );\n\n    if (!updatedFlagship) {\n      throw new NotFoundException('Flagship not found');\n    }\n\n    return updatedFlagship;\n  }\n\n  async remove(id: number): Promise<Flagship> {\n    const deletedFlagship = await this.flagshipModel\n      .findByIdAndDelete(id)\n      .exec();\n    if (!deletedFlagship) {\n      throw new NotFoundException(`Flagship with ID ${id} not found`);\n    }\n    return deletedFlagship;\n  }\n\n  async sendTripQuery(tripQuery: string, flagshipId: string, user: User) {\n    const flagship = await this.flagshipModel.findById(flagshipId);\n    if (!flagship) {\n      throw new NotFoundException(`Flagship with ID ${flagshipId} not found`);\n    }\n\n    const sent = await this.mailService.sendTripQuery(\n      flagshipId,\n      flagship.tripName,\n      user.fullName,\n      user.email,\n      user.phone,\n      user?.city,\n      tripQuery,\n    );\n\n    if (sent !== true) {\n      // Defensive: mail service should throw on failure, but don't report success if it doesn't.\n      throw new InternalServerErrorException('Failed to send trip query');\n    }\n\n    return 'Trip query sent successfully.';\n  }\n\n  // TODOS\n  async findRegisteredUsers(id: string, search: string) {\n    const searchCriteria = search\n      ? { fullName: { $regex: search, $options: 'i' } }\n      : {};\n\n    const registrations = await this.registerationModel\n      .find({ flagship: id })\n      .populate({\n        path: 'user',\n        model: 'User',\n        match: {\n          ...searchCriteria,\n          'verification.status': VerificationStatus.VERIFIED,\n        },\n      })\n      .exec();\n\n    const filteredRegistrations = registrations.filter(\n      (registration) => registration.user !== null,\n    );\n\n    return filteredRegistrations;\n  }\n\n  async findPendingVerificationUsers(id: string) {\n    const verificationStatuses = ['pending'];\n\n    const registrations = await this.registerationModel\n      .find({ flagship: id })\n      .populate({\n        path: 'user',\n        model: 'User',\n        match: { 'verification.status': { $in: verificationStatuses } },\n      })\n      .exec();\n\n    const filteredRegistrations = registrations.filter(\n      (registration) => registration.user !== null,\n    );\n\n    return filteredRegistrations;\n  }\n\n  async findPaidUsers(id: string, paymentType: string) {\n    const registrations = await this.registerationModel\n      .find({ flagship: id })\n      .populate({ path: 'user', model: 'User' })\n      .lean()\n      .exec();\n\n    if (!registrations || registrations.length === 0) return [];\n\n    const registrationIds = registrations.map((r: any) => r._id);\n    const approvedPayments = await this.paymentModel\n      .find({\n        registration: { $in: registrationIds },\n        status: 'approved',\n        paymentType,\n      })\n      .sort({ createdAt: -1 })\n      .lean()\n      .exec();\n\n    const latestByRegistration = new Map<string, any>();\n    for (const payment of approvedPayments) {\n      const regId = String((payment as any).registration);\n      if (!latestByRegistration.has(regId)) {\n        latestByRegistration.set(regId, payment);\n      }\n    }\n\n    return registrations\n      .map((r: any) => ({\n        ...r,\n        payment: latestByRegistration.get(String(r._id)) || null,\n      }))\n      .filter((r: any) => r.payment);\n  }\n\n  async getRegistrationByID(id: string) {\n    const registration = await this.registerationModel\n      .findOne({ _id: id })\n      .populate({ path: 'user', model: 'User' })\n      .exec();\n\n    if (!registration) {\n      throw new NotFoundException('Registration Not Found');\n    }\n\n    return registration;\n  }\n\n  async getRegisterationStats(id: string) {\n    const flagship = await this.flagshipModel.findById(id);\n    if (!flagship) {\n      throw new NotFoundException(`Flagship with ID ${id} not found`);\n    }\n\n    // Get all registrations for this flagship\n    const registrations = await this.registerationModel\n      .find({ flagship: id })\n      .populate({ path: 'user', model: 'User' })\n      .populate({\n        path: 'paymentId',\n        model: 'Payment',\n        match: { status: 'approved' },\n      })\n      .exec();\n\n    // Get all registrations for all flagships to check if users are returning\n    const allRegistrations = await this.registerationModel\n      .find({ flagship: { $ne: id } })\n      .populate({ path: 'user', model: 'User' })\n      .exec();\n\n    // Create a set of user IDs who have registered for other flagships\n    const returningUserIds = new Set(\n      allRegistrations.map((reg) => reg.user?._id.toString()),\n    );\n\n    // Count new and returning users\n    let newUsersCount = 0;\n    let returningUsersCount = 0;\n\n    registrations.forEach((reg) => {\n      if (reg.user?._id) {\n        if (returningUserIds.has(reg.user._id.toString())) {\n          returningUsersCount++;\n        } else {\n          newUsersCount++;\n        }\n      }\n    });\n\n    // Calculate days until start\n    const startDate = new Date(flagship.startDate);\n    const today = new Date();\n    const daysUntilStart = Math.ceil(\n      (startDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24),\n    );\n\n    const pendingCount = registrations.filter(\n      (reg) => reg.status === 'pending',\n    ).length;\n    const acceptedCount = registrations.filter(\n      (reg) => reg.status === 'confirmed',\n    ).length;\n    const rejectedCount = registrations.filter(\n      (reg) => reg.status === 'rejected',\n    ).length;\n    const paidCount = registrations.filter(\n      (reg) => reg.payment !== null,\n    ).length;\n\n    // Get city seats\n    const citySeats = flagship.citySeats as Record<string, number>;\n    const lahoreSeats = citySeats?.lahore || 0;\n    const islamabadSeats = citySeats?.islamabad || 0;\n    const karachiSeats = citySeats?.karachi || 0;\n\n    // Calculate gender distribution\n    const maleCount = registrations.filter(\n      (reg) => reg.user?.gender === 'male',\n    ).length;\n    const femaleCount = registrations.filter(\n      (reg) => reg.user?.gender === 'female',\n    ).length;\n    const maleSeats = flagship.maleSeats || 0;\n    const femaleSeats = flagship.femaleSeats || 0;\n\n    // Calculate age distribution\n    const ageRanges = {\n      '0-9': 0,\n      '10-19': 0,\n      '20-29': 0,\n      '30-39': 0,\n      '40-49': 0,\n      '50+': 0,\n    };\n\n    registrations.forEach((reg) => {\n      if (reg.user?.dateOfBirth) {\n        const birthDate = new Date(reg.user.dateOfBirth);\n        const age = today.getFullYear() - birthDate.getFullYear();\n\n        if (age < 10) ageRanges['0-9']++;\n        else if (age < 20) ageRanges['10-19']++;\n        else if (age < 30) ageRanges['20-29']++;\n        else if (age < 40) ageRanges['30-39']++;\n        else if (age < 50) ageRanges['40-49']++;\n        else ageRanges['50+']++;\n      }\n    });\n\n    // Get top universities\n    const universityCounts = registrations.reduce(\n      (acc, reg) => {\n        if (reg.user?.university) {\n          acc[reg.user.university] = (acc[reg.user.university] || 0) + 1;\n        }\n        return acc;\n      },\n      {} as Record<string, number>,\n    );\n\n    const topUniversities = Object.entries(universityCounts)\n      .sort(([, a], [, b]) => b - a)\n      .slice(0, 3)\n      .map(([university, count]) => ({ university, count }));\n\n    return {\n      flagshipName: flagship.tripName,\n      daysUntilStart,\n      totalRegistrations: registrations.length,\n      pendingCount,\n      acceptedCount,\n      rejectedCount,\n      paidCount,\n      teamSeats: flagship.totalSeats || 0,\n      lahoreSeats,\n      islamabadSeats,\n      karachiSeats,\n      maleCount,\n      femaleCount,\n      maleSeats,\n      femaleSeats,\n      ageDistribution: ageRanges,\n      topUniversities,\n      newUsersCount,\n      returningUsersCount,\n    };\n  }\n\n  async gePaymentStats(id: string) {}\n\n  async approveRegisteration(id: string, comment: string) {\n    const registration: any = await this.registerationModel.findById(id);\n    if (!registration) {\n      throw new NotFoundException(`Registration with ID ${id} not found`);\n    }\n\n    const currentStatus = registration.status;\n    const lockedStatuses = new Set([\n      'confirmed',\n      'completed',\n      'refunded',\n      'refundProcessing',\n    ]);\n    if (!lockedStatuses.has(currentStatus)) {\n      registration.status = 'accepted';\n    }\n\n    registration.comment = comment;\n\n    return registration.save();\n  }\n\n  async rejectRegisteration(id: string, comment: string) {\n    const updatedRegistration = await this.registerationModel.findByIdAndUpdate(\n      id,\n      {\n        status: 'rejected',\n        comment: comment,\n      },\n      { new: true },\n    );\n\n    if (!updatedRegistration) {\n      throw new NotFoundException(`Registration with ID ${id} not found`);\n    }\n\n    return updatedRegistration;\n  }\n\n  async didntPickRegistration(id: string, comment: string) {\n    const updatedRegistration = await this.registerationModel.findByIdAndUpdate(\n      id,\n      {\n        status: 'didntPick',\n        comment: comment,\n      },\n      { new: true },\n    );\n\n    if (!updatedRegistration) {\n      throw new NotFoundException(`Registration with ID ${id} not found`);\n    }\n\n    return updatedRegistration;\n  }\n\n  async verifyUser(id: string, comment: string) {\n    const user = await this.userModel.findById(id);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    user.verification.status = VerificationStatus.VERIFIED;\n    user.verification.VerificationDate = new Date();\n    user.verification.method = user.verification.method || 'admin';\n    user.markModified('verification');\n    const savedUser = await user.save();\n\n    if (user.email) {\n      try {\n        await this.mailService.sendVerificationApprovedEmail(\n          user.email,\n          user.fullName || 'Musafir',\n        );\n      } catch (error) {\n        console.log('Failed to send verification approved email:', error);\n      }\n    }\n\n    try {\n      await this.notificationService.ensureVerificationStatusNotification(\n        user._id.toString(),\n        VerificationStatus.VERIFIED,\n        {\n          comment,\n          metadata: { source: 'admin_override' },\n        },\n      );\n    } catch (error) {\n      console.log('Failed to send verification status notification:', error);\n    }\n\n    try {\n      await this.userService.awardVerificationReferralCredits(user._id.toString());\n    } catch (error) {\n      console.log('Failed to award verification referral credits:', error);\n    }\n\n    return savedUser;\n  }\n\n  async rejectVerification(id: string, comment: string) {\n    const user = await this.userModel.findById(id);\n    if (!user) {\n      throw new NotFoundException('User not found');\n    }\n\n    user.verification.status = VerificationStatus.REJECTED;\n    user.verification.VerificationDate = undefined;\n    user.verification.RequestCall = false;\n    user.verification.method = user.verification.method || 'admin';\n    user.markModified('verification');\n    const savedUser = await user.save();\n\n    if (user.email) {\n      try {\n        await this.mailService.sendVerificationRejectedEmail(\n          user.email,\n          user.fullName || 'Musafir',\n        );\n      } catch (error) {\n        console.log('Failed to send verification rejected email:', error);\n      }\n    }\n\n    try {\n      await this.notificationService.ensureVerificationStatusNotification(\n        user._id.toString(),\n        VerificationStatus.REJECTED,\n        {\n          comment,\n          metadata: { source: 'admin_override' },\n        },\n      );\n    } catch (error) {\n      console.log('Failed to send verification status notification:', error);\n    }\n\n    return savedUser;\n  }\n\n  async getPastTrips() {\n    const currentDate = new Date();\n    const pastTrips = await this.flagshipModel\n      .find({\n        endDate: { $lt: currentDate },\n      })\n      .sort({ endDate: -1 })\n      .exec();\n\n    const processedFlagships = await Promise.all(\n      pastTrips.map(async (flagship) => this.attachSignedImages(flagship)),\n    );\n\n    return processedFlagships;\n  }\n\n  async getLiveTrips() {\n    const liveTrips = await this.flagshipModel\n      .find({\n        startDate: { $lte: new Date() },\n        endDate: { $gte: new Date() },\n      })\n      .sort({ startDate: 1 });\n\n    const processedFlagships = await Promise.all(\n      liveTrips.map(async (flagship) => this.attachSignedImages(flagship)),\n    );\n\n    return processedFlagships;\n  }\n\n  async getUpcomingTrips() {\n    const upcomingTrips = await this.flagshipModel\n      .find({\n        startDate: { $gt: new Date() },\n      })\n      .sort({ startDate: 1 });\n\n    const processedFlagships = await Promise.all(\n      upcomingTrips.map(async (flagship) => this.attachSignedImages(flagship)),\n    );\n\n    return processedFlagships;\n  }\n\n  /**\n   * Safely attach signed image URLs; on failure, fall back to original keys.\n   */\n  private async attachSignedImages(flagship: any) {\n    const flagshipObj = flagship.toObject();\n\n    if (flagship.images && flagship.images.length > 0) {\n      const imageUrls = await Promise.all(\n        flagship.images.map(async (imageKey) => {\n          try {\n            return await this.storageService.getSignedUrl(imageKey);\n          } catch (error) {\n            // Avoid hard-failing if signing fails (e.g., missing AWS creds).\n            console.error('Failed to sign image URL', { imageKey, error });\n            return imageKey;\n          }\n        }),\n      );\n      flagshipObj.images = imageUrls;\n    }\n\n    return flagshipObj;\n  }\n}\n"],"version":3}