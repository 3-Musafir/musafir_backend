{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/registration/registration.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/registration/registration.service.ts"],"sourcesContent":["import {\n  Injectable,\n  NotFoundException,\n  BadRequestException,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { CreateRegistrationDto } from './dto/create-registration.dto';\nimport { Registration } from './interfaces/registration.interface';\nimport { User } from 'src/user/interfaces/user.interface';\nimport { MailService } from 'src/mail/mail.service';\nimport mongoose from 'mongoose';\nimport { StorageService } from 'src/storage/storageService';\nimport { NotificationService } from 'src/notifications/notification.service';\nimport { REFUND_POLICY_LINK } from 'src/payment/refund-policy.util';\n\n@Injectable()\nexport class RegistrationService {\n  constructor(\n    @InjectModel('Registration') private readonly registrationModel: Model<Registration>,\n    @InjectModel('User') private readonly userModel: Model<User>,\n    @InjectModel('Flagship') private readonly flagshipModel: Model<any>,\n    private readonly storageService: StorageService,\n    private readonly mailService: MailService,\n    private readonly notificationService: NotificationService,\n  ) { }\n\n  private async syncCompletedRegistrationsForUser(userId: string): Promise<void> {\n    const now = new Date();\n\n    // Registrations are marked \"confirmed\" when payment is approved.\n    // Once the trip has ended, we treat them as \"completed\".\n    const confirmedRegs = await this.registrationModel\n      .find({ userId, status: 'confirmed' })\n      .populate('flagship')\n      .exec();\n\n    const toCompleteIds = confirmedRegs\n      .filter((r: any) => {\n        const endDate = r?.flagship?.endDate;\n        return endDate && new Date(endDate) < now;\n      })\n      .map((r) => r._id);\n\n    if (toCompleteIds.length > 0) {\n      await this.registrationModel.updateMany(\n        { _id: { $in: toCompleteIds } },\n        { $set: { status: 'completed' } },\n      );\n    }\n  }\n\n  private async updateUserTripStats(userId: string): Promise<void> {\n    const attendedCount = await this.registrationModel.countDocuments({\n      userId,\n      status: 'completed',\n    });\n\n    await this.userModel.findByIdAndUpdate(userId, {\n      numberOfFlagshipsAttended: attendedCount,\n      discountApplicable: attendedCount * 500,\n    });\n  }\n\n  async createRegistration(registration: CreateRegistrationDto, userId: string): Promise<{ registrationId: string, message: string }> {\n    try {\n      const user = await this.userModel.findById(userId);\n      if (!user) {\n        throw new NotFoundException(`User with ID ${userId} not found`);\n      }\n\n      const flagship = await this.flagshipModel.findById(registration.flagshipId);\n      if (!flagship) {\n        throw new NotFoundException(`Flagship with ID ${registration.flagshipId} not found`);\n      }\n\n      const newRegistration = new this.registrationModel({\n        ...registration,\n        amountDue: registration.price,\n        userId: userId,\n        user: user,\n        flagship: new mongoose.Types.ObjectId(registration.flagshipId)\n      });\n\n      const createdRegistration = await newRegistration.save();\n\n      \n      try {\n        const populatedRegistration = await this.registrationModel\n          .findById(createdRegistration._id)\n          .populate('user')\n          .populate('flagship')\n          .exec();\n\n        const reg: any = populatedRegistration;\n        const regUser = reg?.user;\n        const regFlagship = reg?.flagship;\n\n        await this.mailService.sendAdminRegistrationNotification({\n          registrationId: String(createdRegistration._id),\n          flagshipId: String(registration.flagshipId),\n          flagshipName: regFlagship?.tripName,\n          userName: regUser?.fullName || 'Musafir',\n          userEmail: regUser?.email,\n          userPhone: regUser?.phone,\n          userCity: regUser?.city,\n          joiningFromCity: registration.joiningFromCity,\n          tier: registration.tier,\n          bedPreference: registration.bedPreference,\n          roomSharing: registration.roomSharing,\n          groupMembers: registration.groupMembers,\n          expectations: registration.expectations,\n          tripType: registration.tripType,\n          price: registration.price,\n          amountDue: registration.price,\n          createdAt: createdRegistration.createdAt,\n          startDate: regFlagship?.startDate,\n          endDate: regFlagship?.endDate,\n          destination: regFlagship?.destination,\n          category: regFlagship?.category,\n        });\n      } catch (e) {\n        console.log('Failed to send admin registration notification:', e);\n      }\n\n      return {\n        registrationId: createdRegistration._id,\n        message: \"Registration created successfully.\"\n      }\n    } catch (error) {\n      console.error('Registration error:', error);\n      throw error;\n    }\n  }\n\n  async getPastPassport(userId: string) {\n    try {\n      // Keep status + user stats in sync before returning passport data\n      await this.syncCompletedRegistrationsForUser(userId);\n      await this.updateUserTripStats(userId);\n\n      return await this.registrationModel.find({\n        status: { $in: [\"completed\", \"refunded\"] },\n        userId: userId\n      })\n        .populate('flagshipId')\n        .populate('ratingId')\n        .exec();\n    } catch (error) {\n      throw new Error(`Failed to fetch past passport data: ${error.message}`);\n    }\n  }\n\n  async getUpcomingPassport(userId: string) {\n    try {\n      // Keep status + user stats in sync before returning passport data\n      await this.syncCompletedRegistrationsForUser(userId);\n      await this.updateUserTripStats(userId);\n\n      const now = new Date();\n      const registrations = await this.registrationModel.find({\n        status: { $nin: [\"completed\", \"refunded\"] },\n        userId: userId\n      })\n        .populate({\n          path: 'flagship',\n          match: { endDate: { $gte: now } },\n        })\n        .populate({\n          path: 'paymentId',\n          select: 'status amount paymentType discount createdAt',\n        })\n        .exec();\n\n      const upcomingOnly = registrations.filter((r: any) => r?.flagship);\n\n      return await Promise.all(\n        upcomingOnly.map(async (registration) => {\n          const price = (registration as any)?.price;\n          const amountDue = (registration as any)?.amountDue;\n          const status = String((registration as any)?.status || '');\n          const hasApprovedPayment =\n            typeof price === 'number' &&\n            typeof amountDue === 'number' &&\n            amountDue < price;\n\n          if (status === 'accepted') {\n            (registration as any).status = hasApprovedPayment ? 'confirmed' : 'pending';\n          } else if (status === 'notReserved' && hasApprovedPayment) {\n            (registration as any).status = 'confirmed';\n          }\n\n          if (registration.flagship.images && registration.flagship.images.length > 0) {\n            const imageUrls = await Promise.all(\n              registration.flagship.images.map(async (imageKey) => {\n                return await this.storageService.getSignedUrl(imageKey);\n              }),\n            );\n            registration.flagship.images = imageUrls;\n          }\n\n          if (registration.flagship.detailedPlan) {\n            registration.flagship.detailedPlan = await this.storageService.getSignedUrl(\n              registration.flagship.detailedPlan,\n            );\n          }\n          return registration;\n        }));\n    } catch (error) {\n      throw new Error(`Failed to fetch upcoming passport data: ${error.message}`);\n    }\n  }\n\n  async getRegistrationById(registrationId: string) {\n    try {\n      if (!registrationId) {\n        throw new Error(\"Registration ID is required\");\n      }\n\n      const registration = await this.registrationModel.findById(registrationId)\n        .populate('flagship')\n        .populate('user')\n        .populate({\n          path: 'paymentId',\n          select: 'status amount paymentType discount createdAt',\n        })\n        .exec();\n\n      if (registration.flagship.images.length > 0) {\n        registration.flagship.images = await Promise.all(\n          registration.flagship.images.map(async (imageKey) => {\n            return await this.storageService.getSignedUrl(imageKey);\n          })\n        )\n      }\n\n      return registration;\n    } catch (error) {\n      throw new Error(`Failed to fetch registration data: ${error.message}`);\n    }\n  }\n\n  async cancelSeat(registrationId: string, user: User) {\n    const userId = user?._id?.toString();\n    if (!userId) {\n      throw new BadRequestException({\n        message: 'Authentication required.',\n        code: 'cancel_auth_required',\n      });\n    }\n\n    const registration: any = await this.registrationModel\n      .findById(registrationId)\n      .lean()\n      .exec();\n    if (!registration) {\n      throw new NotFoundException('Registration not found');\n    }\n\n    const registrationUserId = registration.userId || registration.user;\n    if (!registrationUserId || String(registrationUserId) !== String(userId)) {\n      throw new ForbiddenException('You can only cancel your own seat.');\n    }\n\n    const status = String(registration.status || '');\n    if (status !== 'confirmed') {\n      throw new BadRequestException({\n        message: 'Only confirmed seats can be cancelled.',\n        code: 'cancel_not_eligible',\n      });\n    }\n\n    const updated = await this.registrationModel.findOneAndUpdate(\n      { _id: registration._id, userId: registrationUserId, status: 'confirmed' },\n      { $set: { status: 'cancelled' } },\n      { new: true },\n    );\n\n    if (!updated) {\n      throw new BadRequestException({\n        message: 'Seat could not be cancelled. Please retry.',\n        code: 'cancel_state_changed',\n      });\n    }\n\n    try {\n      const flagshipId = registration.flagship || registration.flagshipId;\n      const flagship = await this.flagshipModel\n        .findById(flagshipId)\n        .select('tripName')\n        .lean()\n        .exec();\n      const tripName = Array.isArray(flagship)\n        ? (flagship?.[0] as any)?.tripName || 'your trip'\n        : (flagship as any)?.tripName || 'your trip';\n\n      await this.notificationService.createForUser(userId, {\n        title: 'Seat cancelled',\n        message: `Your seat for ${tripName} has been cancelled. You can request a refund based on the refund policy.`,\n        type: 'refund',\n        link: `/musafir/refund/${registrationId}`,\n        metadata: { registrationId: String(registrationId), policyLink: REFUND_POLICY_LINK },\n      });\n\n      if ((user as any)?.email) {\n        await this.mailService.sendMail(\n          (user as any).email,\n          'Your 3Musafir seat has been cancelled',\n          './seat-cancelled',\n          {\n            fullName: (user as any).fullName || 'Musafir',\n            tripName,\n            refundPolicyLink: REFUND_POLICY_LINK,\n            refundUrl:\n              process.env.FRONTEND_URL && registrationId\n                ? `${process.env.FRONTEND_URL}/musafir/refund/${registrationId}`\n                : undefined,\n          },\n        );\n      }\n    } catch (e) {\n      console.log('Failed to send cancellation comms:', e);\n    }\n\n    return updated;\n  }\n\n\n\n  async sendReEvaluateRequestToJury(registrationId: string, user: User) {\n    try {\n      const registration = await this.getRegistrationById(registrationId);\n      const tripName = typeof registration.flagshipId === 'object' ? registration.flagshipId.tripName : '';\n      await this.mailService.sendReEvaluateRequestToJury(registrationId, tripName, user.fullName, user.email, user.phone, user?.city);\n      return \"Re-evaluate request sent to jury successfully.\";\n\n    } catch (error) {\n      throw new Error(`Failed to send the re-evalute request to jury: ${error.message}`);\n    }\n  }\n} \n"],"version":3}