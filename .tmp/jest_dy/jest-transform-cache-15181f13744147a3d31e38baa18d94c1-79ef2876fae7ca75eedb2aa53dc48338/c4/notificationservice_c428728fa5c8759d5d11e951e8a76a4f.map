{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/notifications/notification.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/notifications/notification.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport { Model } from 'mongoose';\nimport { Notification } from './interfaces/notification.interface';\nimport { NotificationsGateway } from './notifications.gateway';\nimport { NotificationDto, NotificationListResponse } from './dto/notification.dto';\nimport {\n  ProfileStatus,\n  describeMissingProfileFields,\n} from 'src/user/profile-status.util';\n\ninterface CreateNotificationPayload {\n  title: string;\n  message: string;\n  type?: string;\n  link?: string;\n  metadata?: Record<string, any>;\n}\n\ninterface ListQuery {\n  page?: number;\n  limit?: number;\n  read?: boolean;\n}\n\n@Injectable()\nexport class NotificationService {\n  private readonly profileReminderKind = 'profile_completion';\n  private readonly verificationStatusKind = 'verification_status';\n\n  constructor(\n    @InjectModel('Notification')\n    private readonly notificationModel: Model<Notification>,\n    private readonly gateway: NotificationsGateway,\n  ) {}\n\n  async createForUsers(userIds: string[], payload: CreateNotificationPayload) {\n    if (!userIds || userIds.length === 0) return [];\n\n    const docs = userIds.map((userId) => ({\n      userId,\n      title: payload.title,\n      message: payload.message,\n      type: payload.type || 'general',\n      link: payload.link,\n      metadata: payload.metadata,\n    }));\n    const created = await this.notificationModel.insertMany(docs);\n\n    const dtoList = created.map((doc) => {\n      const dto = this.toDto(doc);\n      this.gateway.sendNewNotification(String((doc as any).userId), dto);\n      return dto;\n    });\n\n    return dtoList;\n  }\n\n  async createForUser(userId: string, payload: CreateNotificationPayload) {\n    const created = new this.notificationModel({\n      userId,\n      title: payload.title,\n      message: payload.message,\n      type: payload.type || 'general',\n      link: payload.link,\n      metadata: payload.metadata,\n    });\n    const saved = await created.save();\n    const dto = this.toDto(saved);\n    this.gateway.sendNewNotification(userId, dto);\n    return dto;\n  }\n\n  async ensureProfileCompletionReminder(\n    userId: string,\n    profileStatus?: ProfileStatus,\n  ) {\n    if (!userId || !profileStatus) return null;\n\n    const link = '/userSettings';\n\n    const missingFields =\n      profileStatus.requiredFor?.general && profileStatus.requiredFor.general.length > 0\n        ? profileStatus.requiredFor.general\n        : profileStatus.missing || [];\n\n    if (profileStatus.complete || missingFields.length === 0) {\n      await this.resolveProfileReminder(userId);\n      return null;\n    }\n\n    const missingLabels = describeMissingProfileFields(missingFields as any);\n    const message =\n      missingLabels.length > 0\n        ? `Please complete your profile details: ${missingLabels.join(', ')}.`\n        : 'Please complete your profile details.';\n    const metadata = {\n      kind: this.profileReminderKind,\n      missingFields,\n      missingFieldLabels: missingLabels,\n    };\n\n    const existing = await this.notificationModel.findOne({\n      userId,\n      'metadata.kind': this.profileReminderKind,\n    });\n\n    if (existing) {\n      const existingMissing = Array.isArray((existing as any).metadata?.missingFields)\n        ? (existing as any).metadata.missingFields\n        : [];\n      const needsUpdate =\n        !this.arraysEqual(existingMissing, missingFields) ||\n        existing.message !== message ||\n        !existing.title;\n\n      if (!needsUpdate && !existing.readAt) {\n        return this.toDto(existing);\n      }\n\n      existing.title = existing.title || 'Complete your profile';\n      existing.message = message;\n      existing.type = existing.type || 'general';\n      existing.link = existing.link || link;\n      (existing as any).metadata = { ...(existing as any).metadata, ...metadata };\n      existing.readAt = null;\n\n      const saved = await existing.save();\n      const dto = this.toDto(saved);\n      this.gateway.sendNewNotification(userId, dto);\n      return dto;\n    }\n\n    const created = new this.notificationModel({\n      userId,\n      title: 'Complete your profile',\n      message,\n      type: 'general',\n      link,\n      metadata,\n    });\n    const saved = await created.save();\n    const dto = this.toDto(saved);\n    this.gateway.sendNewNotification(userId, dto);\n    return dto;\n  }\n\n  async ensureVerificationStatusNotification(\n    userId: string,\n    status: string,\n    options?: { comment?: string; link?: string; metadata?: Record<string, any> },\n  ) {\n    if (!userId || !status) return null;\n\n    const normalizedStatus = String(status);\n    const type = 'verification';\n    const link =\n      options?.link ??\n      (normalizedStatus === 'verified' ? '/home' : '/verification');\n\n    let title = 'Verification update';\n    let message = 'Your verification status has been updated.';\n\n    if (normalizedStatus === 'verified') {\n      title = 'Verification approved';\n      message = 'You are now verified. You can proceed to payments and seat confirmation.';\n    } else if (normalizedStatus === 'pending') {\n      title = 'Verification pending';\n      message = 'Your verification request is under review. We’ll notify you once it’s decided.';\n    } else if (normalizedStatus === 'rejected') {\n      title = 'Verification rejected';\n      message =\n        'Your verification was rejected. Please resubmit your verification details to proceed.';\n    } else if (normalizedStatus === 'unverified') {\n      title = 'Verification required';\n      message =\n        'Your account is not verified. Complete verification to proceed to payments.';\n    }\n\n    const metadata = {\n      kind: this.verificationStatusKind,\n      status: normalizedStatus,\n      ...(options?.comment ? { comment: options.comment } : {}),\n      ...(options?.metadata || {}),\n    };\n\n    const existing = await this.notificationModel.findOne({\n      userId,\n      'metadata.kind': this.verificationStatusKind,\n    });\n\n    if (existing) {\n      existing.title = title;\n      existing.message = message;\n      existing.type = type;\n      existing.link = link;\n      (existing as any).metadata = { ...(existing as any).metadata, ...metadata };\n      existing.readAt = null;\n\n      const saved = await existing.save();\n      const dto = this.toDto(saved);\n      this.gateway.sendNewNotification(userId, dto);\n      return dto;\n    }\n\n    const created = new this.notificationModel({\n      userId,\n      title,\n      message,\n      type,\n      link,\n      metadata,\n    });\n    const saved = await created.save();\n    const dto = this.toDto(saved);\n    this.gateway.sendNewNotification(userId, dto);\n    return dto;\n  }\n\n  async listForUser(userId: string, query: ListQuery = {}): Promise<NotificationListResponse> {\n    const page = Math.max(1, query.page || 1);\n    const limit = Math.max(1, Math.min(50, query.limit || 20));\n    const filter: Record<string, any> = { userId };\n    if (typeof query.read === 'boolean') {\n      filter.readAt = query.read ? { $ne: null } : null;\n    }\n\n    const [items, unreadCount] = await Promise.all([\n      this.notificationModel\n        .find(filter)\n        .sort({ createdAt: -1 })\n        .skip((page - 1) * limit)\n        .limit(limit)\n        .lean(),\n      this.notificationModel.countDocuments({ userId, readAt: null }),\n    ]);\n\n    return {\n      items: items.map((item) => this.toDto(item)),\n      unreadCount,\n    };\n  }\n\n  async markRead(userId: string, notificationId: string) {\n    const notification = await this.notificationModel.findOneAndUpdate(\n      { _id: notificationId, userId },\n      { $set: { readAt: new Date() } },\n      { new: true },\n    );\n    if (!notification) {\n      throw new NotFoundException('Notification not found');\n    }\n    const dto = this.toDto(notification);\n    this.gateway.sendRead(userId, dto.id);\n    return dto;\n  }\n\n  async markAllRead(userId: string) {\n    const res = await this.notificationModel.updateMany(\n      { userId, readAt: null },\n      { $set: { readAt: new Date() } },\n    );\n    this.gateway.sendReadAll(userId);\n    return { updated: true, matched: res.matchedCount ?? res.modifiedCount };\n  }\n\n  private async resolveProfileReminder(userId: string) {\n    await this.notificationModel.updateMany(\n      { userId, 'metadata.kind': this.profileReminderKind, readAt: null },\n      { $set: { readAt: new Date() } },\n    );\n  }\n\n  private arraysEqual(a: string[], b: string[]) {\n    if (!Array.isArray(a) || !Array.isArray(b)) {\n      return false;\n    }\n    if (a.length !== b.length) {\n      return false;\n    }\n    return a.every((value, index) => value === b[index]);\n  }\n\n  private toDto(notification: any): NotificationDto {\n    return {\n      id: notification._id.toString(),\n      title: notification.title,\n      message: notification.message,\n      type: notification.type,\n      link: notification.link,\n      metadata: notification.metadata,\n      createdAt: notification.createdAt,\n      readAt: notification.readAt,\n    };\n  }\n}\n"],"version":3}