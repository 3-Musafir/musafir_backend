{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/refund-settlement/refund-settlement.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/refund-settlement/refund-settlement.service.ts"],"sourcesContent":["import { BadRequestException, Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport mongoose, { Model } from 'mongoose';\nimport { PK_TIMEZONE } from 'src/wallet/wallet.constants';\nimport { WalletService } from 'src/wallet/wallet.service';\nimport dayjs = require('dayjs');\nimport utc = require('dayjs/plugin/utc');\nimport timezone = require('dayjs/plugin/timezone');\nimport { RefundSettlement } from './interfaces/refund-settlement.interface';\n\ndayjs.extend(utc);\ndayjs.extend(timezone);\n\n@Injectable()\nexport class RefundSettlementService {\n  constructor(\n    @InjectModel('RefundSettlement')\n    private readonly settlementModel: Model<RefundSettlement>,\n    private readonly walletService: WalletService,\n  ) {}\n\n  endOfNextCalendarYearPKT(from: Date = new Date()) {\n    return dayjs(from).tz(PK_TIMEZONE).add(1, 'year').endOf('year').toDate();\n  }\n\n  async ensureSettlement(params: {\n    refundId: string;\n    userId: string;\n    amount: number;\n    status: 'pending' | 'posted';\n    postedBy?: string;\n    postedAt?: Date;\n    metadata?: Record<string, any>;\n  }) {\n    const amount = Math.max(0, Math.floor(Number(params.amount) || 0));\n    const refundObjectId = new mongoose.Types.ObjectId(params.refundId);\n\n    const update: any = {\n      userId: params.userId,\n      amount,\n      method: 'wallet_credit',\n      status: params.status,\n      metadata: params.metadata,\n    };\n    if (params.postedBy) update.postedBy = params.postedBy;\n    if (params.postedAt) update.postedAt = params.postedAt;\n\n    const settlement = await this.settlementModel\n      .findOneAndUpdate(\n        { refundId: refundObjectId, method: 'wallet_credit' },\n        { $setOnInsert: { refundId: refundObjectId }, $set: update },\n        { upsert: true, new: true },\n      )\n      .lean()\n      .exec();\n\n    return settlement;\n  }\n\n  async postToWallet(params: { refundId: string; userId: string; amount: number; postedBy?: string }) {\n    const amount = Math.max(0, Math.floor(Number(params.amount) || 0));\n    if (amount <= 0) {\n      throw new BadRequestException({\n        message: 'Refund amount is 0; nothing to credit.',\n        code: 'refund_credit_zero',\n      });\n    }\n\n    const expiresAt = this.endOfNextCalendarYearPKT();\n    await this.walletService.credit({\n      userId: params.userId,\n      amount,\n      type: 'refund_credit',\n      sourceId: params.refundId,\n      sourceType: 'refund_settlement',\n      expiresAt,\n      postedBy: params.postedBy,\n      metadata: {\n        sourceId: params.refundId,\n        refundId: params.refundId,\n        expiresAt: expiresAt.toISOString(),\n      },\n    });\n  }\n\n  async findByRefundIds(refundIds: string[]) {\n    const ids = (refundIds || []).filter(Boolean).map((id) => new mongoose.Types.ObjectId(id));\n    if (ids.length === 0) return [];\n    return this.settlementModel\n      .find({ refundId: { $in: ids } })\n      .lean()\n      .exec();\n  }\n\n  async listPending() {\n    return this.settlementModel\n      .find({ status: 'pending' })\n      .sort({ createdAt: -1 })\n      .lean()\n      .exec();\n  }\n}\n"],"version":3}