{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.ts"],"sourcesContent":["import { BadRequestException, ForbiddenException, Injectable } from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport mongoose, { Model } from 'mongoose';\nimport { BankAccount, Payment } from './interface/payment.interface';\nimport {\n  CreateBankAccountDto,\n  CreatePaymentDto,\n  GetRefundsQueryDto,\n  RequestRefundDto,\n} from './dto/payment.dto';\nimport { StorageService } from 'src/storage/storageService';\nimport { User } from 'src/user/interfaces/user.interface';\nimport { Flagship } from 'src/flagship/interfaces/flagship.interface';\nimport { Refund } from './schema/refund.schema';\nimport { Registration } from 'src/registration/interfaces/registration.interface';\nimport { MailService } from 'src/mail/mail.service';\nimport { VerificationStatus } from 'src/constants/verification-status.enum';\nimport { NotificationService } from 'src/notifications/notification.service';\nimport { computeRefundQuote } from './refund-policy.util';\nimport { RefundSettlementService } from 'src/refund-settlement/refund-settlement.service';\nimport { isWalletTxIdempotent, WalletService } from 'src/wallet/wallet.service';\n\n@Injectable()\nexport class PaymentService {\n  constructor(\n    @InjectModel('Payment')\n    private readonly paymentModel: Model<Payment>,\n    @InjectModel('User')\n    private readonly user: Model<User>,\n    @InjectModel('BankAccount')\n    private readonly bankAccountModel: Model<BankAccount>,\n    @InjectModel('Flagship')\n    private readonly flagshipModel: Model<Flagship>,\n    @InjectModel('Registration')\n    private readonly registrationModel: Model<Registration>,\n    @InjectModel('Refund')\n    private readonly refundModel: Model<Refund>,\n    private readonly storageService: StorageService,\n    private readonly mailService: MailService,\n    private readonly notificationService: NotificationService,\n    private readonly walletService: WalletService,\n    private readonly refundSettlementService: RefundSettlementService,\n  ) { }\n\n  private assertUserVerifiedForPayment(user: User) {\n    const status = (user as any)?.verification?.status;\n    if (status === VerificationStatus.VERIFIED) return;\n    if (status === VerificationStatus.PENDING) {\n      throw new BadRequestException({\n        message: 'Verification is pending. Please wait for approval before making a payment.',\n        code: 'verification_pending',\n      });\n    }\n    if (status === VerificationStatus.REJECTED) {\n      throw new BadRequestException({\n        message: 'Verification was rejected. Please re-apply before making a payment.',\n        code: 'verification_rejected',\n      });\n    }\n    throw new BadRequestException({\n      message: 'Verification required before making a payment.',\n      code: 'verification_required',\n    });\n  }\n\n  private async updateUserTripStats(userId: string): Promise<void> {\n    const attendedCount = await this.registrationModel.countDocuments({\n      userId,\n      status: 'completed',\n    });\n\n    await this.user.findByIdAndUpdate(userId, {\n      numberOfFlagshipsAttended: attendedCount,\n      discountApplicable: attendedCount * 500,\n    });\n  }\n\n  async getBankAccounts(): Promise<BankAccount[]> {\n    return this.bankAccountModel.find();\n  }\n\n  private getRefundSettlementCollectionName(): string {\n    try {\n      const conn = (this.refundModel as any)?.db;\n      const settlementModel = conn?.model?.('RefundSettlement');\n      const name = settlementModel?.collection?.name;\n      if (typeof name === 'string' && name.trim()) return name;\n    } catch {\n      // ignore\n    }\n    // Mongoose default pluralization for model 'RefundSettlement'\n    return 'refundsettlements';\n  }\n\n  async getRefunds(query?: GetRefundsQueryDto): Promise<any> {\n    const group = query?.group || 'all';\n    const pageRaw = Number((query as any)?.page);\n    const limitRaw = Number((query as any)?.limit);\n    const shouldPaginate =\n      (Number.isFinite(pageRaw) && pageRaw > 0) ||\n      (Number.isFinite(limitRaw) && limitRaw > 0);\n\n    const attachSettlement = async (refunds: any[]) => {\n      const refundIds = refunds\n        .map((r) => r?._id?.toString?.() || String(r?._id))\n        .filter(Boolean) as string[];\n      const settlements = await this.refundSettlementService.findByRefundIds(refundIds);\n      const settlementByRefundId = new Map(\n        settlements.map((s: any) => [s?.refundId?.toString?.() || String(s.refundId), s]),\n      );\n      return refunds.map((r) => ({\n        ...r,\n        settlement: settlementByRefundId.get(String(r._id)) || null,\n      })) as any[];\n    };\n\n    if (!shouldPaginate) {\n      const filter: any = {};\n      if (group === 'pending') filter.status = 'pending';\n      if (group === 'rejected') filter.status = 'rejected';\n      if (group === 'approved_not_credited' || group === 'credited') filter.status = 'cleared';\n\n      const refunds: any[] = await this.refundModel\n        .find(filter)\n        .sort({ createdAt: -1, _id: -1 })\n        .populate({\n          path: 'registration',\n          populate: [{ path: 'user' }, { path: 'flagship' }, { path: 'paymentId' }],\n        })\n        .lean()\n        .exec();\n\n      const withSettlement = await attachSettlement(refunds);\n\n      if (group === 'approved_not_credited') {\n        return withSettlement.filter(\n          (r: any) => r?.status === 'cleared' && r?.settlement?.status !== 'posted',\n        );\n      }\n      if (group === 'credited') {\n        return withSettlement.filter(\n          (r: any) => r?.status === 'cleared' && r?.settlement?.status === 'posted',\n        );\n      }\n      return withSettlement;\n    }\n\n    const limit = Math.max(1, Math.min(100, Number.isFinite(limitRaw) ? limitRaw : 20));\n    const page = Math.max(1, Number.isFinite(pageRaw) ? pageRaw : 1);\n    const skip = (page - 1) * limit;\n\n    const populateRegistration = {\n      path: 'registration',\n      populate: [{ path: 'user' }, { path: 'flagship' }, { path: 'paymentId' }],\n    };\n\n    // For credited and approved_not_credited, filter with settlements at the DB layer\n    // to keep pagination accurate and efficient.\n    if (group === 'credited' || group === 'approved_not_credited') {\n      const settlementCollection = this.getRefundSettlementCollectionName();\n      const settlementMatch =\n        group === 'credited'\n          ? { 'settlement.status': 'posted' }\n          : { $or: [{ 'settlement.status': { $ne: 'posted' } }, { settlement: null }] };\n\n      const agg = await (this.refundModel as any)\n        .aggregate([\n          { $match: { status: 'cleared' } },\n          {\n            $lookup: {\n              from: settlementCollection,\n              localField: '_id',\n              foreignField: 'refundId',\n              as: 'settlement',\n            },\n          },\n          { $unwind: { path: '$settlement', preserveNullAndEmptyArrays: true } },\n          { $match: settlementMatch },\n          { $sort: { createdAt: -1, _id: -1 } },\n          { $project: { _id: 1 } },\n          {\n            $facet: {\n              results: [{ $skip: skip }, { $limit: limit }],\n              totalCount: [{ $count: 'count' }],\n            },\n          },\n        ])\n        .exec();\n\n      const ids = (agg?.[0]?.results || []).map((r: any) => r?._id).filter(Boolean);\n      const total = Number(agg?.[0]?.totalCount?.[0]?.count || 0);\n      const totalPages = Math.ceil(total / limit);\n\n      if (ids.length === 0) {\n        return { refunds: [], page, limit, total, totalPages };\n      }\n\n      const refunds: any[] = await this.refundModel\n        .find({ _id: { $in: ids } })\n        .populate(populateRegistration)\n        .lean()\n        .exec();\n\n      const refundById = new Map(refunds.map((r) => [String(r._id), r]));\n      const ordered = ids.map((id: any) => refundById.get(String(id))).filter(Boolean);\n      const withSettlement = await attachSettlement(ordered);\n\n      return { refunds: withSettlement, page, limit, total, totalPages };\n    }\n\n    const filter: any = {};\n    if (group === 'pending') filter.status = 'pending';\n    if (group === 'rejected') filter.status = 'rejected';\n    // group === 'all' => no filter\n\n    const [total, refunds] = await Promise.all([\n      this.refundModel.countDocuments(filter).exec(),\n      this.refundModel\n        .find(filter)\n        .sort({ createdAt: -1, _id: -1 })\n        .skip(skip)\n        .limit(limit)\n        .populate(populateRegistration)\n        .lean()\n        .exec(),\n    ]);\n    const totalPages = Math.ceil(total / limit);\n    const withSettlement = await attachSettlement(refunds as any[]);\n\n    return { refunds: withSettlement, page, limit, total, totalPages };\n  }\n\n  async getPayment(id: string): Promise<Payment> {\n    const payment = await this.paymentModel\n      .findById(id)\n      .populate({\n        path: 'registration',\n        populate: [{ path: 'user' }, { path: 'flagship' }],\n      })\n      .populate('bankAccount')\n      .exec();\n\n    if (payment) {\n      const screenshotUrl = await this.storageService.getSignedUrl(\n        payment._id.toString(),\n      );\n      payment.screenshot = screenshotUrl;\n    }\n\n    return payment;\n  }\n\n  async createBankAccount(\n    createBankAccountDto: CreateBankAccountDto,\n  ): Promise<BankAccount> {\n    const bankAccount = new this.bankAccountModel(createBankAccountDto);\n    return bankAccount.save();\n  }\n\n  async requestRefund(requestRefundDto: RequestRefundDto, requester: User): Promise<Refund> {\n    if (!requester?._id) {\n      throw new BadRequestException({\n        message: 'Authentication required.',\n        code: 'refund_auth_required',\n      });\n    }\n\n    const registration = await this.registrationModel\n      .findById(requestRefundDto.registration)\n      .exec();\n    if (!registration) {\n      throw new BadRequestException({\n        message: 'Registration not found.',\n        code: 'refund_registration_not_found',\n      });\n    }\n\n    const registrationId = (registration as any)._id;\n    const registrationUserId = (registration as any).userId || (registration as any).user;\n    if (!registrationUserId || String(registrationUserId) !== String(requester._id)) {\n      throw new ForbiddenException('You can only request a refund for your own registration.');\n    }\n\n    // Split flow: seat cancellation (confirmed) then refund request.\n    // For backward compatibility, we still allow confirmed seats here,\n    // but we don't mutate the registration status until all eligibility checks pass.\n    const currentStatus = String((registration as any)?.status || '');\n    if (currentStatus !== 'cancelled' && currentStatus !== 'confirmed') {\n      throw new BadRequestException({\n        message: 'Please cancel your seat first before requesting a refund.',\n        code: 'refund_requires_cancellation',\n      });\n    }\n\n    // Compute amountPaid = sum(approved payments) + walletPaid (if any).\n    const agg = await this.paymentModel\n      .aggregate([\n        {\n          $match: {\n            registration: new mongoose.Types.ObjectId(registrationId),\n            status: 'approved',\n          },\n        },\n        { $group: { _id: null, amountPaid: { $sum: '$amount' } } },\n      ])\n      .exec();\n    const paidFromPayments = Math.max(0, Math.floor(Number(agg?.[0]?.amountPaid) || 0));\n    const walletPaid =\n      typeof (registration as any)?.walletPaid === 'number'\n        ? (registration as any).walletPaid\n        : 0;\n    const amountPaid = paidFromPayments + Math.max(0, Math.floor(Number(walletPaid) || 0));\n\n    if (amountPaid <= 0) {\n      throw new BadRequestException({\n        message: 'Refunds can only be requested after your payment is approved.',\n        code: 'refund_payment_not_approved',\n      });\n    }\n\n    const flagshipId = (registration as any).flagship || (registration as any).flagshipId;\n    const flagship: any = await this.flagshipModel\n      .findById(flagshipId)\n      .select('startDate tripName')\n      .lean()\n      .exec();\n    if (!flagship?.startDate) {\n      throw new BadRequestException({\n        message: 'Flagship not found for registration.',\n        code: 'refund_flagship_not_found',\n      });\n    }\n\n    const quote = computeRefundQuote({\n      flagshipStartDate: new Date(flagship.startDate),\n      submittedAt: new Date(),\n      amountPaid,\n    });\n\n    const existing = await this.refundModel.exists({\n      registration: registrationId,\n      status: { $in: ['pending', 'cleared'] },\n    });\n    if (existing) {\n      throw new BadRequestException({\n        message: 'A refund request already exists for this registration.',\n        code: 'refund_already_requested',\n      });\n    }\n\n    const lastRejected: any = await this.refundModel\n      .findOne({\n        registration: registrationId,\n        status: 'rejected',\n      })\n      .sort({ updatedAt: -1, createdAt: -1 })\n      .lean()\n      .exec();\n\n    if (lastRejected?.updatedAt) {\n      const lastRejectedAt = new Date(lastRejected.updatedAt);\n      const retryAt = new Date(lastRejectedAt.getTime() + 24 * 60 * 60 * 1000);\n      if (Date.now() < retryAt.getTime()) {\n        throw new BadRequestException({\n          message: 'Refund request was recently rejected. Please wait 24 hours before reapplying.',\n          code: 'refund_cooldown',\n          retryAt: retryAt.toISOString(),\n        });\n      }\n    }\n\n    const previousRegistration: any = await this.registrationModel.findOneAndUpdate(\n      {\n        _id: registrationId,\n        userId: registrationUserId,\n        status: { $in: ['cancelled', 'confirmed'] },\n      },\n      { $set: { status: 'refundProcessing' } },\n      { new: false },\n    );\n    if (!previousRegistration) {\n      throw new BadRequestException({\n        message: 'Refund could not be requested. Please retry.',\n        code: 'refund_state_changed',\n      });\n    }\n\n    const previousStatus = String(previousRegistration?.status || 'cancelled');\n    let savedRefund: Refund;\n    try {\n      const refund = new this.refundModel({\n        ...requestRefundDto,\n        amountPaid: quote.amountPaid,\n        refundPercent: quote.refundPercent,\n        processingFee: quote.processingFee,\n        refundAmount: quote.refundAmount,\n        tierLabel: quote.tierLabel,\n        policyLink: quote.policyLink,\n        policyAppliedAt: quote.policyAppliedAt,\n      });\n      savedRefund = await refund.save();\n    } catch (error) {\n      try {\n        await this.registrationModel.findOneAndUpdate(\n          {\n            _id: registrationId,\n            userId: registrationUserId,\n            status: 'refundProcessing',\n          },\n          { $set: { status: previousStatus } },\n        );\n      } catch (rollbackError) {\n        console.log('Failed to rollback registration status after refund save failure:', rollbackError);\n      }\n      throw error;\n    }\n\n    // Notify requester about the quoted refund amount + policy link.\n    try {\n      const registrationIdString =\n        (registration as any)._id?.toString?.() || requestRefundDto.registration;\n      const refundUrl =\n        process.env.FRONTEND_URL && registrationIdString\n          ? `${process.env.FRONTEND_URL}/musafir/refund/${registrationIdString}`\n          : undefined;\n\n      await this.notificationService.createForUser(String(requester._id), {\n        title: 'Refund request received',\n        message: `Estimated refund: Rs.${quote.refundAmount.toLocaleString()} (includes PKR ${quote.processingFee}).`,\n        type: 'refund',\n        link: registrationIdString ? `/musafir/refund/${registrationIdString}` : '/passport',\n        metadata: {\n          refundId: savedRefund._id?.toString(),\n          registrationId: registrationIdString,\n          refundAmount: quote.refundAmount,\n          amountPaid: quote.amountPaid,\n          refundPercent: quote.refundPercent,\n          policyLink: quote.policyLink,\n        },\n      });\n\n      if ((requester as any)?.email) {\n        await this.mailService.sendMail(\n          (requester as any).email,\n          'Your 3Musafir refund request has been received',\n          './refund-requested',\n          {\n            fullName: (requester as any).fullName || 'Musafir',\n            tripName: flagship?.tripName || 'your trip',\n            refundAmount: quote.refundAmount,\n            amountPaid: quote.amountPaid,\n            refundPercent: quote.refundPercent,\n            processingFee: quote.processingFee,\n            refundPolicyLink: quote.policyLink,\n            refundUrl,\n          },\n        );\n      }\n    } catch (e) {\n      console.log('Failed to send refund requested comms:', e);\n    }\n\n    return savedRefund;\n  }\n\n  async getRefundQuote(registrationId: string, requester: User) {\n    if (!requester?._id) {\n      throw new BadRequestException({\n        message: 'Authentication required.',\n        code: 'refund_auth_required',\n      });\n    }\n\n    const registration: any = await this.registrationModel\n      .findById(registrationId)\n      .lean()\n      .exec();\n    if (!registration) {\n      throw new BadRequestException({\n        message: 'Registration not found.',\n        code: 'refund_registration_not_found',\n      });\n    }\n\n    const registrationUserId = registration.userId || registration.user;\n    if (!registrationUserId || String(registrationUserId) !== String(requester._id)) {\n      throw new ForbiddenException('You can only view a refund quote for your own registration.');\n    }\n\n    const flagshipId = registration.flagship || registration.flagshipId;\n    const flagship: any = await this.flagshipModel\n      .findById(flagshipId)\n      .select('startDate')\n      .lean()\n      .exec();\n    if (!flagship?.startDate) {\n      throw new BadRequestException({\n        message: 'Flagship not found for registration.',\n        code: 'refund_flagship_not_found',\n      });\n    }\n\n    const agg = await this.paymentModel\n      .aggregate([\n        {\n          $match: {\n            registration: new mongoose.Types.ObjectId(registration._id),\n            status: 'approved',\n          },\n        },\n        { $group: { _id: null, amountPaid: { $sum: '$amount' } } },\n      ])\n      .exec();\n    const paidFromPayments = Math.max(0, Math.floor(Number(agg?.[0]?.amountPaid) || 0));\n    const walletPaid = typeof registration.walletPaid === 'number' ? registration.walletPaid : 0;\n    const amountPaid = paidFromPayments + Math.max(0, Math.floor(Number(walletPaid) || 0));\n\n    return computeRefundQuote({\n      flagshipStartDate: new Date(flagship.startDate),\n      submittedAt: new Date(),\n      amountPaid,\n    });\n  }\n\n  async calculateUserDiscount(userId: string): Promise<number> {\n    try {\n      // Get all completed registrations for the user\n      const completedRegistrations = await this.registrationModel.find({\n        userId: userId,\n        status: 'completed',\n      }).exec();\n\n      // Calculate discount: 500 per completed trip\n      const discountPerTrip = 500;\n      const calculatedDiscount = completedRegistrations.length * discountPerTrip;\n\n      // Persist onto the user document as well\n      await this.user.findByIdAndUpdate(userId, {\n        numberOfFlagshipsAttended: completedRegistrations.length,\n        discountApplicable: calculatedDiscount,\n      });\n\n      return calculatedDiscount;\n    } catch (error) {\n      console.error('Error calculating user discount:', error);\n      return 0;\n    }\n  }\n\n  async getUserDiscountByRegistrationId(registrationId: string): Promise<number> {\n    try {\n      // Get the registration to find the user ID\n      const registration = await this.registrationModel.findById(registrationId)\n        .populate('user')\n        .exec();\n\n      if (!registration) {\n        throw new Error('Registration not found');\n      }\n\n      // Calculate discount for the user\n      const userId = (registration.user as any)._id || registration.userId;\n      return await this.calculateUserDiscount(userId);\n    } catch (error) {\n      console.error('Error getting user discount by registration ID:', error);\n      return 0;\n    }\n  }\n\n  async createPayment(\n    createPaymentDto: CreatePaymentDto,\n    screenshot: Express.Multer.File | undefined,\n    requester?: User,\n  ): Promise<any> {\n    // Get registration to find user ID\n    const registration = await this.registrationModel.findById(createPaymentDto.registration);\n    if (!registration) {\n      throw new Error('Registration not found');\n    }\n\n    const registrationUserId = (registration as any).userId || (registration as any).user;\n\n    const existingPending = await this.paymentModel.exists({\n      registration: createPaymentDto.registration,\n      status: 'pendingApproval',\n    });\n    if (existingPending) {\n      throw new BadRequestException({\n        message: 'A payment for this registration is already pending approval.',\n        code: 'payment_pending_approval',\n      });\n    }\n\n    if (requester && registrationUserId && registrationUserId.toString() !== requester._id?.toString()) {\n      throw new ForbiddenException('You can only pay for your own registration.');\n    }\n\n    if (registrationUserId) {\n      const registrationUser = await this.user.findById(registrationUserId);\n      if (!registrationUser) {\n        throw new BadRequestException('User for registration not found.');\n      }\n      this.assertUserVerifiedForPayment(registrationUser);\n    }\n\n    const originalStatus = String((registration as any)?.status || '');\n    const originalIsPaid =\n      typeof (registration as any)?.isPaid === 'boolean'\n        ? (registration as any).isPaid\n        : false;\n\n    const originalAmountDue =\n      typeof (registration as any)?.amountDue === 'number'\n        ? (registration as any).amountDue\n        : typeof (registration as any)?.price === 'number'\n          ? (registration as any).price\n          : 0;\n    const originalWalletPaid =\n      typeof (registration as any)?.walletPaid === 'number'\n        ? (registration as any).walletPaid\n        : 0;\n    const originalDiscountApplied =\n      typeof (registration as any)?.discountApplied === 'number'\n        ? (registration as any).discountApplied\n        : 0;\n\n    let currentAmountDue =\n      typeof (registration as any)?.amountDue === 'number'\n        ? (registration as any).amountDue\n        : typeof (registration as any)?.price === 'number'\n          ? (registration as any).price\n          : 0;\n    let currentWalletPaid =\n      typeof (registration as any)?.walletPaid === 'number'\n        ? (registration as any).walletPaid\n        : 0;\n    let currentDiscountApplied =\n      typeof (registration as any)?.discountApplied === 'number'\n        ? (registration as any).discountApplied\n        : 0;\n\n    const requestedWalletAmount = Math.max(\n      0,\n      Math.floor(Number((createPaymentDto as any)?.walletAmount) || 0),\n    );\n    const requestedDiscount = Math.max(\n      0,\n      Math.floor(Number((createPaymentDto as any)?.discount) || 0),\n    );\n    const discountDelta = Math.max(0, requestedDiscount - currentDiscountApplied);\n    const dueAfterDiscount = Math.max(0, currentAmountDue - discountDelta);\n    const walletToApply = Math.min(requestedWalletAmount, dueAfterDiscount);\n\n    const manualAmount = Math.max(0, Math.floor(Number(createPaymentDto.amount) || 0));\n\n    if (walletToApply <= 0 && manualAmount <= 0) {\n      throw new BadRequestException({\n        message: currentAmountDue <= 0\n          ? 'No payment is due for this registration.'\n          : 'Please specify a payment amount or wallet credits to apply.',\n        code: currentAmountDue <= 0 ? 'no_payment_due' : 'payment_amount_required',\n      });\n    }\n\n    if (manualAmount > 0 && !screenshot) {\n      throw new BadRequestException({\n        message: 'Payment screenshot is required for manual payments.',\n        code: 'payment_screenshot_required',\n      });\n    }\n\n    const requesterId = requester?._id?.toString();\n    const walletUseId = (createPaymentDto as any)?.walletUseId;\n    let walletSourceId: string | null = null;\n    let walletDebited = false;\n\n    if (walletToApply > 0) {\n      if (!requesterId) {\n        throw new BadRequestException({\n          message: 'Authentication required.',\n          code: 'wallet_auth_required',\n        });\n      }\n      if (!walletUseId) {\n        throw new BadRequestException({\n          message: 'walletUseId is required when applying wallet credits.',\n          code: 'wallet_use_id_required',\n        });\n      }\n\n      walletSourceId = `${createPaymentDto.registration}:${walletUseId}`;\n\n      try {\n        const walletTx: any = await this.walletService.debit({\n          userId: requesterId,\n          amount: walletToApply,\n          type: 'flagship_payment_wallet_debit',\n          sourceId: walletSourceId,\n          sourceType: 'flagship_payment',\n          metadata: {\n            sourceId: walletSourceId,\n            registrationId: createPaymentDto.registration,\n            walletApplied: walletToApply,\n          },\n        });\n        walletDebited = !isWalletTxIdempotent(walletTx);\n\n        if (walletDebited) {\n          const amountDueAfterWallet = Math.max(\n            0,\n            currentAmountDue - discountDelta - walletToApply,\n          );\n          const updated = await this.registrationModel.findByIdAndUpdate(\n            createPaymentDto.registration,\n            {\n              amountDue: amountDueAfterWallet,\n              walletPaid: Math.max(0, originalWalletPaid + walletToApply),\n              discountApplied: Math.max(0, originalDiscountApplied + discountDelta),\n              ...(amountDueAfterWallet === 0\n                ? { status: 'confirmed', isPaid: true }\n                : {}),\n            },\n            { new: true },\n          );\n\n          if (!updated) {\n            throw new BadRequestException({\n              message: 'Failed to apply wallet credits. Please retry.',\n              code: 'wallet_apply_failed',\n            });\n          }\n\n          currentAmountDue = amountDueAfterWallet;\n          currentWalletPaid = Math.max(0, originalWalletPaid + walletToApply);\n          currentDiscountApplied = Math.max(0, originalDiscountApplied + discountDelta);\n        }\n      } catch (err: any) {\n        if (walletDebited && walletSourceId) {\n          try {\n            await this.walletService.voidBySource({\n              type: 'flagship_payment_wallet_debit',\n              sourceId: walletSourceId,\n              voidedBy: requesterId,\n              note: 'Rolled back wallet debit due to payment failure',\n            });\n          } catch (e) {\n            console.log('Failed to rollback wallet debit:', e);\n          }\n\n          try {\n            await this.registrationModel.findByIdAndUpdate(createPaymentDto.registration, {\n              amountDue: originalAmountDue,\n              walletPaid: originalWalletPaid,\n              discountApplied: originalDiscountApplied,\n              status: originalStatus,\n              isPaid: originalIsPaid,\n            });\n          } catch (e) {\n            console.log('Failed to rollback registration after wallet debit:', e);\n          }\n        }\n        throw err;\n      }\n    }\n\n    const remainingDueForManualPayment =\n      walletToApply > 0\n        ? currentAmountDue\n        : Math.max(0, currentAmountDue - discountDelta);\n\n    if (manualAmount > remainingDueForManualPayment) {\n      throw new BadRequestException({\n        message: 'Payment amount exceeds remaining due.',\n        code: 'payment_amount_exceeds_due',\n      });\n    }\n\n    if (currentAmountDue <= 0 && manualAmount <= 0) {\n      return {\n        statusCode: 200,\n        message: 'Wallet payment applied.',\n        data: {\n          registrationId: createPaymentDto.registration,\n          walletApplied: walletToApply,\n          amountDue: currentAmountDue,\n        },\n      };\n    }\n\n    if (manualAmount <= 0) {\n      if (walletToApply > 0) {\n        return {\n          statusCode: 200,\n          message: 'Wallet payment applied.',\n          data: {\n            registrationId: createPaymentDto.registration,\n            walletApplied: walletToApply,\n            amountDue: currentAmountDue,\n          },\n        };\n      }\n      throw new BadRequestException({\n        message: 'Payment amount is required.',\n        code: 'payment_amount_required',\n      });\n    }\n\n    // Use the discount provided in the DTO (0 if no discount applied)\n    const discount = createPaymentDto.discount || 0;\n\n    // Create payment with discount\n    const paymentData = {\n      ...createPaymentDto,\n      discount: discount\n    };\n\n    let savedPayment: any = null;\n    try {\n      const payment = new this.paymentModel(paymentData);\n      savedPayment = await payment.save();\n\n      if (savedPayment && savedPayment._id) {\n        const screenshotUrl = await this.storageService.uploadFile(\n          savedPayment._id.toString(),\n          screenshot.buffer,\n          screenshot.mimetype,\n        );\n        savedPayment.screenshot = screenshotUrl;\n        await savedPayment.save();\n\n        // Update registration with payment ID if registration exists\n        if (createPaymentDto.registration) {\n          const registration = await this.registrationModel.findById(\n            createPaymentDto.registration,\n          );\n          if (registration) {\n            await this.registrationModel.findByIdAndUpdate(\n              createPaymentDto.registration,\n              {\n                paymentId: savedPayment._id,\n                isPaid: true,\n              },\n            );\n          }\n        }\n      }\n\n      return savedPayment;\n    } catch (err) {\n      if (savedPayment?._id) {\n        try {\n          await this.paymentModel.deleteOne({ _id: savedPayment._id });\n        } catch (e) {\n          console.log('Failed to delete payment after error:', e);\n        }\n      }\n\n      if (walletDebited && walletSourceId) {\n        try {\n          await this.walletService.voidBySource({\n            type: 'flagship_payment_wallet_debit',\n            sourceId: walletSourceId,\n            voidedBy: requesterId,\n            note: 'Rolled back wallet debit due to manual payment failure',\n          });\n        } catch (e) {\n          console.log('Failed to rollback wallet debit after payment error:', e);\n        }\n\n        try {\n          await this.registrationModel.findByIdAndUpdate(createPaymentDto.registration, {\n            amountDue: originalAmountDue,\n            walletPaid: originalWalletPaid,\n            discountApplied: originalDiscountApplied,\n            status: originalStatus,\n            isPaid: originalIsPaid,\n          });\n        } catch (e) {\n          console.log('Failed to rollback registration after payment error:', e);\n        }\n      }\n\n      throw err;\n    }\n  }\n\n  async approvePayment(id: string): Promise<Payment> {\n    const payment = await this.paymentModel.findById(id);\n    if (!payment) {\n      throw new BadRequestException('Payment not found');\n    }\n\n    let registration: any = null;\n    let remainingDue: number | null = null;\n    if (payment.registration) {\n      registration = await this.registrationModel.findById(payment.registration);\n      const registrationUserId = registration?.userId || registration?.user;\n      if (registrationUserId) {\n        const registrationUser = await this.user.findById(registrationUserId);\n        if (registrationUser) {\n          this.assertUserVerifiedForPayment(registrationUser);\n        }\n      }\n    }\n\n    payment.status = 'approved';\n    await payment.save();\n\n    if (registration) {\n      const currentAmountDue =\n        typeof registration.amountDue === 'number'\n          ? registration.amountDue\n          : typeof registration.price === 'number'\n            ? registration.price\n            : 0;\n      const currentDiscountApplied =\n        typeof registration.discountApplied === 'number'\n          ? registration.discountApplied\n          : 0;\n      const paymentDiscount =\n        typeof (payment as any)?.discount === 'number'\n          ? (payment as any).discount\n          : 0;\n      const targetDiscount = Math.max(0, paymentDiscount);\n      const discountDelta = Math.max(0, targetDiscount - currentDiscountApplied);\n\n      const updatedDiscountApplied = currentDiscountApplied + discountDelta;\n      const newAmountDue = Math.max(\n        0,\n        currentAmountDue - payment.amount - discountDelta,\n      );\n      remainingDue = newAmountDue;\n\n      await this.registrationModel.findByIdAndUpdate(payment.registration, {\n        isPaid: true,\n        amountDue: newAmountDue,\n        discountApplied: updatedDiscountApplied,\n        status: 'confirmed',\n        payment: payment._id,\n        paymentId: payment._id,\n      });\n    }\n\n    // Send payment approved email if user has an email\n    try {\n      // Get populated payment data for email\n      const populatedPayment = await this.paymentModel\n        .findById(id)\n        .populate({\n          path: 'registration',\n          populate: [{ path: 'user' }, { path: 'flagship' }],\n        })\n        .exec();\n\n      if (populatedPayment && populatedPayment.registration) {\n        const reg = populatedPayment.registration as any;\n        const user = reg.user;\n        const flagship = reg.flagship;\n        const registrationId = reg?._id?.toString();\n        const paymentUrl =\n          process.env.FRONTEND_URL && registrationId\n            ? `${process.env.FRONTEND_URL}/musafir/payment/${registrationId}`\n            : undefined;\n\n        if (user && user.email && flagship) {\n          await this.mailService.sendPaymentApprovedEmail(\n            user.email,\n            user.fullName || 'Musafir',\n            payment.amount,\n            flagship.tripName,\n            payment.createdAt,\n            {\n              remainingDue: typeof remainingDue === 'number' ? remainingDue : undefined,\n              paymentUrl,\n            },\n          );\n          // Also send an in-app notification\n          await this.notificationService.createForUser(String(user._id), {\n            title: 'Payment approved',\n            message:\n              typeof remainingDue === 'number' && remainingDue > 0\n                ? `Your payment for ${flagship.tripName} was approved. Remaining due: Rs.${remainingDue.toLocaleString()}.`\n                : `Your payment for ${flagship.tripName} was approved. Your seat is confirmed.`,\n            type: 'payment',\n            link:\n              typeof remainingDue === 'number' && remainingDue > 0 && registrationId\n                ? `/musafir/payment/${registrationId}`\n                : '/passport',\n            metadata: {\n              paymentId: payment._id?.toString(),\n              registrationId: reg._id?.toString(),\n              flagshipId: flagship._id?.toString(),\n              amount: payment.amount,\n              remainingDue: typeof remainingDue === 'number' ? remainingDue : undefined,\n            },\n          });\n        }\n      }\n    } catch (error) {\n      console.log('Failed to send payment approved email:', error);\n      // Don't throw error - email failure shouldn't prevent payment approval\n    }\n\n    return payment;\n  }\n\n  async rejectPayment(id: string): Promise<Payment> {\n    const payment = await this.paymentModel.findByIdAndUpdate(\n      id,\n      { status: 'rejected' },\n      { new: true },\n    );\n\n    if (payment && payment.registration) {\n      await this.registrationModel.findByIdAndUpdate(payment.registration, {\n        isPaid: false,\n        paymentId: null,\n      });\n\n      // Send payment rejected email if user has an email\n      try {\n        // Get populated payment data for email\n        const populatedPayment = await this.paymentModel\n          .findById(id)\n          .populate({\n            path: 'registration',\n            populate: [{ path: 'user' }, { path: 'flagship' }],\n          })\n          .exec();\n\n        if (populatedPayment && populatedPayment.registration) {\n          const reg = populatedPayment.registration as any;\n          const user = reg.user;\n          const flagship = reg.flagship;\n\n          if (user && user.email && flagship) {\n            await this.mailService.sendPaymentRejectedEmail(\n              user.email,\n              user.fullName || 'Musafir',\n              payment.amount,\n              flagship.tripName\n              // Note: We could add a reason parameter to the rejectPayment method if needed, unclear right now \n            );\n\n            // Also send an in-app notification.\n            await this.notificationService.createForUser(String(user._id), {\n              title: 'Payment rejected',\n              message: `Your payment for ${flagship.tripName} was rejected. Please resubmit your payment to confirm your seat.`,\n              type: 'payment',\n              link: reg?._id ? `/musafir/payment/${String(reg._id)}` : '/passport',\n              metadata: {\n                paymentId: payment._id?.toString(),\n                registrationId: reg?._id?.toString(),\n                flagshipId: flagship?._id?.toString(),\n                amount: payment.amount,\n              },\n            });\n          }\n        }\n      } catch (error) {\n        console.log('Failed to send payment rejected email:', error);\n        // Don't throw error - email failure shouldn't prevent payment rejection\n      }\n    }\n\n    return payment;\n  }\n\n  async getPendingPayments(): Promise<Payment[]> {\n    return this.paymentModel\n      .find({ status: 'pendingApproval' })\n      .populate({\n        path: 'registration',\n        populate: [{ path: 'user' }, { path: 'flagship' }],\n      })\n      .populate('bankAccount')\n      .exec();\n  }\n\n  async getCompletedPayments(): Promise<Payment[]> {\n    return this.paymentModel\n      .find({ status: 'approved' })\n      .populate({\n        path: 'registration',\n        populate: [{ path: 'user' }, { path: 'flagship' }],\n      })\n      .populate('bankAccount')\n      .exec();\n  }\n\n  async approveRefund(\n    id: string,\n    options?: { credit?: boolean; admin?: User },\n  ): Promise<Refund> {\n    const credit = options?.credit !== false;\n    const adminId = options?.admin?._id?.toString();\n\n    const refundDoc: any = await this.refundModel.findById(id).exec();\n    if (!refundDoc) {\n      throw new BadRequestException('Refund not found');\n    }\n\n    const registration: any = refundDoc?.registration\n      ? await this.registrationModel.findById(refundDoc.registration).lean().exec()\n      : null;\n    const registrationUserId = registration?.userId || registration?.user;\n\n    const flagshipId = registration?.flagship || registration?.flagshipId;\n    const flagship: any = flagshipId\n      ? await this.flagshipModel.findById(flagshipId).select('startDate tripName').lean().exec()\n      : null;\n\n    // Ensure refund quote snapshot exists (for older refunds).\n    let refundAmount =\n      typeof refundDoc?.refundAmount === 'number'\n        ? refundDoc.refundAmount\n        : undefined;\n    if (typeof refundAmount !== 'number') {\n      const agg = registration?._id\n        ? await this.paymentModel\n          .aggregate([\n            {\n              $match: {\n                registration: new mongoose.Types.ObjectId(registration._id),\n                status: 'approved',\n              },\n            },\n            { $group: { _id: null, amountPaid: { $sum: '$amount' } } },\n          ])\n          .exec()\n        : [];\n      const paidFromPayments = Math.max(0, Math.floor(Number(agg?.[0]?.amountPaid) || 0));\n      const walletPaid = typeof registration?.walletPaid === 'number' ? registration.walletPaid : 0;\n      const amountPaid = paidFromPayments + Math.max(0, Math.floor(Number(walletPaid) || 0));\n\n      const quote = flagship?.startDate\n        ? computeRefundQuote({\n          flagshipStartDate: new Date(flagship.startDate),\n          submittedAt: refundDoc?.policyAppliedAt || refundDoc?.createdAt || new Date(),\n          amountPaid,\n        })\n        : null;\n\n      if (quote) {\n        refundDoc.amountPaid = quote.amountPaid;\n        refundDoc.refundPercent = quote.refundPercent;\n        refundDoc.processingFee = quote.processingFee;\n        refundDoc.refundAmount = quote.refundAmount;\n        refundDoc.tierLabel = quote.tierLabel;\n        refundDoc.policyLink = quote.policyLink;\n        refundDoc.policyAppliedAt = quote.policyAppliedAt;\n        refundAmount = quote.refundAmount;\n      } else {\n        refundAmount = 0;\n      }\n    }\n\n    refundDoc.status = 'cleared';\n    const savedRefund: any = await refundDoc.save();\n\n    if (registration?._id) {\n      await this.registrationModel.findByIdAndUpdate(registration._id, {\n        status: 'refunded',\n        amountDue: 0,\n        isPaid: false,\n      });\n      await this.updateUserTripStats(String(registrationUserId));\n    }\n\n    const userId = registrationUserId ? String(registrationUserId) : undefined;\n    if (userId) {\n      if (credit) {\n        await this.refundSettlementService.ensureSettlement({\n          refundId: id,\n          userId,\n          amount: refundAmount || 0,\n          status: 'pending',\n          metadata: { mode: 'approve_and_credit' },\n        });\n\n        if ((refundAmount || 0) > 0) {\n          await this.refundSettlementService.postToWallet({\n            refundId: id,\n            userId,\n            amount: refundAmount || 0,\n            postedBy: adminId,\n          });\n        }\n\n        await this.refundSettlementService.ensureSettlement({\n          refundId: id,\n          userId,\n          amount: refundAmount || 0,\n          status: 'posted',\n          postedBy: adminId,\n          postedAt: new Date(),\n          metadata: { mode: 'approve_and_credit' },\n        });\n      } else {\n        await this.refundSettlementService.ensureSettlement({\n          refundId: id,\n          userId,\n          amount: refundAmount || 0,\n          status: 'pending',\n          postedBy: adminId,\n          metadata: { mode: 'approve_defer_credit' },\n        });\n      }\n\n      try {\n        const tripName = flagship?.tripName || 'your trip';\n\n        await this.notificationService.createForUser(userId, {\n          title: 'Refund approved',\n          message: credit\n            ? `Your refund for ${tripName} was approved and credited to your wallet (Rs.${Number(\n              refundAmount || 0,\n            ).toLocaleString()}).`\n            : `Your refund for ${tripName} was approved. Wallet credit is pending.`,\n          type: 'refund',\n          link: credit ? '/wallet' : '/passport',\n          metadata: {\n            refundId: savedRefund._id?.toString(),\n            registrationId: registration?._id?.toString(),\n            amount: refundAmount || 0,\n            credited: credit,\n          },\n        });\n\n        const userDoc: any = await this.user\n          .findById(userId)\n          .select('email fullName')\n          .lean()\n          .exec();\n\n        if (userDoc?.email) {\n          if (credit) {\n            await this.mailService.sendMail(\n              userDoc.email,\n              'Your 3Musafir refund has been credited',\n              './refund-credited',\n              {\n                fullName: userDoc.fullName || 'Musafir',\n                tripName,\n                amount: Number(refundAmount || 0),\n              },\n            );\n          } else {\n            await this.mailService.sendMail(\n              userDoc.email,\n              'Your 3Musafir refund is approved (wallet credit pending)',\n              './refund-approved-pending-credit',\n              {\n                fullName: userDoc.fullName || 'Musafir',\n                tripName,\n                amount: Number(refundAmount || 0),\n              },\n            );\n          }\n        }\n      } catch (error) {\n        console.log('Failed to send refund approved comms:', error);\n      }\n    }\n\n    return savedRefund;\n  }\n\n  async postRefundCredit(refundId: string, admin: User) {\n    const adminId = admin?._id?.toString();\n    if (!adminId) {\n      throw new BadRequestException({\n        message: 'Authentication required.',\n        code: 'refund_admin_auth_required',\n      });\n    }\n\n    const refundDoc: any = await this.refundModel.findById(refundId).exec();\n    if (!refundDoc) {\n      throw new BadRequestException('Refund not found');\n    }\n    if (refundDoc.status !== 'cleared') {\n      throw new BadRequestException({\n        message: 'Refund must be approved before posting credit.',\n        code: 'refund_not_approved',\n      });\n    }\n\n    const registration: any = refundDoc?.registration\n      ? await this.registrationModel.findById(refundDoc.registration).lean().exec()\n      : null;\n    const userId = (registration?.userId || registration?.user)?.toString?.();\n    if (!userId) {\n      throw new BadRequestException({\n        message: 'Refund registration/user not found.',\n        code: 'refund_registration_not_found',\n      });\n    }\n\n    const amount = Math.max(0, Math.floor(Number(refundDoc.refundAmount) || 0));\n    await this.refundSettlementService.postToWallet({\n      refundId: refundId,\n      userId,\n      amount,\n      postedBy: adminId,\n    });\n\n    await this.refundSettlementService.ensureSettlement({\n      refundId: refundId,\n      userId,\n      amount,\n      status: 'posted',\n      postedBy: adminId,\n      postedAt: new Date(),\n      metadata: { mode: 'post_credit' },\n    });\n\n    try {\n      const flagshipId = registration?.flagship || registration?.flagshipId;\n      const flagship: any = flagshipId\n        ? await this.flagshipModel.findById(flagshipId).select('tripName').lean().exec()\n        : null;\n      const tripName = flagship?.tripName || 'your trip';\n\n      await this.notificationService.createForUser(userId, {\n        title: 'Refund credited',\n        message: `Rs.${amount.toLocaleString()} has been credited to your wallet.`,\n        type: 'refund',\n        link: '/wallet',\n        metadata: { refundId: refundId, amount },\n      });\n\n      const userDoc: any = await this.user\n        .findById(userId)\n        .select('email fullName')\n        .lean()\n        .exec();\n      if (userDoc?.email && amount > 0) {\n        await this.mailService.sendMail(\n          userDoc.email,\n          'Your 3Musafir refund has been credited',\n          './refund-credited',\n          {\n            fullName: userDoc.fullName || 'Musafir',\n            tripName,\n            amount,\n          },\n        );\n      }\n    } catch (error) {\n      console.log('Failed to send refund credited notification:', error);\n    }\n\n    return { status: 'posted', refundId, amount };\n  }\n\n  async rejectRefund(id: string, admin?: User): Promise<Refund> {\n    const refund = await this.refundModel.findByIdAndUpdate(\n      id,\n      { status: 'rejected' },\n      { new: true },\n    );\n\n    if (refund?.registration) {\n      const registration = await this.registrationModel\n        .findById(refund.registration)\n        .exec();\n\n      // If refund was rejected, keep seat cancelled (do not restore confirmed seat).\n      if (registration?.status === 'refundProcessing') {\n        await this.registrationModel.findByIdAndUpdate(registration._id, {\n          status: 'cancelled',\n        });\n      }\n\n      if ((registration as any)?.userId) {\n        await this.updateUserTripStats(String((registration as any).userId));\n\n        const retryAt = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();\n        try {\n          await this.notificationService.createForUser(String((registration as any).userId), {\n            title: 'Refund rejected',\n            message:\n              'Your refund request was rejected. You can reapply after 24 hours.',\n            type: 'refund',\n            link: '/passport',\n            metadata: {\n              refundId: refund._id?.toString(),\n              registrationId: registration._id?.toString(),\n              retryAt,\n              rejectedBy: admin?._id?.toString(),\n            },\n          });\n        } catch (error) {\n          console.log('Failed to send refund rejected notification:', error);\n        }\n      }\n    }\n\n    return refund;\n  }\n}\n"],"version":3}