{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/auth/auth.service.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/auth/auth.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  Injectable,\n  UnauthorizedException\n} from '@nestjs/common';\nimport { InjectModel } from '@nestjs/mongoose';\nimport Cryptr from 'cryptr';\nimport { Request } from 'express';\nimport { sign, verify } from 'jsonwebtoken';\nimport { Model } from 'mongoose';\nimport { getClientIp } from 'request-ip';\nimport { errorResponse, successResponse } from '../constants/response';\nimport { User } from '../user/interfaces/user.interface';\nimport { v4 } from 'uuid';\nimport { JwtPayload } from './interfaces/jwt-payload.interface';\nimport { RefreshToken } from './interfaces/refresh-token.interface';\n\n@Injectable()\nexport class AuthService {\n  cryptr: any;\n\n  constructor(\n    @InjectModel('User') private readonly userModel: Model<User>,\n    @InjectModel('RefreshToken')\n    private readonly refreshTokenModel: Model<RefreshToken>,\n  ) {\n    this.cryptr = new Cryptr(process.env.ENCRYPT_JWT_SECRET);\n  }\n\n  async createAccessToken(userId: string) {\n    const accessToken = sign({ userId }, process.env.JWT_SECRET, {\n      expiresIn: process.env.JWT_EXPIRATION,\n    });\n    return this.encryptText(accessToken);\n  }\n\n  async createRefreshToken(req: Request, userId) {\n    const refreshToken = new this.refreshTokenModel({\n      userId,\n      refreshToken: v4(),\n      ip: this.getIp(req),\n    });\n    await refreshToken.save();\n    return refreshToken.refreshToken;\n  }\n\n  async findRefreshToken(token: string) {\n    const refreshToken = await this.refreshTokenModel.findOne({\n      refreshToken: token,\n    });\n    if (!refreshToken) {\n      throw new UnauthorizedException('User has been logged out.');\n    }\n    return refreshToken.userId;\n  }\n\n  async validateUser(jwtPayload: JwtPayload): Promise<any> {\n    const user = await this.userModel.findOne({\n      _id: jwtPayload.userId,\n    });\n    if (!user) {\n      throw new UnauthorizedException('User not found.');\n    }\n    return user; \n  }\n\n  public async varifyToken(token: string) {\n    const secretKey: string = process.env.JWT_SECRET;\n    \n    try {\n      const verificationResponse: JwtPayload = verify(\n        token,\n        secretKey,\n      ) as JwtPayload;\n\n      const userId = verificationResponse.userId;\n      const findUser = await this.userModel.findById(userId);\n      if (!findUser) return errorResponse({statusCode: 401, message: `User not found`});\n      return successResponse(findUser,'User Found');\n    } catch (e) {\n      return errorResponse({statusCode: 401, message: e.message });\n    }\n  }\n\n  // JWT Extractor\n\n  private jwtExtractor(request) {\n    let token = null;\n    if (request.header('x-token')) {\n      token = request.get('x-token');\n    } else if (request.headers.authorization) {\n      token = request.headers.authorization\n        .replace('Bearer ', '')\n        .replace(' ', '');\n    } else if (request.body.token) {\n      token = request.body.token.replace(' ', '');\n    }\n    if (request.query.token) {\n      token = request.body.token.replace(' ', '');\n    }\n    \n    const cryptr = new Cryptr(process.env.ENCRYPT_JWT_SECRET);\n    if (token) {\n      try {\n        const decrypted = cryptr.decrypt(token);\n        token = decrypted;\n      } catch (err) {\n        throw new BadRequestException('Bad request.');\n      }\n    }\n    return token;\n  }\n\n  returnJwtExtractor() {\n    return this.jwtExtractor;\n  }\n\n  getIp(req: Request): string {\n    return getClientIp(req);\n  }\n\n  encryptText(text: string): string {\n    return this.cryptr.encrypt(text);\n  }\n\n\n\n}\n"],"version":3}