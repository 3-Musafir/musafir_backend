9e87ff09ec3241b59edee529ca4b8a11
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const payment_service_1 = require("./payment.service");
function makeLeanExecQuery(value) {
    return {
        select: () => ({
            lean: () => ({
                exec: () => __awaiter(this, void 0, void 0, function* () { return value; }),
            }),
        }),
        lean: () => ({
            exec: () => __awaiter(this, void 0, void 0, function* () { return value; }),
        }),
        exec: () => __awaiter(this, void 0, void 0, function* () { return value; }),
    };
}
describe('PaymentService.getRefundQuote', () => {
    it('includes walletPaid in amountPaid aggregation', () => __awaiter(void 0, void 0, void 0, function* () {
        const paymentModel = {
            aggregate: jest.fn(() => ({
                exec: () => __awaiter(void 0, void 0, void 0, function* () { return [{ amountPaid: 700 }]; }),
            })),
        };
        const userModel = {};
        const bankAccountModel = {};
        const flagshipModel = {
            findById: jest.fn(() => makeLeanExecQuery({ startDate: new Date('2026-02-15T00:00:00+05:00') })),
        };
        const registrationModel = {
            findById: jest.fn(() => makeLeanExecQuery({
                _id: '507f1f77bcf86cd799439011',
                userId: 'user1',
                flagshipId: 'flag1',
                walletPaid: 300,
            })),
        };
        const refundModel = {};
        const storageService = {};
        const mailService = {};
        const notificationService = {};
        const walletService = {};
        const refundSettlementService = {};
        const service = new payment_service_1.PaymentService(paymentModel, userModel, bankAccountModel, flagshipModel, registrationModel, refundModel, storageService, mailService, notificationService, walletService, refundSettlementService);
        const quote = yield service.getRefundQuote('reg1', { _id: 'user1' });
        expect(quote.amountPaid).toBe(1000);
    }));
    it('rejects when requester is not the registration owner', () => __awaiter(void 0, void 0, void 0, function* () {
        const paymentModel = { aggregate: jest.fn(() => ({ exec: () => __awaiter(void 0, void 0, void 0, function* () { return []; }) })) };
        const userModel = {};
        const bankAccountModel = {};
        const flagshipModel = { findById: jest.fn(() => makeLeanExecQuery({ startDate: new Date() })) };
        const registrationModel = {
            findById: jest.fn(() => makeLeanExecQuery({ _id: 'reg1', userId: 'user_owner', flagshipId: 'flag1', walletPaid: 0 })),
        };
        const refundModel = {};
        const storageService = {};
        const mailService = {};
        const notificationService = {};
        const walletService = {};
        const refundSettlementService = {};
        const service = new payment_service_1.PaymentService(paymentModel, userModel, bankAccountModel, flagshipModel, registrationModel, refundModel, storageService, mailService, notificationService, walletService, refundSettlementService);
        yield expect(service.getRefundQuote('reg1', { _id: 'other_user' })).rejects.toBeInstanceOf(common_1.ForbiddenException);
    }));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2RldnByb2ZpbGUvRG9jdW1lbnRzL0dpdEh1Yi9tdXNhZmlyX2JhY2tlbmQvc3JjL3BheW1lbnQvcGF5bWVudC5zZXJ2aWNlLmdldFJlZnVuZFF1b3RlLnNwZWMudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBb0Q7QUFDcEQsdURBQW1EO0FBRW5ELFNBQVMsaUJBQWlCLENBQUksS0FBUTtJQUNwQyxPQUFPO1FBQ0wsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDYixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDWCxJQUFJLEVBQUUsR0FBUyxFQUFFLGdEQUFDLE9BQUEsS0FBSyxDQUFBLEdBQUE7YUFDeEIsQ0FBQztTQUNILENBQUM7UUFDRixJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNYLElBQUksRUFBRSxHQUFTLEVBQUUsZ0RBQUMsT0FBQSxLQUFLLENBQUEsR0FBQTtTQUN4QixDQUFDO1FBQ0YsSUFBSSxFQUFFLEdBQVMsRUFBRSxnREFBQyxPQUFBLEtBQUssQ0FBQSxHQUFBO0tBQ3hCLENBQUM7QUFDSixDQUFDO0FBRUQsUUFBUSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtJQUM3QyxFQUFFLENBQUMsK0NBQStDLEVBQUUsR0FBUyxFQUFFO1FBQzdELE1BQU0sWUFBWSxHQUFRO1lBQ3hCLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBQ3hCLElBQUksRUFBRSxHQUFTLEVBQUUsa0RBQUMsT0FBQSxDQUFDLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUEsR0FBQTthQUN4QyxDQUFDLENBQUM7U0FDSixDQUFDO1FBQ0YsTUFBTSxTQUFTLEdBQVEsRUFBRSxDQUFDO1FBQzFCLE1BQU0sZ0JBQWdCLEdBQVEsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sYUFBYSxHQUFRO1lBQ3pCLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFB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QUMsTUFBTSxFQUFFLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBUyxDQUFDLENBQzdELENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQywyQkFBa0IsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQSxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvZGV2cHJvZmlsZS9Eb2N1bWVudHMvR2l0SHViL211c2FmaXJfYmFja2VuZC9zcmMvcGF5bWVudC9wYXltZW50LnNlcnZpY2UuZ2V0UmVmdW5kUXVvdGUuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGb3JiaWRkZW5FeGNlcHRpb24gfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7XG5pbXBvcnQgeyBQYXltZW50U2VydmljZSB9IGZyb20gJy4vcGF5bWVudC5zZXJ2aWNlJztcblxuZnVuY3Rpb24gbWFrZUxlYW5FeGVjUXVlcnk8VD4odmFsdWU6IFQpIHtcbiAgcmV0dXJuIHtcbiAgICBzZWxlY3Q6ICgpID0+ICh7XG4gICAgICBsZWFuOiAoKSA9PiAoe1xuICAgICAgICBleGVjOiBhc3luYyAoKSA9PiB2YWx1ZSxcbiAgICAgIH0pLFxuICAgIH0pLFxuICAgIGxlYW46ICgpID0+ICh7XG4gICAgICBleGVjOiBhc3luYyAoKSA9PiB2YWx1ZSxcbiAgICB9KSxcbiAgICBleGVjOiBhc3luYyAoKSA9PiB2YWx1ZSxcbiAgfTtcbn1cblxuZGVzY3JpYmUoJ1BheW1lbnRTZXJ2aWNlLmdldFJlZnVuZFF1b3RlJywgKCkgPT4ge1xuICBpdCgnaW5jbHVkZXMgd2FsbGV0UGFpZCBpbiBhbW91bnRQYWlkIGFnZ3JlZ2F0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHBheW1lbnRNb2RlbDogYW55ID0ge1xuICAgICAgYWdncmVnYXRlOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGV4ZWM6IGFzeW5jICgpID0+IFt7IGFtb3VudFBhaWQ6IDcwMCB9XSxcbiAgICAgIH0pKSxcbiAgICB9O1xuICAgIGNvbnN0IHVzZXJNb2RlbDogYW55ID0ge307XG4gICAgY29uc3QgYmFua0FjY291bnRNb2RlbDogYW55ID0ge307XG4gICAgY29uc3QgZmxhZ3NoaXBNb2RlbDogYW55ID0ge1xuICAgICAgZmluZEJ5SWQ6IGplc3QuZm4oKCkgPT5cbiAgICAgICAgbWFrZUxlYW5FeGVjUXVlcnkoeyBzdGFydERhdGU6IG5ldyBEYXRlKCcyMDI2LTAyLTE1VDAwOjAwOjAwKzA1OjAwJykgfSksXG4gICAgICApLFxuICAgIH07XG4gICAgY29uc3QgcmVnaXN0cmF0aW9uTW9kZWw6IGFueSA9IHtcbiAgICAgIGZpbmRCeUlkOiBqZXN0LmZuKCgpID0+XG4gICAgICAgIG1ha2VMZWFuRXhlY1F1ZXJ5KHtcbiAgICAgICAgICBfaWQ6ICc1MDdmMWY3N2JjZjg2Y2Q3OTk0MzkwMTEnLFxuICAgICAgICAgIHVzZXJJZDogJ3VzZXIxJyxcbiAgICAgICAgICBmbGFnc2hpcElkOiAnZmxhZzEnLFxuICAgICAgICAgIHdhbGxldFBhaWQ6IDMwMCxcbiAgICAgICAgfSksXG4gICAgICApLFxuICAgIH07XG4gICAgY29uc3QgcmVmdW5kTW9kZWw6IGFueSA9IHt9O1xuICAgIGNvbnN0IHN0b3JhZ2VTZXJ2aWNlOiBhbnkgPSB7fTtcbiAgICBjb25zdCBtYWlsU2VydmljZTogYW55ID0ge307XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZTogYW55ID0ge307XG4gICAgY29uc3Qgd2FsbGV0U2VydmljZTogYW55ID0ge307XG4gICAgY29uc3QgcmVmdW5kU2V0dGxlbWVudFNlcnZpY2U6IGFueSA9IHt9O1xuXG4gICAgY29uc3Qgc2VydmljZSA9IG5ldyBQYXltZW50U2VydmljZShcbiAgICAgIHBheW1lbnRNb2RlbCxcbiAgICAgIHVzZXJNb2RlbCxcbiAgICAgIGJhbmtBY2NvdW50TW9kZWwsXG4gICAgICBmbGFnc2hpcE1vZGVsLFxuICAgICAgcmVnaXN0cmF0aW9uTW9kZWwsXG4gICAgICByZWZ1bmRNb2RlbCxcbiAgICAgIHN0b3JhZ2VTZXJ2aWNlLFxuICAgICAgbWFpbFNlcnZpY2UsXG4gICAgICBub3RpZmljYXRpb25TZXJ2aWNlLFxuICAgICAgd2FsbGV0U2VydmljZSxcbiAgICAgIHJlZnVuZFNldHRsZW1lbnRTZXJ2aWNlLFxuICAgICk7XG5cbiAgICBjb25zdCBxdW90ZTogYW55ID0gYXdhaXQgc2VydmljZS5nZXRSZWZ1bmRRdW90ZSgncmVnMScsIHsgX2lkOiAndXNlcjEnIH0gYXMgYW55KTtcbiAgICBleHBlY3QocXVvdGUuYW1vdW50UGFpZCkudG9CZSgxMDAwKTtcbiAgfSk7XG5cbiAgaXQoJ3JlamVjdHMgd2hlbiByZXF1ZXN0ZXIgaXMgbm90IHRoZSByZWdpc3RyYXRpb24gb3duZXInLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcGF5bWVudE1vZGVsOiBhbnkgPSB7IGFnZ3JlZ2F0ZTogamVzdC5mbigoKSA9PiAoeyBleGVjOiBhc3luYyAoKSA9PiBbXSB9KSkgfTtcbiAgICBjb25zdCB1c2VyTW9kZWw6IGFueSA9IHt9O1xuICAgIGNvbnN0IGJhbmtBY2NvdW50TW9kZWw6IGFueSA9IHt9O1xuICAgIGNvbnN0IGZsYWdzaGlwTW9kZWw6IGFueSA9IHsgZmluZEJ5SWQ6IGplc3QuZm4oKCkgPT4gbWFrZUxlYW5FeGVjUXVlcnkoeyBzdGFydERhdGU6IG5ldyBEYXRlKCkgfSkpIH07XG4gICAgY29uc3QgcmVnaXN0cmF0aW9uTW9kZWw6IGFueSA9IHtcbiAgICAgIGZpbmRCeUlkOiBqZXN0LmZuKCgpID0+XG4gICAgICAgIG1ha2VMZWFuRXhlY1F1ZXJ5KHsgX2lkOiAncmVnMScsIHVzZXJJZDogJ3VzZXJfb3duZXInLCBmbGFnc2hpcElkOiAnZmxhZzEnLCB3YWxsZXRQYWlkOiAwIH0pLFxuICAgICAgKSxcbiAgICB9O1xuICAgIGNvbnN0IHJlZnVuZE1vZGVsOiBhbnkgPSB7fTtcbiAgICBjb25zdCBzdG9yYWdlU2VydmljZTogYW55ID0ge307XG4gICAgY29uc3QgbWFpbFNlcnZpY2U6IGFueSA9IHt9O1xuICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2U6IGFueSA9IHt9O1xuICAgIGNvbnN0IHdhbGxldFNlcnZpY2U6IGFueSA9IHt9O1xuICAgIGNvbnN0IHJlZnVuZFNldHRsZW1lbnRTZXJ2aWNlOiBhbnkgPSB7fTtcblxuICAgIGNvbnN0IHNlcnZpY2UgPSBuZXcgUGF5bWVudFNlcnZpY2UoXG4gICAgICBwYXltZW50TW9kZWwsXG4gICAgICB1c2VyTW9kZWwsXG4gICAgICBiYW5rQWNjb3VudE1vZGVsLFxuICAgICAgZmxhZ3NoaXBNb2RlbCxcbiAgICAgIHJlZ2lzdHJhdGlvbk1vZGVsLFxuICAgICAgcmVmdW5kTW9kZWwsXG4gICAgICBzdG9yYWdlU2VydmljZSxcbiAgICAgIG1haWxTZXJ2aWNlLFxuICAgICAgbm90aWZpY2F0aW9uU2VydmljZSxcbiAgICAgIHdhbGxldFNlcnZpY2UsXG4gICAgICByZWZ1bmRTZXR0bGVtZW50U2VydmljZSxcbiAgICApO1xuXG4gICAgYXdhaXQgZXhwZWN0KFxuICAgICAgc2VydmljZS5nZXRSZWZ1bmRRdW90ZSgncmVnMScsIHsgX2lkOiAnb3RoZXJfdXNlcicgfSBhcyBhbnkpLFxuICAgICkucmVqZWN0cy50b0JlSW5zdGFuY2VPZihGb3JiaWRkZW5FeGNlcHRpb24pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9