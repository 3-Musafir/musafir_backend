{"file":"/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.getRefundQuote.spec.ts","mappings":"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","names":[],"sources":["/Users/devprofile/Documents/GitHub/musafir_backend/src/payment/payment.service.getRefundQuote.spec.ts"],"sourcesContent":["import { ForbiddenException } from '@nestjs/common';\nimport { PaymentService } from './payment.service';\n\nfunction makeLeanExecQuery<T>(value: T) {\n  return {\n    select: () => ({\n      lean: () => ({\n        exec: async () => value,\n      }),\n    }),\n    lean: () => ({\n      exec: async () => value,\n    }),\n    exec: async () => value,\n  };\n}\n\ndescribe('PaymentService.getRefundQuote', () => {\n  it('includes walletPaid in amountPaid aggregation', async () => {\n    const paymentModel: any = {\n      aggregate: jest.fn(() => ({\n        exec: async () => [{ amountPaid: 700 }],\n      })),\n    };\n    const userModel: any = {};\n    const bankAccountModel: any = {};\n    const flagshipModel: any = {\n      findById: jest.fn(() =>\n        makeLeanExecQuery({ startDate: new Date('2026-02-15T00:00:00+05:00') }),\n      ),\n    };\n    const registrationModel: any = {\n      findById: jest.fn(() =>\n        makeLeanExecQuery({\n          _id: '507f1f77bcf86cd799439011',\n          userId: 'user1',\n          flagshipId: 'flag1',\n          walletPaid: 300,\n        }),\n      ),\n    };\n    const refundModel: any = {};\n    const storageService: any = {};\n    const mailService: any = {};\n    const notificationService: any = {};\n    const walletService: any = {};\n    const refundSettlementService: any = {};\n\n    const service = new PaymentService(\n      paymentModel,\n      userModel,\n      bankAccountModel,\n      flagshipModel,\n      registrationModel,\n      refundModel,\n      storageService,\n      mailService,\n      notificationService,\n      walletService,\n      refundSettlementService,\n    );\n\n    const quote: any = await service.getRefundQuote('reg1', { _id: 'user1' } as any);\n    expect(quote.amountPaid).toBe(1000);\n  });\n\n  it('rejects when requester is not the registration owner', async () => {\n    const paymentModel: any = { aggregate: jest.fn(() => ({ exec: async () => [] })) };\n    const userModel: any = {};\n    const bankAccountModel: any = {};\n    const flagshipModel: any = { findById: jest.fn(() => makeLeanExecQuery({ startDate: new Date() })) };\n    const registrationModel: any = {\n      findById: jest.fn(() =>\n        makeLeanExecQuery({ _id: 'reg1', userId: 'user_owner', flagshipId: 'flag1', walletPaid: 0 }),\n      ),\n    };\n    const refundModel: any = {};\n    const storageService: any = {};\n    const mailService: any = {};\n    const notificationService: any = {};\n    const walletService: any = {};\n    const refundSettlementService: any = {};\n\n    const service = new PaymentService(\n      paymentModel,\n      userModel,\n      bankAccountModel,\n      flagshipModel,\n      registrationModel,\n      refundModel,\n      storageService,\n      mailService,\n      notificationService,\n      walletService,\n      refundSettlementService,\n    );\n\n    await expect(\n      service.getRefundQuote('reg1', { _id: 'other_user' } as any),\n    ).rejects.toBeInstanceOf(ForbiddenException);\n  });\n});\n"],"version":3}